<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GH SCHOOLS - Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Export libraries: SheetJS for Excel, jsPDF + autotable for PDF, docx for Word -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #dc3545;
      --primary-dark: #c82333;
      --secondary: #ffffff;
      --secondary-dark: #f0f0f0;
      --accent: #bb2d3b;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #ffffff;
      --dark: #2c3e50;
      --gray: #7f8c8d;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      color: var(--dark);
      min-height: 100vh;
      display: flex;
    }

    /* Notifications */
    .notification-item.unread { background: linear-gradient(90deg, rgba(244,250,255,1), rgba(235,248,255,1)); }
    .notification-actions { display:flex; gap:6px; margin-top:8px; justify-content:flex-end; }

    /* Passport photo frame */
    .passport-frame {
      width: 160px;
      height: 190px;
      padding: 8px;
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
      border: 4px solid #f0f0f0;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      border-radius: 10px;
      display: inline-block;
      overflow: hidden;
    }
    .passport-frame img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; display:block; }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, var(--dark) 0%, #1a2530 100%);
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      transition: var(--transition);
      z-index: 1000;
    }

    .logo-container {
      padding: 0 20px 30px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .logo {
      width: 60px;
      height: 60px;
      background: var(--primary);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 24px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 600;
    }

    .nav-menu {
      padding: 20px 0;
    }

    .nav-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: var(--transition);
      border-left: 4px solid transparent;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(255,255,255,0.1);
      border-left-color: var(--primary);
    }

    .nav-item i {
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 250px;
      padding: 20px;
      transition: var(--transition);
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0 30px;
      border-bottom: 1px solid #e1e5ee;
    }

    .header-left h1 {
      font-size: 24px;
      color: var(--dark);
    }

    .header-left p {
      color: var(--gray);
      font-size: 14px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    /* Realtime status badge */
    .realtime-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      font-size: 13px;
      color: var(--dark);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .realtime-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e74c3c; /* disconnected red */
      box-shadow: 0 0 6px rgba(0,0,0,0.08);
    }

    .realtime-connected .realtime-dot { background: #2ecc71; }
    .realtime-disconnected .realtime-dot { background: #e74c3c; }

    .search-box {
      position: relative;
    }

    .search-box input {
      padding: 10px 15px 10px 40px;
      border: 1px solid #e1e5ee;
      border-radius: 8px;
      width: 300px;
      font-size: 14px;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: var(--transition);
    }

    .user-profile:hover {
      background: var(--light);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: var(--transition);
      border-left: 5px solid;
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card.total { border-left-color: var(--primary); }
    .stat-card.pending { border-left-color: var(--warning); }
    .stat-card.approved { border-left-color: var(--success); }
    .stat-card.rejected { border-left-color: var(--danger); }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .stat-card.total .stat-icon { background: var(--primary); }
    .stat-card.pending .stat-icon { background: var(--warning); }
    .stat-card.approved .stat-icon { background: var(--success); }
    .stat-card.rejected .stat-icon { background: var(--danger); }

    .stat-info h3 {
      font-size: 30px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-info p {
      color: var(--gray);
      font-size: 14px;
    }

    /* Charts Section */
    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 30px 0;
    }

    .chart-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-header h3 {
      font-size: 18px;
      color: var(--dark);
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    /* Applicants Table */
    .table-container {
      background: white;
      border-radius: 15px;
      box-shadow: var(--shadow);
      padding: 25px;
      margin: 30px 0;
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .table-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 15px;
      background: var(--light);
      color: var(--dark);
      font-weight: 600;
      border-bottom: 1px solid #e1e5ee;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #e1e5ee;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .view-btn { background: #e3f2fd; color: var(--primary); }
    .edit-btn { background: #fff8e1; color: var(--warning); }
    .delete-btn { background: #ffebee; color: var(--danger); }

    .action-btn:hover {
      transform: scale(1.1);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 0;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      animation: modalSlideIn 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .modal-large {
      max-width: 1400px;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e1e5ee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: white;
      border-radius: 0;
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .modal-body {
      padding: 20px;
      /* allow modal body to grow and scroll when modal is fullscreen */
      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background: transparent;
    }

    /* When a modal is active, make its content occupy the full viewport */
    .modal.active .modal-content {
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      border-radius: 0;
      margin: 0;
      padding: 0;
    }

    /* Schools modal: allow horizontal scrolling for stats */
    #schoolsModal .modal-body .stats-container {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding-bottom: 12px;
      -webkit-overflow-scrolling: touch;
    }

    #schoolsModal .modal-body .stat-card {
      min-width: 260px;
      flex: 0 0 auto;
    }

    /* Ensure modal info grids are responsive and wrap if space is constrained */
    .modal-body .info-grid {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: flex-start;
      padding-bottom: 12px;
    }

    .modal-body .info-grid .info-item {
      min-width: 220px;
      flex: 1 1 220px;
    }

    /* Ensure tables inside modals can scroll horizontally and keep their intrinsic width */
    .modal-body .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal-body table {
      width: max-content;
      min-width: 100%;
      border-collapse: collapse;
    }

    /* Improved applicant modal layout: full-viewport flex container with internal scrolling
       and wrapping info-grid so admins can see all fields on smaller viewports. */
    #applicantModal .modal-content {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-height: 100vh;
    }

    #applicantModal .modal-header {
      flex: 0 0 auto;
    }

    #applicantModal .modal-body {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
      padding: 20px;
    }

    /* Make the info grid wrap so fields stack responsively instead of being clipped */
    #applicantModal .modal-body .info-grid {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: flex-start;
      padding-bottom: 12px;
    }

    #applicantModal .modal-body .info-grid .info-item {
      min-width: 220px;
      flex: 1 1 220px;
    }

    /* Scroll arrows removed — controls disabled */

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .info-item {
      margin-bottom: 15px;
    }

    .info-label {
      font-size: 12px;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 16px;
      font-weight: 500;
      color: var(--dark);
    }

    /* Edit input styling inside modals */
    .edit-input {
      padding: 8px 10px;
      border: 1px solid #e1e5ee;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: var(--dark);
    }

    /* School color badge */
    .school-badge {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    /* Filters */
    .filters {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-item {
      flex: 1;
      min-width: 200px;
    }

    .filter-item label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: var(--dark);
    }

    .filter-item select,
    .filter-item input {
      width: 100%;
      padding: 10px;
      border: 1px solid #e1e5ee;
      border-radius: 8px;
      font-size: 14px;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      .modal-content {
        max-width: 95%;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
      }
      
      .sidebar .logo-text,
      .sidebar .nav-text {
        display: none;
      }
      
      .main-content {
        margin-left: 70px;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .header-right .search-box {
        display: none;
      }
    }

    @media (max-width: 576px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .table-actions {
        flex-direction: column;
      }
      
      .quick-actions {
        flex-direction: column;
      }
    }

    /* Animations */
    @keyframes modalSlideIn {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Export Section */
    .export-section {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin: 30px 0;
    }

    .export-options {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .page-btn {
      padding: 8px 12px;
      border: 1px solid #e1e5ee;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
    }

    .page-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .page-btn:hover:not(.active) {
      background: var(--light);
    }

    /* Quick Stats */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .quick-stat {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-stat:hover {
      transform: translateY(-3px);
    }

    .quick-stat h4 {
      font-size: 24px;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .quick-stat p {
      font-size: 12px;
      color: var(--gray);
      text-transform: uppercase;
    }

    /* Modal Tabs */
    .modal-tabs {
      display: flex;
      border-bottom: 1px solid #e1e5ee;
      margin-bottom: 20px;
    }

    .modal-tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
    }

    .modal-tab.active {
      border-bottom-color: var(--primary);
      color: var(--primary);
      font-weight: 600;
    }

    .modal-tab:hover:not(.active) {
      background: var(--light);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    .stat-item h4 {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 10px;
    }

    .stat-item .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--dark);
    }

    /* Progress Bar */
    .progress-bar {
      height: 8px;
      background: #e1e5ee;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.5s ease;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo-container">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <div class="logo-text">GH SCHOOLS Admin</div>
    </div>

    <div class="nav-menu">
      <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
        <i class="fas fa-tachometer-alt"></i>
        <span class="nav-text">Dashboard</span>
      </div>
      <div class="nav-item" data-page="applicants" onclick="showModal('applicantsModal')">
        <i class="fas fa-users"></i>
        <span class="nav-text">Applicants</span>
      </div>
      <div class="nav-item" data-page="analytics" onclick="showModal('analyticsModal')">
        <i class="fas fa-chart-bar"></i>
        <span class="nav-text">Analytics</span>
      </div>
      <div class="nav-item" data-page="schools" onclick="showModal('schoolsModal')">
        <i class="fas fa-university"></i>
        <span class="nav-text">Schools</span>
      </div>
      <div class="nav-item" data-page="reports" onclick="showModal('reportsModal')">
        <i class="fas fa-file-alt"></i>
        <span class="nav-text">Reports</span>
      </div>
      <div class="nav-item" data-page="notifications" onclick="showModal('notificationsModal')">
        <i class="fas fa-bell"></i>
        <span class="nav-text">Notifications</span>
      </div>
      <!-- Settings and Help removed -->
      <div class="nav-item" data-page="payments" onclick="showModal('studentPaymentsModal')">
        <i class="fas fa-money-bill-wave"></i>
        <span class="nav-text">Accounts</span>
      </div>
      <div class="nav-item" data-page="students" onclick="showModal('allStudentsModal')">
        <i class="fas fa-user-graduate"></i>
        <span class="nav-text">Students</span>
      </div>
      <div class="nav-item" data-page="registrations" onclick="showModal('registrationsModal')">
        <i class="fas fa-book"></i>
        <span class="nav-text">Registrations</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1 id="pageTitle">Dashboard Overview</h1>
        <p id="pageSubtitle">Welcome back, Admin! Here's what's happening today.</p>
      </div>
      <div class="header-right">
        <div class="search-box">
          <i id="globalSearchBtn" class="fas fa-search" title="Search" style="cursor:pointer;"></i>
          <input type="text" id="globalSearch" placeholder="Search applicants...">
        </div>
          <!-- Realtime connection status -->
          <div id="realtimeStatus" class="realtime-badge realtime-disconnected" title="Realtime connection status">
            <span class="realtime-dot"></span>
            <span id="realtimeStatusText">Disconnected</span>
          </div>
        <div class="user-profile">
          <div class="user-avatar">A</div>
          <div>
            <div style="font-weight: 600;">Administrator</div>
            <div style="font-size: 12px; color: var(--gray);">Super Admin</div>
          </div>
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page active">
      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="btn btn-primary" onclick="showModal('applicantsModal')">
          <i class="fas fa-users"></i> Manage Applicants
        </button>
        <button class="btn btn-success" onclick="showModal('reportsModal')">
          <i class="fas fa-file-download"></i> Generate Reports
        </button>
        <button class="btn btn-outline" onclick="showModal('analyticsModal')">
          <i class="fas fa-chart-bar"></i> View Analytics
        </button>
        <button class="btn btn-outline" onclick="showModal('schoolsModal')">
          <i class="fas fa-university"></i> School Stats
        </button>
      </div>

      <!-- Stats Cards -->
      <div class="stats-container">
        <div class="stat-card total" onclick="showModal('applicantsModal')">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <h3 id="totalApplicants">0</h3>
            <p>Total Applicants</p>
          </div>
        </div>
        <div class="stat-card approved" onclick="showModal('applicantsModal')">
          <div class="stat-icon">
            <i class="fas fa-credit-card"></i>
          </div>
          <div class="stat-info">
            <h3 id="paidApplicants">0</h3>
            <p>Forms Purchased</p>
          </div>
        </div>
        <!-- Approved/Rejected stat cards removed to avoid admin approval UI -->
      </div>

      <!-- Quick Stats -->
      <div class="quick-stats">
        <div class="quick-stat" onclick="filterByDate('today')">
          <h4 id="todayApplicants">0</h4>
          <p>Today's Applications</p>
        </div>
        <div class="quick-stat" onclick="filterByDate('week')">
          <h4 id="weekApplicants">0</h4>
          <p>This Week</p>
        </div>
        <div class="quick-stat" onclick="filterByCourse('Diploma')">
          <h4 id="diplomaCount">0</h4>
          <p>Diploma Programs</p>
        </div>
        <div class="quick-stat" onclick="filterByCourse('ICC')">
          <h4 id="iccCount">0</h4>
          <p>ICC Programs</p>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-container">
        <div class="chart-card">
          <div class="chart-header">
            <h3>Applications Timeline</h3>
            <button class="btn btn-outline btn-sm" onclick="showModal('analyticsModal')">
              View Details
            </button>
          </div>
          <div class="chart-container">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3>School Distribution</h3>
            <button class="btn btn-outline btn-sm" onclick="showModal('schoolsModal')">
              View Details
            </button>
          </div>
          <div class="chart-container">
            <canvas id="schoolChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Applicants With Paid Forms -->
      <div class="table-container">
        <div class="table-header">
          <h3>Applicants With Paid Forms</h3>
          <div style="display: flex; gap: 8px;">
            <button id="showAllPaidBtn" class="btn btn-primary" onclick="showPaidApplicantsUI()">
              <i class="fas fa-list"></i> Show All
            </button>
            <button id="showLessPaidBtn" class="btn btn-primary" onclick="showLessPaidApplicantsUI()" style="display: none;">
              <i class="fas fa-compress"></i> Show Less
            </button>
            <button class="btn btn-primary" onclick="refreshPaidWithoutRecords()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>

        <!-- Search Section -->
        <div id="paidSearchSection" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
          <div style="display: flex; gap: 12px; align-items: center;">
            <input 
              type="text" 
              id="paidApplicantSearch" 
              placeholder="Search by student name or student ID..." 
              style="flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              onkeyup="searchPaidApplicants()"
            >
            <button class="btn btn-secondary" onclick="clearPaidSearch()" title="Clear search">
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
        </div>

        <div class="loading" id="paidNoRecordsLoading" style="display: none;">
          <div class="spinner"></div>
        </div>
        <table id="paidNoRecordsTable" style="display: none;">
          <thead>
            <tr>
              <th>Reference Code</th>
              <th>Student Name</th>
              <th>Student ID</th>
              <th>Payment Status</th>
              <th>Payment Date</th>
              <th>Amount</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="paidNoRecordsTableBody"></tbody>
        </table>
      </div>

      <!-- Recent Applicants -->
      <div class="table-container">
        <div class="table-header">
          <h3>Recent Applications</h3>
          <div style="display: flex; gap: 8px;">
            <button id="showAllRecentBtn" class="btn btn-primary" onclick="showRecentApplicationsUI()">
              <i class="fas fa-list"></i> Show All
            </button>
            <button id="showLessRecentBtn" class="btn btn-primary" onclick="showLessRecentApplicationsUI()" style="display: none;">
              <i class="fas fa-compress"></i> Show Less
            </button>
            <button class="btn btn-primary" onclick="refreshApplicants()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>

        <!-- Search Section for Recent Applications -->
        <div id="recentSearchSection" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
          <div style="display: flex; gap: 12px; align-items: center;">
            <input 
              type="text" 
              id="recentApplicationSearch" 
              placeholder="Search by student name or email..." 
              style="flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
              onkeyup="searchRecentApplications()"
            >
            <button class="btn btn-secondary" onclick="clearRecentSearch()" title="Clear search">
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
        </div>

        <div class="loading" id="recentLoading">
          <div class="spinner"></div>
        </div>
        <table id="recentTable" style="display: none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>School</th>
              <th>Program</th>
              <th>Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="recentTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modals for Sidebar Links -->

  <!-- Applicants Modal -->
  <div class="modal" id="applicantsModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title" id="applicantsModalTitle">Applicant Management</h3>
        <button class="action-btn view-btn" onclick="closeModal('applicantsModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="quick-actions">
          <button class="btn btn-primary" onclick="refreshApplicants()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button id="clearSchoolFilterBtn" class="btn btn-outline" style="display:none; margin-left:8px;" onclick="clearSchoolFilter()">
            Clear School Filter
          </button>
          <button class="btn btn-success" onclick="exportData('csv')">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
          <button class="btn btn-success" onclick="exportData('excel')">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
          <button class="btn btn-success" onclick="exportData('pdf')">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="btn btn-success" onclick="exportData('docx')">
            <i class="fas fa-file-word"></i> Export DOCX
          </button>
          <!-- Bulk approve removed: approvals are handled automatically -->
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <div class="filter-item">
              <label>Status</label>
              <select id="filterStatus" onchange="filterApplicants()">
                <option value="">All Status</option>
              </select>
            </div>
            <div class="filter-item">
              <label>School</label>
              <select id="filterSchool" onchange="filterApplicants()">
                <option value="">All Schools</option>
                <option value="MEDIA">Media School</option>
                <option value="FASHION">Fashion School</option>
                <option value="CATERING">Catering School</option>
                <option value="COSMETOLOGY">Cosmetology School</option>
                <option value="TECHNOLOGY">Technology School</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Course Type</label>
              <select id="filterCourse" onchange="filterApplicants()">
                <option value="">All Types</option>
                <option value="Diploma">Diploma</option>
                <option value="ICC">ICC</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Date From</label>
              <input type="date" id="filterDateFrom" onchange="filterApplicants()">
            </div>
            <div class="filter-item">
              <label>Date To</label>
              <input type="date" id="filterDateTo" onchange="filterApplicants()">
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="loading" id="applicantsLoading">
            <div class="spinner"></div>
          </div>
          <table id="applicantsTable" style="display: none;">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th>Student ID</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>DOB</th>
                <th>Gender</th>
                <th>Nationality</th>
                <th>Address</th>
                <th>School</th>
                <th>Program</th>
                <th>Course Type</th>
                <th>WASSCE</th>
                <th>Sponsor</th>
                <th>Sponsor Phone</th>
                <th>Passport</th>
                <th>Results</th>
                <th>Applied On</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="applicantsTableBody"></tbody>
          </table>

          <!-- Pagination -->
          <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" onclick="changePage(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="pageInfo">Page 1 of 1</span>
            <button class="page-btn" onclick="changePage(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div class="modal" id="analyticsModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title">Analytics Dashboard</h3>
        <button class="action-btn view-btn" onclick="closeModal('analyticsModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-tabs">
          <div class="modal-tab active" onclick="switchAnalyticsTab('overview')">Overview</div>
          <div class="modal-tab" onclick="switchAnalyticsTab('trends')">Trends</div>
          <div class="modal-tab" onclick="switchAnalyticsTab('payments')">Payments</div>
          <div class="modal-tab" onclick="switchAnalyticsTab('performance')">Performance</div>
        </div>

        <div id="analyticsOverview" class="analytics-tab active">
          <div class="charts-container">
            <div class="chart-card">
              <div class="chart-header">
                <h3>Monthly Applications</h3>
                <select id="analyticsYear" onchange="updateAnalytics()">
                  <option value="2025" selected>2025</option>
                  <option value="2026">2026</option>
                </select>
              </div>
              <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-header">
                <h3>Program Popularity</h3>
              </div>
              <div class="chart-container">
                <canvas id="programChart"></canvas>
              </div>
            </div>
          </div>

          <div class="charts-container">
            <div class="chart-card">
              <div class="chart-header">
                <h3>Geographic Distribution</h3>
              </div>
              <div class="chart-container">
                <canvas id="regionChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-header">
                <h3>WASSCE Score Distribution</h3>
              </div>
              <div class="chart-container">
                <canvas id="scoreChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div id="analyticsTrends" class="analytics-tab" style="display: none;">
          <div class="chart-card">
            <div class="chart-header">
              <h3>Application Trends (Last 30 Days)</h3>
            </div>
            <div class="chart-container">
              <canvas id="trendsChart"></canvas>
            </div>
          </div>
        </div>
        
        <div id="analyticsPayments" class="analytics-tab" style="display: none;">
          <div class="charts-container">
            <div class="chart-card">
              <div class="chart-header">
                <h3>Payment Status Distribution</h3>
              </div>
              <div class="chart-container">
                <canvas id="paymentStatusChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <div class="chart-header">
                <h3>Revenue by Payment Type</h3>
              </div>
              <div class="chart-container">
                <canvas id="paymentTypeRevenueChart"></canvas>
              </div>
            </div>
          </div>

          <div class="charts-container">
            <div class="chart-card">
              <div class="chart-header">
                <h3>Payment Summary</h3>
              </div>
              <div style="display:flex; gap:12px; align-items:flex-start;">
                <div style="flex:1; padding:12px;">
                  <div style="font-size:14px; color:var(--gray);">Total Revenue</div>
                  <h2 id="totalRevenue">₵0</h2>
                  <div style="font-size:13px; color:var(--gray);">All time</div>
                </div>
                <div style="flex:1; padding:12px;">
                  <div style="font-size:14px; color:var(--gray);">Paid Accounts</div>
                  <h2 id="paidAccounts">0</h2>
                  <div style="font-size:13px; color:var(--gray);">Number of accounts with payments</div>
                </div>

                <div style="flex:1; padding:12px;">
                  <div style="font-size:14px; color:var(--gray);">Average Payment</div>
                  <h2 id="avgPayment">₵0</h2>
                  <div style="font-size:13px; color:var(--gray);">Per account</div>
                </div>
              </div>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header"><h3>Payments by School</h3></div>
            <div class="chart-container" style="padding:12px;">
              <table class="table" id="paymentsBySchoolTable" style="width:100%"><thead><tr><th>School</th><th>Total Paid</th><th>Payment Rate</th></tr></thead><tbody id="paymentsBySchoolBody"></tbody></table>
            </div>
          </div>
        </div>
        
        <div id="analyticsPerformance" class="analytics-tab" style="display: none;">
          <div class="charts-container">
            <div class="chart-card">
              <div class="chart-header">
                <h3>Performance Overview</h3>
              </div>
              <div style="display:flex; gap:12px; align-items:flex-start;">
                <div style="flex:1; padding:12px;">
                  <div style="font-size:14px; color:var(--gray);">Conversion Rate</div>
                  <h2 id="perfConversion">0%</h2>
                  <div style="font-size:13px; color:var(--gray);">% of applicants who made a payment</div>
                </div>
                <div style="flex:1; padding:12px;">
                  <div style="font-size:14px; color:var(--gray);">Avg Time to Payment</div>
                  <h2 id="perfAvgProcessing">N/A</h2>
                  <div style="font-size:13px; color:var(--gray);">Average days between application and first payment</div>
                </div>
                <div style="flex:1; padding:12px;">
                  <div style="font-size:14px; color:var(--gray);">Avg WASSCE Score</div>
                  <h2 id="perfAvgScore">N/A</h2>
                  <div style="font-size:13px; color:var(--gray);">Average core score across applicants</div>
                </div>
              </div>
            </div>
          </div>

          <div class="charts-container">
            <div class="chart-card">
              <div class="chart-header"><h3>Payments Trend (30 days)</h3></div>
              <div class="chart-container"><canvas id="paymentsTrendChart"></canvas></div>
            </div>
            <div class="chart-card">
              <div class="chart-header"><h3>Processing Time Distribution</h3></div>
              <div class="chart-container"><canvas id="processingChart"></canvas></div>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header"><h3>Top Programs (by applicants)</h3></div>
            <div class="chart-container" style="padding:12px;">
              <table class="table" id="topProgramsTable" style="width:100%"><thead><tr><th>Program</th><th>Applicants</th><th>Avg Score</th></tr></thead><tbody id="topProgramsBody"></tbody></table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Schools Modal -->
  <div class="modal" id="schoolsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">School Statistics</h3>
        <button class="action-btn view-btn" onclick="closeModal('schoolsModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="stats-container">
          <div class="stat-card" style="border-left-color: #e74c3c;" onclick="filterBySchool('MEDIA')">
            <div class="stat-icon" style="background: #e74c3c;">
              <i class="fas fa-film"></i>
            </div>
            <div class="stat-info">
              <h3 id="mediaCount">0</h3>
              <p>GH Media School</p>
            </div>
          </div>
          <div class="stat-card" style="border-left-color: #2575fc;" onclick="filterBySchool('FASHION')">
            <div class="stat-icon" style="background: #2575fc;">
              <i class="fas fa-tshirt"></i>
            </div>
            <div class="stat-info">
              <h3 id="fashionCount">0</h3>
              <p>GH Fashion School</p>
            </div>
          </div>
          <div class="stat-card" style="border-left-color: #f1c40f;" onclick="filterBySchool('CATERING')">
            <div class="stat-icon" style="background: #f1c40f; color: #2c2c2c;">
              <i class="fas fa-utensils"></i>
            </div>
            <div class="stat-info">
              <h3 id="cateringCount">0</h3>
              <p>GH Catering School</p>
            </div>
          </div>
          <div class="stat-card" style="border-left-color: #f19d01;" onclick="filterBySchool('COSMETOLOGY')">
            <div class="stat-icon" style="background: #f19d01;">
              <i class="fas fa-spa"></i>
            </div>
            <div class="stat-info">
              <h3 id="cosmetologyCount">0</h3>
              <p>GH Cosmetology School</p>
            </div>
          </div>
          <div class="stat-card" style="border-left-color: #6a11cb;" onclick="filterBySchool('TECHNOLOGY')">
            <div class="stat-icon" style="background: #6a11cb;">
              <i class="fas fa-laptop-code"></i>
            </div>
            <div class="stat-info">
              <h3 id="technologyCount">0</h3>
              <p>GH Technology School</p>
            </div>
          </div>
        </div>

        <div class="table-container">
          <h3>School-wise Applicant Details</h3>
          <div class="loading" id="schoolsLoading">
            <div class="spinner"></div>
          </div>
          <table id="schoolsTable" style="display: none;">
            <thead>
              <tr>
                <th>School</th>
                <th>Total Applicants</th>
                <th>Diploma</th>
                <th>ICC</th>
                <th>Average WASSCE Score</th>
                <th>Most Popular Program</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="schoolsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Modal -->
  <div class="modal" id="reportsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Report Generation</h3>
        <button class="action-btn view-btn" onclick="closeModal('reportsModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="export-section">
          <h3>Generate Reports</h3>
          <p>Select report type and date range to generate detailed reports.</p>
          
          <div class="filter-group" style="margin-top: 20px;">
            <div class="filter-item">
              <label>Report Type</label>
              <select id="reportType">
                <optgroup label="Applications">
                  <option value="applications_summary">Applications — Summary</option>
                  <option value="applications_detailed">Applications — Detailed</option>
                </optgroup>
                <optgroup label="Admissions">
                  <option value="admissions_overview">Admissions — Overview</option>
                  <option value="admissions_by_school">Admissions — By School</option>
                </optgroup>
                <optgroup label="Financials">
                  <option value="financial_overview">Financial — Overview</option>
                  <option value="financial_payments">Financial — Payments</option>
                  <option value="financial_by_school">Financial — By School</option>
                </optgroup>
                <optgroup label="Performance">
                  <option value="performance_wassce">Performance — WASSCE / Scores</option>
                  <option value="performance_programs">Performance — Program Distribution</option>
                </optgroup>
              </select>
            </div>
            <div class="filter-item">
              <label>From Date</label>
              <input type="date" id="reportFrom">
            </div>
            <div class="filter-item">
              <label>To Date</label>
              <input type="date" id="reportTo">
            </div>
            <div class="filter-item">
              <label>Format</label>
              <select id="reportFormat">
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
                <option value="csv">CSV</option>
              </select>
            </div>
          </div>

          <div class="export-options">
            <button class="btn btn-success" onclick="generateReport()">
              <i class="fas fa-file-download"></i> Generate Report
            </button>
            <button class="btn btn-primary" onclick="previewReport()">
              <i class="fas fa-eye"></i> Preview
            </button>
          </div>
        </div>

        <div class="table-container">
          <h3>Report History</h3>
          <table>
            <thead>
              <tr>
                <th>Report Name</th>
                <th>Generated On</th>
                <th>Type</th>
                <th>Period</th>
                <th>Size</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="reportsHistory"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings removed -->

  <!-- Notifications Modal -->
  <div class="modal" id="notificationsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Notifications</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn btn-outline" onclick="markAllNotificationsRead()">Mark All Read</button>
          <button class="btn btn-outline" onclick="deleteAllNotifications()">Delete All</button>
          <button id="notifSoundToggle" class="btn btn-outline" title="Toggle notification sound" onclick="toggleNotificationSound()">
            <i class="fas fa-bell"></i>
          </button>
          <button class="action-btn view-btn" onclick="closeModal('notificationsModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div class="stats-grid">
          <div class="stat-item">
            <h4>Unread Notifications</h4>
            <div class="value" id="unreadCount">0</div>
          </div>
          <div class="stat-item">
            <h4>Today's Notifications</h4>
            <div class="value" id="todayNotifications">0</div>
          </div>
        </div>

        <div class="table-container">
          <h3>Recent Notifications</h3>
          <div id="notificationsList">
            <div class="notification-item" style="padding: 15px; border-bottom: 1px solid #e1e5ee;">
              <div style="display: flex; justify-content: space-between;">
                <strong>New Application Submitted</strong>
                <span style="font-size: 12px; color: var(--gray);">Just now</span>
              </div>
              <p style="margin: 5px 0;">John Doe applied to GH Media School</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help removed -->

  <!-- Accounts Modal -->
  <div class="modal" id="studentPaymentsModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title">Accounts</h3>
        <button class="action-btn view-btn" onclick="closeModal('studentPaymentsModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="quick-actions">
          <input id="paymentStudentSearchInput" placeholder="Search by Student ID" style="padding:8px; margin-right:8px; width:220px;" />
          <button class="btn btn-primary" onclick="searchPaymentByStudentId()">
            <i class="fas fa-search"></i> Search
          </button>
          <button class="btn btn-outline" onclick="clearPaymentSearch()" style="margin-left:8px;">
            <i class="fas fa-times"></i> Clear
          </button>
          <button class="btn btn-primary" onclick="refreshStudentPayments()" style="margin-left:8px;">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn btn-success" onclick="exportPaymentData('csv')">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
          <button class="btn btn-success" onclick="exportPaymentData('excel')">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
          <button class="btn btn-danger" onclick="downloadPaymentPDF()">
            <i class="fas fa-file-pdf"></i> Download PDF
          </button>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <div class="filter-item">
              <label>Level</label>
              <select id="paymentLevelFilter" onchange="filterStudentPayments()">
                <option value="">All Levels</option>
                <option value="100">Level 100</option>
                <option value="200">Level 200</option>
                <option value="300">Level 300</option>
                <option value="400">Level 400</option>
              </select>
            </div>
            <div class="filter-item">
              <label>School/Department</label>
              <select id="paymentSchoolFilter" onchange="handlePaymentSchoolChange()">
                <option value="">All Schools</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Program</label>
              <select id="paymentProgramFilter" onchange="filterStudentPayments()">
                <option value="">All Programs</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Payment Type</label>
              <select id="paymentTypeFilter" onchange="filterStudentPayments()">
                <option value="">All Types</option>
                <option value="tuition_fees">Tuition Fee - GHS 2550</option>
                <option value="src_dues">SRC Dues - GHS 50</option>
                <option value="medical_dues">Medical Dues - GHS 80</option>
                <option value="departmental_dues">Departmental Dues - GHS 50</option>
                <option value="admission_fees">Admission Fees - GHS 800</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Payment Status</label>
              <select id="paymentStatusFilter" onchange="filterStudentPayments()">
                <option value="">All Status</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
                <option value="approved">Approved</option>
                <option value="success">Success</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Date From</label>
              <input type="date" id="paymentDateFrom" onchange="filterStudentPayments()">
            </div>
            <div class="filter-item">
              <label>Date To</label>
              <input type="date" id="paymentDateTo" onchange="filterStudentPayments()">
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="loading" id="studentPaymentsLoading">
            <div class="spinner"></div>
          </div>
          <table id="studentPaymentsTable" style="display: none;">
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Name</th>
                <th>Payment Type</th>
                <th>Payment Breakdown</th>
                <th>Required Amount</th>
                <th>Amount Paid</th>
                <th>Amount Owing</th>
                <th>Status</th>
                <th>Eligibility</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentPaymentsTableBody"></tbody>
          </table>

          <!-- Pagination -->
          <div class="pagination" id="paymentPagination" style="display: none;">
            <button class="page-btn" onclick="changePaymentPage(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="paymentPageInfo">Page 1 of 1</span>
            <button class="page-btn" onclick="changePaymentPage(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- All Students Modal -->
  <div class="modal" id="allStudentsModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title">All Students</h3>
        <button class="action-btn view-btn" onclick="closeModal('allStudentsModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="quick-actions">
          <input id="studentSearchInput" placeholder="Search by Student ID" style="padding:8px; margin-right:8px; width:220px;" />
          <button class="btn btn-primary" onclick="searchAccountByIdFromInput()">
            <i class="fas fa-search"></i> Search
          </button>
          <button class="btn btn-outline" onclick="clearAllStudentsResults()" style="margin-left:8px;">
            <i class="fas fa-sync-alt"></i> Clear
          </button>
          <button class="btn btn-success" onclick="exportStudentData('csv')">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
          <button class="btn btn-success" onclick="exportStudentData('excel')">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <div class="filter-item">
              <label>School</label>
              <select id="studentSchoolFilter" onchange="filterAllStudents()">
                <option value="">All Schools</option>
                <option value="MEDIA">Media School</option>
                <option value="FASHION">Fashion School</option>
                <option value="CATERING">Catering School</option>
                <option value="COSMETOLOGY">Cosmetology School</option>
                <option value="TECHNOLOGY">Technology School</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Payment Status</label>
              <select id="studentPaymentStatusFilter" onchange="filterAllStudents()">
                <option value="">All Payment Status</option>
                <option value="paid">Fully Paid</option>
                <option value="pending">No Payments</option>
                <option value="owing">Partial/Owing</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Course Type</label>
              <select id="studentCourseFilter" onchange="filterAllStudents()">
                <option value="">All Types</option>
                <option value="Diploma">Diploma</option>
                <option value="ICC">ICC</option>
              </select>
            </div>
            <div class="filter-item" style="margin-top: auto;">
              <button class="btn btn-secondary" onclick="resetAllStudentFilters()" title="Reset all filters">
                <i class="fas fa-redo"></i> Reset Filters
              </button>
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="loading" id="allStudentsLoading">
            <div class="spinner"></div>
          </div>
          <table id="allStudentsTable" style="display: none;">
            <thead>
              <tr>
                <th>Student ID</th>
                <th>First Name</th>
                <th>Middle Name</th>
                <th>Surname</th>
                <th>Email</th>
                <th>Phone 1</th>
                <th>Phone 2</th>
                <th>WhatsApp</th>
                <th>School</th>
                <th>Pathway</th>
                <th>Program</th>
                <th>Level</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="allStudentsTableBody"></tbody>
          </table>

          <!-- Pagination -->
          <div class="pagination" id="allStudentsPagination" style="display: none;">
            <button class="page-btn" onclick="changeAllStudentsPage(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="allStudentsPageInfo">Page 1 of 1</span>
            <button class="page-btn" onclick="changeAllStudentsPage(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Course Registrations Modal -->
  <div class="modal" id="registrationsModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title">Course Registrations</h3>
        <button class="action-btn view-btn" onclick="closeModal('registrationsModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="quick-actions">
          <input id="registrationSearchInput" placeholder="Search by Student ID, Name or Email" style="padding:8px; margin-right:8px; width:280px;" />
          <button class="btn btn-primary" onclick="searchRegistration()">
            <i class="fas fa-search"></i> Search
          </button>
          <button class="btn btn-outline" onclick="clearRegistrationResults()" style="margin-left:8px;">
            <i class="fas fa-sync-alt"></i> Clear
          </button>
          <button class="btn btn-success" onclick="exportRegistrationData('csv')">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
          <button class="btn btn-success" onclick="exportRegistrationData('excel')">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <div class="filter-item">
              <label>School</label>
              <select id="regSchoolFilter" onchange="filterRegistrations()">
                <option value="">All Schools</option>
                <option value="Media School">Media School</option>
                <option value="School of Fashion">School of Fashion</option>
                <option value="School of Catering">School of Catering</option>
                <option value="School of Cosmetology">School of Cosmetology</option>
                <option value="School of Technology">School of Technology</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Level</label>
              <select id="regLevelFilter" onchange="filterRegistrations()">
                <option value="">All Levels</option>
                <option value="Level 100">Level 100</option>
                <option value="Level 200">Level 200</option>
                <option value="Level 300">Level 300</option>
                <option value="Level 400">Level 400</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Course Type</label>
              <select id="regCourseTypeFilter" onchange="filterRegistrations()">
                <option value="">All Types</option>
                <option value="Diploma">Diploma</option>
                <option value="ICC">ICC</option>
              </select>
            </div>
            <div class="filter-item">
              <label>Status</label>
              <select id="regStatusFilter" onchange="filterRegistrations()">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
                <option value="approved">Approved</option>
              </select>
            </div>
            <div class="filter-item" style="margin-top: auto;">
              <button class="btn btn-secondary" onclick="resetRegistrationFilters()" title="Reset all filters">
                <i class="fas fa-redo"></i> Reset Filters
              </button>
            </div>
          </div>
        </div>

        <!-- Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
          <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Registrations</div>
            <div style="font-size: 24px; font-weight: 700; color: #2196F3;" id="totalRegistrations">0</div>
          </div>
          <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #9C27B0;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Unique Students</div>
            <div style="font-size: 24px; font-weight: 700; color: #9C27B0;" id="totalUniqueStudents">0</div>
          </div>
          <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Pending</div>
            <div style="font-size: 24px; font-weight: 700; color: #FF9800;" id="pendingCount">0</div>
          </div>
          <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Completed</div>
            <div style="font-size: 24px; font-weight: 700; color: #4CAF50;" id="completedCount">0</div>
          </div>
        </div>

        <div class="table-container">
          <div class="loading" id="registrationsLoading">
            <div class="spinner"></div>
          </div>
          <table id="registrationsTable" style="display: none;">
            <thead>
              <tr>
                <th>Reg ID</th>
                <th>Student ID</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Department</th>
                <th>Level</th>
                <th>School</th>
                <th>Course Type</th>
                <th># Courses</th>
                <th># Core</th>
                <th>Status</th>
                <th>Registered Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="registrationsTableBody"></tbody>
          </table>

          <!-- Pagination -->
          <div class="pagination" id="registrationsPagination" style="display: none;">
            <button class="page-btn" onclick="changeRegistrationsPage(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="registrationsPageInfo">Page 1 of 1</span>
            <button class="page-btn" onclick="changeRegistrationsPage(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Applicant Detail Modal -->
  <div class="modal" id="applicantModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Applicant Details</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="applicantEditBtn" class="btn btn-outline" onclick="enterEditMode()">
            <i class="fas fa-edit"></i> Edit
          </button>
          <button id="applicantSaveBtn" class="btn btn-success" style="display:none;" onclick="saveApplicantUpdates()">
            <i class="fas fa-save"></i> Update
          </button>
          <button id="applicantCancelBtn" class="btn btn-outline" style="display:none;" onclick="cancelEditMode()">
            Cancel
          </button>
          <button class="action-btn view-btn" onclick="closeModal('applicantModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div id="applicantDetailLoading" class="loading">
          <div class="spinner"></div>
        </div>
        <div id="applicantDetailContent" style="display: none;">
          <div style="display:flex; gap:18px; align-items:flex-start;">
            <div style="flex:1">
              <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Student ID</div>
              <div class="info-value" id="detailId"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Full Name</div>
              <div class="info-value" id="detailName"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Email</div>
              <div class="info-value" id="detailEmail"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Phone</div>
              <div class="info-value" id="detailPhone"></div>
            </div>
            <div class="info-item">
              <div class="info-label">School</div>
              <div class="info-value" id="detailSchool"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Program</div>
              <div class="info-value" id="detailProgram"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Department</div>
              <div class="info-value" id="detailDepartment"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Level</div>
              <div class="info-value" id="detailLevel"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Gender</div>
              <div class="info-value" id="detailGender"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Date of Birth</div>
              <div class="info-value" id="detailDOB"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Updated At</div>
              <div class="info-value" id="detailUpdatedAt"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Address</div>
              <div class="info-value" id="detailAddress"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Nationality</div>
              <div class="info-value" id="detailNationality"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Course Type</div>
              <div class="info-value" id="detailCourse"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Applied On</div>
              <div class="info-value" id="detailDate"></div>
            </div>
            <div class="info-item">
              <div class="info-label">WASSCE Score</div>
              <div class="info-value" id="detailScore"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Status</div>
              <div class="info-value" id="detailStatusDisplay"></div>
            </div>
              </div>
            </div>
            <div style="width:180px; text-align:center;">
              <div class="info-label">Passport Photo</div>
              <div id="detailPassportFrame" class="passport-frame" style="margin-top:8px; display:none;">
                <img id="detailPassport" src="" alt="Passport Photo" />
              </div>
              <div style="margin-top:10px;">
                <a id="detailWassceLink" href="#" target="_blank" style="display:none; font-size:13px;">View WASSCE Results</a>
              </div>
            </div>
          </div>

          <h4 style="margin: 20px 0 10px;">Academic Details</h4>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">English Grade</div>
              <div class="info-value" id="detailEnglish"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Mathematics Grade</div>
              <div class="info-value" id="detailMath"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Social Studies</div>
              <div class="info-value" id="detailSocial"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Science</div>
              <div class="info-value" id="detailScience"></div>
            </div>
          </div>

          <h4 style="margin: 20px 0 10px;">Sponsor Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Sponsor Name</div>
              <div class="info-value" id="detailSponsor"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Relationship</div>
              <div class="info-value" id="detailRelationship"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Sponsor Phone</div>
              <div class="info-value" id="detailSponsorPhone"></div>
            </div>
          </div>

          <div style="margin-top: 30px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="downloadStudentDetails()">
              <i class="fas fa-download"></i> Download (PDF)
            </button>
            <button class="btn btn-secondary" onclick="printStudentDetails()">
              <i class="fas fa-print"></i> Print
            </button>
            <button class="btn btn-primary" onclick="sendSMSToApplicant()">
              <i class="fas fa-sms"></i> Send SMS
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info / Message Modal -->
  <div class="modal" id="infoModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title">Message</h3>
        <button class="action-btn view-btn" onclick="closeModal('infoModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="infoModalBody" style="font-size:16px;color:var(--dark);"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeModal('infoModal')">OK</button>
      </div>
    </div>
  </div>

  <!-- Form Purchase Details Modal -->
  <div class="modal" id="formPurchaseModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title">Form Purchase Details</h3>
        <button class="action-btn view-btn" onclick="closeModal('formPurchaseModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="formPurchaseLoading" class="loading">
          <div class="spinner"></div>
        </div>
        <div id="formPurchaseContent" style="display: none;">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Reference Code</div>
              <div class="info-value" id="fpRefCode"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Payment Status</div>
              <div class="info-value" id="fpPaymentStatus"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Amount</div>
              <div class="info-value" id="fpAmount"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Payment Date</div>
              <div class="info-value" id="fpPaymentDate"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Customer Email</div>
              <div class="info-value" id="fpEmail"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Customer Phone</div>
              <div class="info-value" id="fpPhone"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Customer Name</div>
              <div class="info-value" id="fpCustomerName"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Transaction ID</div>
              <div class="info-value" id="fpTransactionId"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Payment Method</div>
              <div class="info-value" id="fpPaymentMethod"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Currency</div>
              <div class="info-value" id="fpCurrency"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Created At</div>
              <div class="info-value" id="fpCreatedAt"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Updated At</div>
              <div class="info-value" id="fpUpdatedAt"></div>
            </div>
          </div>

          <h4 style="margin: 20px 0 10px;">Additional Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Metadata</div>
              <div class="info-value" id="fpMetadata" style="word-break: break-all; font-family: monospace; font-size: 12px;"></div>
            </div>
          </div>

          <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 20px;">
            <strong style="display: block; margin-bottom: 8px;">Status:</strong>
            <p id="fpStatusNote" style="margin: 0;"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info / Message Modal -->
  <div class="modal" id="infoModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 class="modal-title">Message</h3>
        <button class="action-btn view-btn" onclick="closeModal('infoModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="infoModalBody" style="font-size:16px;color:var(--dark);"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeModal('infoModal')">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" style="display: none; position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: var(--shadow); z-index: 3000;">
    <i class="fas fa-check-circle"></i> <span id="toastMessage">Operation successful!</span>
  </div>

  <script>
    // Supabase Configuration
    const supabaseUrl = 'https://fyriapqeztevzkcaaiqw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5cmlhcHFlenRldnprY2FhaXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5OTgyNTcsImV4cCI6MjA3OTU3NDI1N30.Re3EZ2VXE6Z7qWhVlxV6yqqIWB8wj1b1wURNLZXpddY';

    // Initialize Supabase client in a way that's compatible with CDN and bundler setups.
    // Avoid declaring a global identifier named `supabase` (some builds expose that name),
    // and store the active client on `window.__sb` so the page can reference a single client.
    try {
      (function() {
        const clientFromFactory = (typeof createClient === 'function') ? createClient(supabaseUrl, supabaseKey) : null;
        const clientFromWindowFactory = (window.supabase && typeof window.supabase.createClient === 'function') ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;
        // Preserve an existing client if already initialized on window.__sb
        window.__sb = window.__sb || clientFromFactory || clientFromWindowFactory || null;
        if (!window.__sb) {
          console.error('Supabase client not available. Ensure the @supabase/supabase-js script is included before this script.');
        }
      })();
    } catch (e) {
      console.error('Error initializing Supabase client:', e);
    }

    // Global variables for student payments
    let allStudentPayments = [];
    let filteredStudentPayments = [];
    let currentPaymentPage = 1;
    const paymentItemsPerPage = 15;

    // Global variables for all students
    let allStudents = [];
    let filteredAllStudents = [];
    let currentAllStudentsPage = 1;
    const allStudentsItemsPerPage = 15;

    // Global Variables
    let allApplicants = [];
    let filteredApplicants = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentApplicantId = null;
    let charts = {};
    // Notifications store (in-memory)
    let notifications = [];
    const MAX_NOTIFICATIONS = 200;

    // Load student payments from both level100payments and payments tables
    async function loadStudentPayments() {
      try {
        document.getElementById('studentPaymentsLoading').style.display = 'flex';
        document.getElementById('studentPaymentsTable').style.display = 'none';

        // Fetch from level100payments table
        const { data: level100Payments, error: error1 } = await window.__sb.from('level100payments').select('*').order('created_at', { ascending: false });

        // Fetch from payments table (all payments)
        const { data: otherPayments, error: error2 } = await window.__sb.from('payments').select('*').order('created_at', { ascending: false });

        if (error1) {
          console.warn('Error fetching level100payments:', error1);
        }
        
        if (error2) {
          console.warn('Error fetching payments:', error2);
        }

        // Normalize data from both tables
        const normalizePayment = (payment, source) => {
          return {
            ...payment,
            student_id: payment.student_id || '',
            first_name: payment.first_name || payment.student_name || '',
            last_name: payment.last_name || '',
            student_name: payment.student_name || `${payment.first_name || ''} ${payment.last_name || ''}`.trim(),
            payment_type: payment.payment_type || payment.fee_type || '',
            fee_type: payment.fee_type || payment.payment_type || '',
            amount: Number(payment.amount) || 0,
            status: payment.status || payment.payment_status || 'pending',
            created_at: payment.created_at || new Date().toISOString(),
            source_table: source
          };
        };

        // Combine both arrays with normalized data
        allStudentPayments = [
          ...(level100Payments || []).map(p => normalizePayment(p, 'level100payments')),
          ...(otherPayments || []).map(p => normalizePayment(p, 'payments'))
        ];

        // Populate filter dropdowns with unique schools and programs
        populatePaymentFilters();

        filteredStudentPayments = [...allStudentPayments];
        
        renderStudentPaymentsTable();
        updatePaymentPagination();

        document.getElementById('studentPaymentsLoading').style.display = 'none';
        document.getElementById('studentPaymentsTable').style.display = 'table';
        document.getElementById('paymentPagination').style.display = 'flex';

        showToast(`Loaded ${allStudentPayments.length} payment records`, 'info');

      } catch (error) {
        console.error('Error loading student payments:', error);
        showToast('Error loading payments', 'error');
        document.getElementById('studentPaymentsLoading').style.display = 'none';
      }
    }

    // Populate level, school, and program filters
    function populatePaymentFilters() {
      const schools = new Set();
      const programs = new Set();
      const programsBySchool = {};

      allStudentPayments.forEach(payment => {
        // Add schools/departments
        if (payment.school) {
          schools.add(String(payment.school).trim());
          // map program to school entry
          const rawSchool = String(payment.school).trim();
          const prog = (payment.program || '').toString().trim();
          if (prog) {
            const token = (function(raw){
              const r = raw.toLowerCase();
              if (r.includes('media')) return 'MEDIA';
              if (r.includes('fashion')) return 'FASHION';
              if (r.includes('cater')) return 'CATERING';
              if (r.includes('cosmet') || r.includes('cosmo')) return 'COSMETOLOGY';
              if (r.includes('tech')) return 'TECHNOLOGY';
              return null;
            })(rawSchool);
            const key = token || rawSchool;
            programsBySchool[key] = programsBySchool[key] || new Set();
            programsBySchool[key].add(prog);
          }
        } else if (payment.department) {
          schools.add(String(payment.department).trim());
          const rawSchool = String(payment.department).trim();
          const prog = (payment.program || '').toString().trim();
          if (prog) {
            const token = (function(raw){
              const r = raw.toLowerCase();
              if (r.includes('media')) return 'MEDIA';
              if (r.includes('fashion')) return 'FASHION';
              if (r.includes('cater')) return 'CATERING';
              if (r.includes('cosmet') || r.includes('cosmo')) return 'COSMETOLOGY';
              if (r.includes('tech')) return 'TECHNOLOGY';
              return null;
            })(rawSchool);
            const key = token || rawSchool;
            programsBySchool[key] = programsBySchool[key] || new Set();
            programsBySchool[key].add(prog);
          }
        }
        // Add programs
        if (payment.program) {
          programs.add(String(payment.program).trim());
        }
      });

      // Remove empty values
      schools.delete('');
      schools.delete('Unknown');

      // Ensure the five GH schools are present (use tokens for values)
      const canonical = {
        MEDIA: 'Media School',
        FASHION: 'Fashion School',
        CATERING: 'Catering School',
        COSMETOLOGY: 'Cosmetology School',
        TECHNOLOGY: 'Technology School'
      };
      programs.delete('');

      // Update school dropdown
      const schoolSelect = document.getElementById('paymentSchoolFilter');
      const currentSchool = schoolSelect.value;
      schoolSelect.innerHTML = '<option value="">All Schools</option>';

      // Only include the canonical five GH schools in the dropdown.
      Object.keys(canonical).forEach(tok => {
        const opt = document.createElement('option');
        opt.value = tok;
        opt.textContent = canonical[tok];
        schoolSelect.appendChild(opt);
      });

      // Preserve previous selection only if it is one of the canonical tokens
      const canonicalKeys = Object.keys(canonical);
      if (canonicalKeys.includes(currentSchool)) {
        schoolSelect.value = currentSchool;
      } else {
        schoolSelect.value = '';
      }

      // Update program dropdown. If a canonical school is selected, show only
      // programs offered by that school; otherwise show all discovered programs.
      const programSelect = document.getElementById('paymentProgramFilter');
      const currentProgram = programSelect.value;
      programSelect.innerHTML = '<option value="">All Programs</option>';
      const selectedSchool = (document.getElementById('paymentSchoolFilter') || {}).value || '';
      // reuse canonicalKeys defined earlier
      let programList = [];
      if (canonicalKeys.includes(selectedSchool)) {
        const setFor = programsBySchool[selectedSchool] || new Set();
        programList = Array.from(setFor).filter(p => p && p.length > 0).sort();
      } else {
        programList = Array.from(programs).filter(p => p && p.length > 0).sort();
      }
      programList.forEach(program => {
        const option = document.createElement('option');
        option.value = program;
        option.textContent = program;
        programSelect.appendChild(option);
      });
      programSelect.value = currentProgram;
    }

    // Called when the payment school dropdown changes: update programs then filter
    function handlePaymentSchoolChange() {
      // Re-populate program dropdown based on selection
      populatePaymentFilters();
      // Then apply filtering
      filterStudentPayments();
    }

    // Refresh student payments
    function refreshStudentPayments() {
      loadStudentPayments();
    }

    // Filter student payments
    // Filter student payments based on active filters
    function filterStudentPayments() {
      const level = document.getElementById('paymentLevelFilter').value;
      const school = document.getElementById('paymentSchoolFilter').value;
      const program = document.getElementById('paymentProgramFilter').value;
      const paymentType = document.getElementById('paymentTypeFilter').value;
      const paymentStatus = document.getElementById('paymentStatusFilter').value;
      const dateFrom = document.getElementById('paymentDateFrom').value;
      const dateTo = document.getElementById('paymentDateTo').value;

      filteredStudentPayments = allStudentPayments.filter(payment => {
        // Level filter - check if payment level contains the selected level
        if (level) {
          const paymentLevel = String(payment.level || '').toLowerCase();
          if (!paymentLevel.includes(level)) return false;
        }

        // School/Department filter
        if (school) {
          const paymentSchool = String(payment.school || payment.department || '').toLowerCase();
          const schoolVal = String(school || '').toLowerCase();
          // If selected value is one of the canonical tokens, do a contains check
          const canonicalTokens = ['media','fashion','catering','cosmetology','technology'];
          if (canonicalTokens.includes(schoolVal)) {
            if (!paymentSchool.includes(schoolVal)) return false;
          } else {
            if (paymentSchool !== schoolVal) return false;
          }
        }

        // Program filter
        if (program) {
          const paymentProgram = String(payment.program || '').toLowerCase();
          const programLower = String(program).toLowerCase();
          if (paymentProgram !== programLower) return false;
        }
        
        // Payment type filter - match against normalized fee type names and required amounts
        if (paymentType) {
          const rawFeeType = payment.payment_type || payment.fee_type || 'other';
          const requiredAmt = getRequiredAmount(rawFeeType);
          
          // Match payment type filter by comparing required amounts
          let typeMatches = false;
          if (paymentType === 'tuition_fees' || paymentType === 'tuition') {
            typeMatches = requiredAmt === 2550;
          } else if (paymentType === 'src_dues') {
            typeMatches = requiredAmt === 50 && !String(rawFeeType).toLowerCase().includes('medical') && !String(rawFeeType).toLowerCase().includes('department');
          } else if (paymentType === 'medical_dues') {
            typeMatches = requiredAmt === 80;
          } else if (paymentType === 'departmental_dues') {
            typeMatches = requiredAmt === 50 && String(rawFeeType).toLowerCase().includes('department');
          } else if (paymentType === 'admission_fees') {
            typeMatches = requiredAmt === 800;
          }
          
          if (!typeMatches) return false;
        }
        
        // Payment status filter
        if (paymentStatus) {
          const status = String(payment.status || payment.payment_status || 'approved').toLowerCase();
          const statusLower = String(paymentStatus).toLowerCase();
          if (status !== statusLower) return false;
        }
        
        // Date range filter
        if (dateFrom || dateTo) {
          try {
            const paymentDate = new Date(payment.created_at).toISOString().split('T')[0];
            if (dateFrom && paymentDate < dateFrom) return false;
            if (dateTo && paymentDate > dateTo) return false;
          } catch (e) {
            // Invalid date, skip filter
          }
        }
        
        return true;
      });

      currentPaymentPage = 1;
      renderStudentPaymentsTable();
      updatePaymentPagination();
    }

    // Define required amounts for each fee type (must match payment type filter)
    const feeRequirements = {
      'tuition': 2550,
      'tuition_fees': 2550,
      'tuition fee': 2550,
      'src': 50,
      'src_dues': 50,
      'src dues': 50,
      'medical': 80,
      'medical_dues': 80,
      'medical dues': 80,
      'departmental': 50,
      'departmental_dues': 50,
      'departmental dues': 50,
      'admission_fees': 800,
      'admission': 800,
      'admission fees': 800
    };

    // Search for a student by ID and display only their payment records in Accounts modal
    function searchPaymentByStudentId() {
      const searchInput = document.getElementById('paymentStudentSearchInput');
      const studentId = (searchInput.value || '').trim();
      
      if (!studentId) {
        showToast('Please enter a Student ID to search', 'info');
        return;
      }
      
      // Fetch student info from both newstudents and students tables
      fetchAndDisplayStudentInfo(studentId);
      
      // Filter payment records to show only this student's payments
      filteredStudentPayments = allStudentPayments.filter(payment => 
        String(payment.student_id || '').toLowerCase() === studentId.toLowerCase()
      );
      
      if (filteredStudentPayments.length === 0) {
        showToast('No payment records found for this Student ID', 'info');
      } else {
        showToast(`Found ${filteredStudentPayments.length} payment record(s) for this student`, 'success');
      }
      
      currentPaymentPage = 1;
      renderStudentPaymentsTable();
      updatePaymentPagination();
    }

    // Fetch student info from both newstudents and students tables
    async function fetchAndDisplayStudentInfo(studentId) {
      try {
        // Fetch from both tables
        const { data: newStudentData, error: newStudentError } = await window.__sb
          .from('newstudents')
          .select('*')
          .eq('student_id', studentId)
          .maybeSingle();

        const { data: studentData, error: studentError } = await window.__sb
          .from('student_master_db')
          .select('*')
          .eq('student_id', studentId)
          .maybeSingle();

        // Use whichever has data (prefer student_master_db if both exist)
        const student = studentData || newStudentData;

        if (!student) {
          console.warn('Student not found in either newstudents or student_master_db table');
          return;
        }

        // Display student info in console for debugging
        console.log('Student info fetched:', {
          source: studentData ? 'students' : 'newstudents',
          student_id: student.student_id,
          name: `${student.first_name || student.firstname || ''} ${student.last_name || student.lastname || ''}`.trim(),
          email: student.email,
          phone: student.phone,
          level: student.level,
          school: student.school || student.department,
          program: student.program || student.course_type
        });

      } catch (error) {
        console.error('Error fetching student info:', error);
      }
    }
    
    // Clear the student search and reload all payment records
    function clearPaymentSearch() {
      const searchInput = document.getElementById('paymentStudentSearchInput');
      searchInput.value = '';
      
      // Reset to show all payments
      filteredStudentPayments = [...allStudentPayments];
      
      // Reset filter dropdowns
      document.getElementById('paymentLevelFilter').value = '';
      document.getElementById('paymentSchoolFilter').value = '';
      document.getElementById('paymentProgramFilter').value = '';
      document.getElementById('paymentTypeFilter').value = '';
      document.getElementById('paymentStatusFilter').value = '';
      document.getElementById('paymentDateFrom').value = '';
      document.getElementById('paymentDateTo').value = '';
      
      currentPaymentPage = 1;
      renderStudentPaymentsTable();
      updatePaymentPagination();
      showToast('Search cleared. Showing all payment records.', 'info');
    }

    // Helper function to get required amount based on fee type
    function getRequiredAmount(feeType) {
      if (!feeType) return 0;
      const normalized = String(feeType).toLowerCase().trim();
      return feeRequirements[normalized] || 0;
    }

    // Helper function to get user-friendly fee type name
    function getFeeTypeName(feeType) {
      if (!feeType) return 'Other';
      const friendly = {
        'tuition': 'Tuition Fee',
        'tuition_fees': 'Tuition Fee',
        'tuition fee': 'Tuition Fee',
        'src': 'SRC Dues',
        'src_dues': 'SRC Dues',
        'src dues': 'SRC Dues',
        'medical': 'Medical Dues',
        'medical_dues': 'Medical Dues',
        'medical dues': 'Medical Dues',
        'departmental': 'Departmental Dues',
        'departmental_dues': 'Departmental Dues',
        'departmental dues': 'Departmental Dues',
        'admission_fees': 'Admission Fees',
        'admission': 'Admission Fees',
        'admission fees': 'Admission Fees'
      };
      const normalized = String(feeType).toLowerCase().trim();
      return friendly[normalized] || (feeType.replace(/_/g, ' ').charAt(0).toUpperCase() + feeType.replace(/_/g, ' ').slice(1).toLowerCase());
    }

    function renderStudentPaymentsTable() {
      const tbody = document.getElementById('studentPaymentsTableBody');
      tbody.innerHTML = '';
      
      const start = (currentPaymentPage - 1) * paymentItemsPerPage;
      const end = start + paymentItemsPerPage;
      const pagePayments = filteredStudentPayments.slice(start, end);
      
      pagePayments.forEach(payment => {
        const row = document.createElement('tr');
        
        // Get the fee type from payment record
        const rawFeeType = payment.payment_type || payment.fee_type || 'Other';
        const paymentTypeDisplay = (rawFeeType || 'Other').replace(/_/g, ' ').toUpperCase();
        
        // Get payment breakdown - show descriptive text based on payment type
        let paymentBreakdown = payment.fee_breakdown || '';
        if (!paymentBreakdown) {
          // Generate meaningful breakdown from payment type
          const friendlyType = getFeeTypeName(rawFeeType);
          paymentBreakdown = `${friendlyType} Payment`;
        }
        
        // Get required amount based on fee type
        const requiredAmount = getRequiredAmount(rawFeeType);
        
        // Get amount actually paid by student
        const amountPaid = Number(payment.amount) || Number(payment.amount_paid) || 0;
        
        // Calculate amount owing
        const amountOwing = Math.max(0, requiredAmount - amountPaid);
        
        // Set status to auto-approved
        const status = 'approved';
        const statusText = 'Approved';
        
        // Determine eligibility: 80% or more paid
        const percentagePaid = requiredAmount > 0 ? (amountPaid / requiredAmount) * 100 : 0;
        const isEligible = percentagePaid >= 80;
        const eligibilityBadge = isEligible 
          ? '<span class="status-badge status-approved">✓ Eligible</span>'
          : `<span class="status-badge status-pending">✗ ${percentagePaid.toFixed(1)}% Paid</span>`;
        
        row.innerHTML = `
          <td>${payment.student_id || 'N/A'}</td>
          <td>${escapeHtml((payment.first_name || payment.student_name || '') + ' ' + (payment.last_name || '')).trim() || 'N/A'}</td>
          <td>${escapeHtml(paymentTypeDisplay) || 'N/A'}</td>
          <td>${escapeHtml(paymentBreakdown)}</td>
          <td class="text-right">GHS ${requiredAmount.toFixed(2)}</td>
          <td class="text-right">GHS ${amountPaid.toFixed(2)}</td>
          <td class="text-right">GHS ${amountOwing.toFixed(2)}</td>
          <td><span class="status-badge status-approved">${statusText}</span></td>
          <td>${eligibilityBadge}</td>
          <td>
            <div class="action-buttons">
              <div class="action-btn view-btn" onclick="viewDetailedStudentPayment('${payment.student_id || ''}')">
                <i class="fas fa-eye"></i>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Update payment pagination
    function updatePaymentPagination() {
      const totalPages = Math.ceil(filteredStudentPayments.length / paymentItemsPerPage);
      document.getElementById('paymentPageInfo').textContent = `Page ${currentPaymentPage} of ${totalPages}`;
    }

    // Change payment page
    function changePaymentPage(delta) {
      const totalPages = Math.ceil(filteredStudentPayments.length / paymentItemsPerPage);
      const newPage = currentPaymentPage + delta;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPaymentPage = newPage;
        renderStudentPaymentsTable();
        updatePaymentPagination();
      }
    }

    // View detailed student payment information
    async function viewDetailedStudentPayment(paymentId) {
      try {
        // paymentId is the student_id
        let studentId = paymentId;
        
        // If it's a composite key, extract student_id
        if (paymentId.includes('|')) {
          const [id] = paymentId.split('|');
          studentId = id;
        }

        if (!studentId) {
          showToast('Invalid student ID', 'error');
          return;
        }

        // Fetch student info from multiple sources
        const [studentsRes, masterRes, newstudentsRes] = await Promise.all([
          window.__sb.from('student_master_db').select('*').eq('student_id', studentId).maybeSingle(),
          window.__sb.from('student_master_db').select('*').eq('student_id', studentId).maybeSingle(),
          window.__sb.from('newstudents').select('*').eq('student_id', studentId).maybeSingle()
        ]);

        let studentInfo = masterRes.data || studentsRes.data || newstudentsRes.data;
        let fullName = 'N/A';
        
        if (studentInfo) {
          fullName = `${studentInfo.first_name || ''} ${studentInfo.middle_name || ''} ${studentInfo.last_name || studentInfo.surname || ''}`.trim();
        }

        // Fetch ALL payment records for this student from both tables
        const { data: level100Payments, error: level100Error } = await window.__sb
          .from('level100payments')
          .select('*')
          .eq('student_id', studentId);

        const { data: regularPayments, error: regularError } = await window.__sb
          .from('payments')
          .select('*')
          .eq('student_id', studentId);

        if (level100Error && regularError) {
          console.error('Error fetching payments:', level100Error, regularError);
          showToast('Error loading payment details', 'error');
          return;
        }

        // Combine both payment sources
        const allPayments = [
          ...(level100Payments || []),
          ...(regularPayments || [])
        ];

        // Group payments by payment type and calculate totals
        const paymentsByType = {};
        const paymentTypes = ['tuition_fees', 'src_dues', 'medical_dues', 'departmental_dues'];
        
        // Initialize all payment types
        paymentTypes.forEach(type => {
          paymentsByType[type] = {
            requiredAmount: getRequiredAmount(type),
            amountPaid: 0,
            amountOwing: 0,
            paymentRecords: []
          };
        });

        // Populate actual payment data
        (allPayments || []).forEach(p => {
          const rawFeeType = p.payment_type || p.fee_type || 'Other';
          const normalizedType = String(rawFeeType).toLowerCase().replace(/\s+/g, '_');
          
          // Find matching type
          const matchingType = paymentTypes.find(t => 
            normalizedType.includes(t.replace(/_/g, '')) || 
            t.includes(normalizedType.replace(/_/g, ''))
          ) || normalizedType;

          if (paymentsByType[matchingType]) {
            paymentsByType[matchingType].amountPaid += Number(p.amount) || 0;
            paymentsByType[matchingType].paymentRecords.push(p);
          }
        });

        // Calculate owing for each type and overall eligibility
        let totalRequired = 0;
        let totalPaid = 0;
        let totalOwing = 0;
        
        Object.keys(paymentsByType).forEach(type => {
          const data = paymentsByType[type];
          data.amountOwing = Math.max(0, data.requiredAmount - data.amountPaid);
          totalRequired += data.requiredAmount;
          totalPaid += data.amountPaid;
          totalOwing += data.amountOwing;
        });

        // Eligibility: 80% or more of total required amount is paid
        const percentagePaid = totalRequired > 0 ? Math.round((totalPaid / totalRequired) * 100) : 0;
        const isFullyPaid = percentagePaid >= 80;
        
        const eligibilityStatus = isFullyPaid
          ? '<span style="color: var(--success); font-weight: 600;">✓ ELIGIBLE TO REGISTER</span>'
          : `<span style="color: var(--danger); font-weight: 600;">✗ NOT ELIGIBLE - ${percentagePaid}% PAID (80% REQUIRED)</span>`;

        const html = `
          <div style="display:flex; flex-direction:column; gap:20px;">
            <!-- Header Info -->
            <div style="padding: 15px; background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%); border-radius: 8px; color: white;">
              <h3 style="margin: 0 0 10px 0; font-size: 18px;">${escapeHtml(fullName)}</h3>
              <p style="margin: 5px 0; font-size: 14px;">Student ID: <strong>${studentId}</strong> | Complete Payment Breakdown</p>
            </div>

            <!-- Overall Payment Summary -->
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Total Required</div>
                <div class="info-value" style="font-size: 20px; color: var(--primary); font-weight: 700;">GHS ${totalRequired.toFixed(2)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Total Paid</div>
                <div class="info-value" style="font-size: 20px; color: var(--success); font-weight: 700;">GHS ${totalPaid.toFixed(2)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Total Owing</div>
                <div class="info-value" style="font-size: 20px; color: ${totalOwing > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: 700;">GHS ${totalOwing.toFixed(2)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Overall Status</div>
                <div class="info-value"><span class="status-badge status-${isFullyPaid ? 'approved' : 'pending'}">${isFullyPaid ? 'FULLY PAID' : 'PARTIAL'}</span></div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div style="background: #f0f0f0; border-radius: 8px; padding: 15px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-weight: 600;">Overall Payment Progress</span>
                <span style="font-weight: 600; color: var(--primary);">${percentagePaid}% (80% Required)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentagePaid}%;"></div>
              </div>
            </div>

            <!-- Registration Eligibility -->
            <!-- Registration Eligibility -->
            <div style="padding: 15px; background: ${isFullyPaid ? '#d4edda' : '#f8d7da'}; border-radius: 8px; border-left: 4px solid ${isFullyPaid ? 'var(--success)' : 'var(--danger)'};">
              <div style="margin-bottom: 10px; font-weight: 600;">Registration Eligibility</div>
              <div style="margin-bottom: 10px;">${eligibilityStatus}</div>
              ${isFullyPaid 
                ? '<p style="margin: 0; font-size: 14px; color: #155724;">This student has paid 80% or more and is eligible to register for courses.</p>'
                : `<p style="margin: 0; font-size: 14px; color: #721c24;">This student has paid <strong>${percentagePaid}%</strong> (GHS ${totalPaid.toFixed(2)} of GHS ${totalRequired.toFixed(2)}). <strong>80% payment is required to register.</strong></p>`
              }
            </div>

            <!-- Payment Types Breakdown -->
            <div>
              <h4 style="margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">Payment Breakdown by Type</h4>
              ${Object.keys(paymentsByType).map(type => {
                const data = paymentsByType[type];
                const typeDisplay = type.replace(/_/g, ' ').toUpperCase();
                const isPaid = data.amountOwing === 0;
                return `
                  <div style="margin-bottom: 15px; padding: 12px; background: #f9f9f9; border-radius: 6px; border-left: 4px solid ${isPaid ? 'var(--success)' : 'var(--danger)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                      <strong style="font-size: 14px;">${typeDisplay}</strong>
                      <span class="status-badge status-${isPaid ? 'approved' : 'pending'}" style="font-size: 12px;">${isPaid ? '✓ PAID' : '✗ OWING'}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 13px;">
                      <div>
                        <div style="color: #666; margin-bottom: 3px;">Required</div>
                        <div style="font-weight: 600; color: var(--primary);">GHS ${data.requiredAmount.toFixed(2)}</div>
                      </div>
                      <div>
                        <div style="color: #666; margin-bottom: 3px;">Paid</div>
                        <div style="font-weight: 600; color: var(--success);">GHS ${data.amountPaid.toFixed(2)}</div>
                      </div>
                      <div>
                        <div style="color: #666; margin-bottom: 3px;">Owing</div>
                        <div style="font-weight: 600; color: ${data.amountOwing > 0 ? 'var(--danger)' : 'var(--success)'};">GHS ${data.amountOwing.toFixed(2)}</div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>

            <!-- Detailed Information -->
            <div>
              <h4 style="margin-top: 20px; margin-bottom: 10px;">Additional Details</h4>
              <div class="info-grid">
                <div class="info-item">
                  <div class="info-label">Student Level</div>
                  <div class="info-value">${(studentInfo && (studentInfo.level || studentInfo.year)) || 'N/A'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">School/Department</div>
                  <div class="info-value">${(studentInfo && (studentInfo.school || studentInfo.department)) || 'N/A'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Program</div>
                  <div class="info-value">${(studentInfo && (studentInfo.program || studentInfo.programme)) || 'N/A'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Total Payment Records</div>
                  <div class="info-value">${(allPayments || []).length}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Last Payment Date</div>
                  <div class="info-value">${(studentInfo && studentInfo.created_at) ? formatDate(studentInfo.created_at) : 'N/A'}</div>
                </div>
              </div>
            </div>

            <!-- Summary Box -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
              <strong>Complete Payment Summary:</strong>
              <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                <li style="margin: 5px 0;">Total Required Across All Types: <strong>GHS ${totalRequired.toFixed(2)}</strong></li>
                <li style="margin: 5px 0;">Total Already Paid: <strong>GHS ${totalPaid.toFixed(2)}</strong></li>
                <li style="margin: 5px 0;">Total Still Owing: <strong style="color: ${totalOwing > 0 ? 'var(--danger)' : 'var(--success)'};">GHS ${totalOwing.toFixed(2)}</strong></li>
                <li style="margin: 5px 0;">Overall Eligibility: <strong>${isFullyPaid ? '✓ ELIGIBLE - Can Register' : '✗ NOT ELIGIBLE - Payments Pending'}</strong></li>
              </ul>
            </div>
          </div>
        `;

        showInfoModal(html, `Complete Payment Breakdown - ${escapeHtml(fullName)}`);
      } catch (error) {
        console.error('Error viewing detailed payment:', error);
        showToast('Error loading payment details', 'error');
      }
    }

    // View student payment detail
    async function viewStudentPaymentDetail(paymentId) {
      viewDetailedStudentPayment(paymentId);
    }

    // Export payment data
    function exportPaymentData(format) {
      const data = filteredStudentPayments.map(payment => ({
        'Student ID': payment.student_id,
        'Name': `${payment.first_name || ''} ${payment.last_name || ''}`.trim(),
        'Payment Type': (payment.payment_type || '').replace(/_/g, ' ').toUpperCase(),
        'Amount': payment.amount,
        'Status': (payment.payment_status || 'pending').toUpperCase(),
        'Payment Date': formatDate(payment.payment_date || payment.created_at),
        'Receipt No.': payment.receipt_number || payment.transaction_id || '',
        'Payment Method': payment.payment_method || ''
      }));

      if (format === 'csv') {
        exportToCSV(data);
      } else if (format === 'excel') {
        exportToExcel(data);
      }
    }

    // Download payment data as PDF report
    function downloadPaymentPDF() {
      try {
        const { jsPDF } = window.jspdf;
        if (!jsPDF || !window.jspdf) {
          showToast('PDF library not loaded', 'error');
          return;
        }

        const doc = new jsPDF('l', 'pt', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // Header
        doc.setFontSize(16);
        doc.text('GH SCHOOLS - PAYMENT REPORT', pageWidth / 2, 30, { align: 'center' });
        
        doc.setFontSize(10);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, pageWidth / 2, 50, { align: 'center' });
        
        // Prepare data for table
        const tableData = filteredStudentPayments.map(payment => [
          payment.student_id || 'N/A',
          `${payment.first_name || ''} ${payment.last_name || ''}`.trim() || 'N/A',
          (payment.payment_type || '').replace(/_/g, ' ').toUpperCase(),
          `GHS ${(payment.amount || 0).toLocaleString('en-GH', {minimumFractionDigits: 2})}`,
          (payment.payment_status || 'pending').toUpperCase(),
          formatDate(payment.payment_date || payment.created_at),
          payment.receipt_number || payment.transaction_id || '',
          payment.payment_method || ''
        ]);

        // Add table
        doc.autoTable({
          head: [['Student ID', 'Name', 'Payment Type', 'Amount', 'Status', 'Date', 'Receipt No.', 'Method']],
          body: tableData,
          startY: 70,
          styles: {
            fontSize: 9,
            cellPadding: 5,
            overflow: 'linebreak'
          },
          headStyles: {
            fillColor: [0, 102, 204],
            textColor: 255,
            fontStyle: 'bold'
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240]
          },
          margin: { top: 70, right: 10, bottom: 20, left: 10 }
        });

        // Footer with summary
        const summary = `Total Records: ${filteredStudentPayments.length}`;
        doc.setFontSize(10);
        doc.text(summary, 10, pageHeight - 20);

        // Save PDF
        doc.save(`Payment_Report_${new Date().getTime()}.pdf`);
        showToast('PDF downloaded successfully', 'success');
      } catch (error) {
        console.error('Error generating PDF:', error);
        showToast('Error generating PDF report', 'error');
      }
    }

    // Load all students from newstudents table with their payment data from level100payments
    async function loadAllStudents() {
      try {
        document.getElementById('allStudentsLoading').style.display = 'flex';
        document.getElementById('allStudentsTable').style.display = 'none';

        // Fetch all students from student_master_db table with new schema
        const { data: studentsData, error: studentsError } = await window.__sb.from('student_master_db').select('id, student_id, first_name, middle_name, surname, email, phone_number, whatsapp_number, department, level').order('created_at', { ascending: false });

        if (studentsError) {
          console.error('Error loading students from student_master_db table:', studentsError);
          showToast('Error loading students', 'error');
          return;
        }

        // Map the data to match the display format
        allStudents = (studentsData || []).map(student => {
          return {
            id: student.id,
            student_id: student.student_id,
            first_name: student.first_name,
            middle_name: student.middle_name,
            surname: student.surname,
            email: student.email,
            phone_number_1: student.phone_number,
            phone_number_2: '',  // Not in database schema
            whatsapp: student.whatsapp_number,
            school: student.department,
            pathway: '',  // Not in database schema
            program: '',  // Not in database schema
            level: student.level
          };
        });

        filteredAllStudents = [...allStudents];
        currentAllStudentsPage = 1;
        renderAllStudentsTable();
        updateAllStudentsPagination();

        document.getElementById('allStudentsLoading').style.display = 'none';
        document.getElementById('allStudentsTable').style.display = 'table';

        console.log('Loaded', allStudents.length, 'students from student_master_db table');
      } catch (error) {
        console.error('Error in loadAllStudents:', error);
        showToast('Error loading students', 'error');
      }
    }

    // Clear students search results and hide table
    function clearAllStudentsResults() {
      filteredAllStudents = [];
      const tbody = document.getElementById('allStudentsTableBody');
      if (tbody) tbody.innerHTML = '';
      document.getElementById('allStudentsTable').style.display = 'none';
      document.getElementById('allStudentsPagination').style.display = 'none';
      document.getElementById('allStudentsLoading').style.display = 'none';
      const input = document.getElementById('studentSearchInput'); if (input) input.value = '';
    }

    // Search for a student by student_id and display single result in Accounts modal
    async function searchAccountById(studentId) {
      if (!studentId || !String(studentId).trim()) {
        showToast('Please enter a Student ID to search', 'info');
        return;
      }
      try {
        document.getElementById('allStudentsLoading').style.display = 'flex';
        document.getElementById('allStudentsTable').style.display = 'none';

        const q = String(studentId).trim();
        
        // Fetch from multiple sources: students and newstudents
        const { data: studentData, error: studentError } = await window.__sb.from('student_master_db').select('*').eq('student_id', q).maybeSingle();
        const { data: newStudentData, error: newStudentError } = await window.__sb.from('newstudents').select('*').eq('student_id', q).maybeSingle();
        
        document.getElementById('allStudentsLoading').style.display = 'none';
        const tbody = document.getElementById('allStudentsTableBody');
        tbody.innerHTML = '';
        
        // Use whichever source has data (prefer students, then newstudents)
        const data = studentData || newStudentData;
        
        if (!data) {
          showToast('Student not found in any table', 'info');
          document.getElementById('allStudentsTable').style.display = 'none';
          return;
        }

        // Log which table the data came from
        const source = studentData ? 'students' : 'newstudents';
        console.log(`Student fetched from: ${source}`, data);

        // Build payment summary fields similar to loadAllStudents mapping
        const student = data;
        const paymentsByType = {};
        const paymentFields = {
          'admission_fees': 'Admission Fees',
          'tuition_fees': 'Tuition Fees',
          'medical_dues': 'Medical Dues',
          'src_dues': 'SRC Dues',
          'departmental_dues': 'Departmental Dues'
        };
        let totalOwing = 0;
        Object.keys(paymentFields).forEach(field => {
          const owing = student[`${field}_owing`] || student[`${field}`] || 0;
          paymentsByType[paymentFields[field]] = {
            required: student[`${field}_required`] || 0,
            paid: student[`${field}_paid`] || 0,
            owing: owing,
            status: owing > 0 ? 'pending' : 'paid'
          };
          totalOwing += owing;
        });

        // Render single row with proper column alignment
        const row = document.createElement('tr');
        
        // Extract fields directly from database columns
        const student_id = student.student_id || student.id || 'N/A';
        const first_name = student.first_name || '';
        const middle_name = student.middle_name || '';
        const surname = student.surname || student.last_name || student.lastname || '';
        const email = student.email || '';
        const phone_number_1 = student.phone_number_1 || student.phone || '';
        const phone_number_2 = student.phone_number_2 || '';
        const whatsapp = student.whatsapp || '';
        const school = student.school || '';
        const pathway = student.pathway || '';
        const program = student.program || '';
        const level = student.level || '';

        row.innerHTML = `
          <td class="text-center">${student_id}</td>
          <td>${first_name || 'N/A'}</td>
          <td>${middle_name || 'N/A'}</td>
          <td>${surname || 'N/A'}</td>
          <td>${email || 'N/A'}</td>
          <td>${phone_number_1 || 'N/A'}</td>
          <td>${phone_number_2 || 'N/A'}</td>
          <td>${whatsapp || 'N/A'}</td>
          <td>${school || 'N/A'}</td>
          <td>${pathway || 'N/A'}</td>
          <td>${program || 'N/A'}</td>
          <td>${level || 'N/A'}</td>
          <td class="text-center"><button class="action-btn view-btn" onclick="viewStudentDetail('${student_id}')" title="View Details"><i class="fas fa-eye"></i></button></td>
        `;
        tbody.appendChild(row);
        document.getElementById('allStudentsTable').style.display = 'table';
        filteredAllStudents = [student];
        currentAllStudentsPage = 1;
        updateAllStudentsPagination();
      } catch (e) {
        console.error('Search exception:', e);
        showToast('Error searching student', 'error');
        document.getElementById('allStudentsLoading').style.display = 'none';
      }
    }

    function searchAccountByIdFromInput() {
      const v = document.getElementById('studentSearchInput').value || '';
      searchAccountById(v.trim());
    }

    // Render all student_master_db table
    function renderAllStudentsTable() {
      const tbody = document.getElementById('allStudentsTableBody');
      tbody.innerHTML = '';

      const start = (currentAllStudentsPage - 1) * allStudentsItemsPerPage;
      const end = start + allStudentsItemsPerPage;
      const pageData = filteredAllStudents.slice(start, end);

      pageData.forEach(student => {
        const row = document.createElement('tr');
        
        // Extract fields from the mapped data
        const student_id = student.student_id || student.id || 'N/A';
        const first_name = student.first_name || '';
        const middle_name = student.middle_name || '';
        const surname = student.surname || '';
        const email = student.email || '';
        const phone_number_1 = student.phone_number_1 || '';
        const phone_number_2 = student.phone_number_2 || '';
        const whatsapp = student.whatsapp || '';
        const school = student.school || '';
        const pathway = student.pathway || '';
        const program = student.program || '';
        const level = student.level || '';

        row.innerHTML = `
          <td class="text-center">${student_id}</td>
          <td>${first_name || 'N/A'}</td>
          <td>${middle_name || 'N/A'}</td>
          <td>${surname || 'N/A'}</td>
          <td>${email || 'N/A'}</td>
          <td>${phone_number_1 || 'N/A'}</td>
          <td>${phone_number_2 || 'N/A'}</td>
          <td>${whatsapp || 'N/A'}</td>
          <td>${school || 'N/A'}</td>
          <td>${pathway || 'N/A'}</td>
          <td>${program || 'N/A'}</td>
          <td>${level || 'N/A'}</td>
          <td class="text-center">
            <button class="action-btn view-btn" onclick="viewStudentDetail('${student_id}')" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // View detailed student information (fetch fresh from DB and show all fields)
    async function viewStudentDetail(studentId) {
      try {
        // Fetch student from student_master_db and newstudents in parallel
        let studentRecord = null;
        
        const [studentsRes, newstudentsRes] = await Promise.all([
          window.__sb.from('student_master_db').select('*').eq('student_id', studentId).maybeSingle(),
          window.__sb.from('newstudents').select('*').eq('student_id', studentId).maybeSingle()
        ]);

        // Prefer students > newstudents
        if (studentsRes.data) {
          studentRecord = studentsRes.data;
          console.log('Student found in student_master_db table');
        } else if (newstudentsRes.data) {
          studentRecord = newstudentsRes.data;
          console.log('Student found in newstudents table');
        }

        if (!studentRecord) {
          console.log('Student not found in any table:', studentId);
          showToast('Student not found', 'error');
          return;
        }

        // Fetch payments for this student from BOTH tables
        const sid = studentRecord.student_id || studentRecord.id;
        const { data: level100Payments, error: error1 } = await window.__sb.from('level100payments').select('*').eq('student_id', sid);
        const { data: regularPayments, error: error2 } = await window.__sb.from('payments').select('*').eq('student_id', sid);
        
        if (error1) {
          console.error('Error loading level100payments:', error1);
        }
        if (error2) {
          console.error('Error loading payments:', error2);
        }

        // Combine payments from both sources
        const allPayments = [
          ...(level100Payments || []),
          ...(regularPayments || [])
        ];

        // Aggregate payments by type
        const paymentsByType = {};
        const paymentTypes = ['tuition_fees', 'src_dues', 'medical_dues', 'departmental_dues'];
        
        paymentTypes.forEach(type => {
          paymentsByType[type] = {
            requiredAmount: getRequiredAmount(type),
            amountPaid: 0,
            amountOwing: 0,
            paymentRecords: []
          };
        });

        // Populate with actual payment data
        allPayments.forEach(p => {
          const rawFeeType = p.payment_type || p.fee_type || 'Other';
          const normalizedType = String(rawFeeType).toLowerCase().replace(/\s+/g, '_');
          
          const matchingType = paymentTypes.find(t => 
            normalizedType.includes(t.replace(/_/g, '')) || 
            t.includes(normalizedType.replace(/_/g, ''))
          ) || normalizedType;

          if (paymentsByType[matchingType]) {
            paymentsByType[matchingType].amountPaid += Number(p.amount) || 0;
            paymentsByType[matchingType].paymentRecords.push(p);
          }
        });

        // Calculate totals
        let totalRequired = 0;
        let totalPaid = 0;
        let totalOwing = 0;
        
        Object.keys(paymentsByType).forEach(type => {
          const data = paymentsByType[type];
          data.amountOwing = Math.max(0, data.requiredAmount - data.amountPaid);
          totalRequired += data.requiredAmount;
          totalPaid += data.amountPaid;
          totalOwing += data.amountOwing;
        });

        // Eligibility: 80% or more of total required amount is paid
        const percentagePaid = totalRequired > 0 ? (totalPaid / totalRequired) * 100 : 0;
        const isEligible = percentagePaid >= 80;

        // Build detailed payment breakdown
        const paymentBreakdownHTML = Object.keys(paymentsByType).map(type => {
          const data = paymentsByType[type];
          const typeDisplay = type.replace(/_/g, ' ').toUpperCase();
          const isPaid = data.amountOwing === 0;
          
          return `
            <div style="margin-bottom: 15px; padding: 12px; background: #f9f9f9; border-radius: 6px; border-left: 4px solid ${isPaid ? '#28a745' : '#dc3545'};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="font-size: 14px;">${typeDisplay}</strong>
                <span class="status-badge status-${isPaid ? 'approved' : 'pending'}" style="font-size: 12px;">${isPaid ? '✓ PAID' : '✗ OWING'}</span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 13px;">
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Required</div>
                  <div style="font-weight: 600; color: #0066cc;">GHS ${data.requiredAmount.toFixed(2)}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Paid</div>
                  <div style="font-weight: 600; color: #28a745;">GHS ${data.amountPaid.toFixed(2)}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Owing</div>
                  <div style="font-weight: 600; color: ${data.amountOwing > 0 ? '#dc3545' : '#28a745'};">GHS ${data.amountOwing.toFixed(2)}</div>
                </div>
              </div>
              ${data.paymentRecords.length > 0 ? `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 12px;">
                  <strong>Payment Records:</strong>
                  <div style="max-height: 200px; overflow-y: auto;">
                    ${data.paymentRecords.map(p => `
                      <div style="margin-top: 5px; padding: 8px; background: white; border-radius: 4px;">
                        Amount: GHS ${(p.amount || 0).toFixed(2)} | Status: ${(p.status || 'pending').toUpperCase()} | Date: ${formatDate(p.created_at || p.payment_date)}
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        // Helper to format arbitrary field values
        function formatFieldValue(v) {
          if (v === null || v === undefined || v === '') return 'N/A';
          if (typeof v === 'string' && !isNaN(Date.parse(v))) return formatDate(v);
          if (typeof v === 'object') return JSON.stringify(v);
          return String(v);
        }

        // Helper to try multiple possible field names (fallbacks)
        function getField(obj, keys) {
          for (const k of keys) {
            if (obj[k] !== undefined && obj[k] !== null && obj[k] !== '') return obj[k];
          }
          return null;
        }

        const firstName = getField(studentRecord, ['first_name','firstname','fname','given_name']);
        const middleName = getField(studentRecord, ['middle_name','middlename','mname','othername']);
        const lastName = getField(studentRecord, ['surname','last_name','lastname','lname','family_name']);
        const emailVal = getField(studentRecord, ['email','email_address','emailAddress']);
        const phone1 = getField(studentRecord, ['phone_number','phone_number_1','phone','mobile','contact_phone']);
        const phone2 = getField(studentRecord, ['whatsapp_number','phone_number_2','alternate_phone']);
        const whatsapp = getField(studentRecord, ['whatsapp_number','whatsapp']);
        const schoolVal = getField(studentRecord, ['department','school','school_name','faculty','campus']);
        const pathwayVal = getField(studentRecord, ['pathway','pathway_name']);
        const programVal = getField(studentRecord, ['program','programme','course','course_name']);
        const levelVal = getField(studentRecord, ['level','current_level','year']);

        const detailsHTML = `
          <div style="display: flex; flex-direction: column; gap: 20px;">
            <!-- Header with Student ID and Name -->
            <div style="padding: 15px; background: linear-gradient(135deg, #0066cc 0%, #004499 100%); border-radius: 8px; color: white;">
              <h3 style="margin: 0 0 10px 0; font-size: 20px;">${(firstName || '') + (middleName ? ' ' + middleName : '') + (lastName ? ' ' + lastName : '')} </h3>
              <p style="margin: 5px 0; font-size: 14px;">Student ID: <strong>${studentRecord.student_id || studentRecord.id || 'N/A'}</strong></p>
            </div>

            <!-- Student Information Section -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
              <h4 style="margin: 0 0 15px 0; border-bottom: 2px solid #0066cc; padding-bottom: 10px;">Student Information</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Email</div>
                  <div style="font-weight: 500;">${emailVal || 'N/A'}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Phone 1</div>
                  <div style="font-weight: 500;">${phone1 || 'N/A'}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Phone 2</div>
                  <div style="font-weight: 500;">${phone2 || 'N/A'}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">WhatsApp</div>
                  <div style="font-weight: 500;">${whatsapp || 'N/A'}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">School</div>
                  <div style="font-weight: 500;">${schoolVal || 'N/A'}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Pathway</div>
                  <div style="font-weight: 500;">${pathwayVal || 'N/A'}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Program</div>
                  <div style="font-weight: 500;">${programVal || 'N/A'}</div>
                </div>
                <div>
                  <div style="color: #666; margin-bottom: 3px;">Level</div>
                  <div style="font-weight: 500;">${levelVal || 'N/A'}</div>
                </div>
              </div>
            </div>

            <!-- Overall Payment Summary -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">
              <div style="padding: 12px; background: white; border-radius: 6px; border: 2px solid #0066cc;">
                <div style="color: #666; font-size: 12px; margin-bottom: 5px;">Total Required</div>
                <div style="font-size: 18px; font-weight: 700; color: #0066cc;">GHS ${totalRequired.toFixed(2)}</div>
              </div>
              <div style="padding: 12px; background: white; border-radius: 6px; border: 2px solid #28a745;">
                <div style="color: #666; font-size: 12px; margin-bottom: 5px;">Total Paid</div>
                <div style="font-size: 18px; font-weight: 700; color: #28a745;">GHS ${totalPaid.toFixed(2)}</div>
              </div>
              <div style="padding: 12px; background: white; border-radius: 6px; border: 2px solid ${totalOwing > 0 ? '#dc3545' : '#28a745'};">
                <div style="color: #666; font-size: 12px; margin-bottom: 5px;">Total Owing</div>
                <div style="font-size: 18px; font-weight: 700; color: ${totalOwing > 0 ? '#dc3545' : '#28a745'};">GHS ${totalOwing.toFixed(2)}</div>
              </div>
              <div style="padding: 12px; background: ${isEligible ? '#d4edda' : '#f8d7da'}; border-radius: 6px; border: 2px solid ${isEligible ? '#28a745' : '#dc3545'};">
                <div style="color: #666; font-size: 12px; margin-bottom: 5px;">Status</div>
                <div style="font-size: 16px; font-weight: 700; color: ${isEligible ? '#28a745' : '#dc3545'};">${isEligible ? '✓ ELIGIBLE' : `${percentagePaid.toFixed(1)}% PAID`}</div>
              </div>
            </div>

            <!-- Payment Breakdown by Type -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
              <h4 style="margin: 0 0 15px 0; border-bottom: 2px solid #dc3545; padding-bottom: 10px;">Payment Breakdown by Type</h4>
              <div style="display: flex; flex-direction: column; gap: 12px;">
                ${paymentBreakdownHTML}
              </div>
            </div>

            <!-- Registration Eligibility Status -->
            <div style="padding: 15px; background: ${isEligible ? '#d4edda' : '#f8d7da'}; border-radius: 8px; border-left: 4px solid ${isEligible ? '#28a745' : '#dc3545'};">
              <div style="display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 16px; margin-bottom: 8px;">
                <span style="font-size: 24px;">${isEligible ? '✓' : '✗'}</span>
                <span style="color: ${isEligible ? '#155724' : '#721c24'};">Registration Eligibility: ${isEligible ? 'ELIGIBLE TO REGISTER' : `NOT ELIGIBLE - ${percentagePaid.toFixed(1)}% PAID (80% REQUIRED)`}</span>
              </div>
              <p style="margin: 0; font-size: 14px; color: ${isEligible ? '#155724' : '#721c24'};">
                ${isEligible 
                  ? 'This student has paid 80% or more and is eligible to register for courses.'
                  : `This student has paid ${percentagePaid.toFixed(1)}% (GHS ${totalPaid.toFixed(2)} of GHS ${totalRequired.toFixed(2)}). 80% payment is required to register.`
                }
              </p>
            </div>
          </div>
        `;

        showInfoModal(detailsHTML, 'Student Details');
      } catch (error) {
        console.error('Error viewing student detail:', error);
        showToast('Error loading student details', 'error');
      }
    }

    // Filter all students
    function filterAllStudents() {
      const schoolFilter = document.getElementById('studentSchoolFilter').value;
      const paymentStatusFilter = document.getElementById('studentPaymentStatusFilter').value;
      const courseFilter = document.getElementById('studentCourseFilter').value;

      filteredAllStudents = allStudents.filter(student => {
        let match = true;

        // School filter: normalize comparison to handle various formats
        if (schoolFilter) {
          const studentSchool = (student.school || student.school_name || student.department || '').toString().toUpperCase();
          const filterValue = schoolFilter.toUpperCase();
          
          // Map short codes to full names for comparison
          const schoolMap = {
            'MEDIA': ['MEDIA', 'MS'],
            'FASHION': ['FASHION', 'FH'],
            'CATERING': ['CATERING', 'CM'],
            'COSMETOLOGY': ['COSMETOLOGY', 'CT'],
            'TECHNOLOGY': ['TECHNOLOGY', 'TC', 'TK']
          };
          
          const acceptedValues = schoolMap[filterValue] || [filterValue];
          match = acceptedValues.some(val => studentSchool.includes(val));
        }

        // Payment status filter: fixed logic
        if (paymentStatusFilter) {
          if (paymentStatusFilter === 'paid') {
            match = match && student.totalOwing === 0;
          } else if (paymentStatusFilter === 'pending') {
            match = match && student.totalOwing > 0 && (!student.allPayments || student.allPayments.length === 0);
          } else if (paymentStatusFilter === 'owing') {
            match = match && student.totalOwing > 0;
          }
        }

        // Course type filter: handle flexible field names
        if (courseFilter) {
          const studentCourseType = (student.course_type || student.course_name || student.program_type || '').toString().trim();
          match = match && studentCourseType.toLowerCase() === courseFilter.toLowerCase();
        }

        return match;
      });

      currentAllStudentsPage = 1;
      renderAllStudentsTable();
      updateAllStudentsPagination();
    }

    // Reset all student filters
    function resetAllStudentFilters() {
      document.getElementById('studentSchoolFilter').value = '';
      document.getElementById('studentPaymentStatusFilter').value = '';
      document.getElementById('studentCourseFilter').value = '';
      filterAllStudents();
    }

    // Pagination for all students
    function changeAllStudentsPage(delta) {
      const totalPages = Math.ceil(filteredAllStudents.length / allStudentsItemsPerPage);
      const newPage = currentAllStudentsPage + delta;

      if (newPage >= 1 && newPage <= totalPages) {
        currentAllStudentsPage = newPage;
        renderAllStudentsTable();
        updateAllStudentsPagination();
      }
    }

    function updateAllStudentsPagination() {
      const totalPages = Math.ceil(filteredAllStudents.length / allStudentsItemsPerPage);
      const pageInfo = document.getElementById('allStudentsPageInfo');
      const pagination = document.getElementById('allStudentsPagination');

      if (totalPages > 1) {
        pagination.style.display = 'flex';
        pageInfo.textContent = `Page ${currentAllStudentsPage} of ${totalPages}`;
      } else {
        pagination.style.display = 'none';
      }
    }

    // Refresh all students
    function refreshAllStudents() {
      loadAllStudents();
    }

    // Export student data
    function exportStudentData(format) {
      const data = filteredAllStudents.map(student => {
        const fullName = (student.first_name || '') + ' ' + (student.last_name || '');
        return {
          'Student ID': student.student_id,
          'Full Name': fullName,
          'Email': student.email,
          'Phone': student.phone,
          'School': student.school,
          'Program': student.program,
          'Course Type': student.course_type,
          'Admission Fees Owing (₵)': student.paymentsByType['Admission Fees']?.owing || 0,
          'Tuition Fees Owing (₵)': student.paymentsByType['Tuition Fees']?.owing || 0,
          'Medical Dues Owing (₵)': student.paymentsByType['Medical Dues']?.owing || 0,
          'SRC Dues Owing (₵)': student.paymentsByType['SRC Dues']?.owing || 0,
          'Dept Dues Owing (₵)': student.paymentsByType['Dept Dues']?.owing || 0,
          'Total Owing (₵)': student.totalOwing,
          'Registration Status': student.isEligible ? 'ELIGIBLE' : 'OWING'
        };
      });

      if (format === 'csv') {
        exportToCSV(data);
      } else if (format === 'excel') {
        exportToExcel(data);
      }
    }

    // Initialize Dashboard
    document.addEventListener('DOMContentLoaded', function() {
      loadDashboard();
      setupNavigation();
      setupRealtime();
      
      // Load data
      refreshApplicants();
      updateAnalytics();
      
      // Set default dates for filters
      const today = new Date().toISOString().split('T')[0];
      const lastWeek = new Date();
      lastWeek.setDate(lastWeek.getDate() - 7);
      document.getElementById('filterDateFrom').value = lastWeek.toISOString().split('T')[0];
      document.getElementById('filterDateTo').value = today;
      
      // Search functionality
      document.getElementById('globalSearch').addEventListener('input', function(e) {
        searchApplicants(e.target.value);
      });
      // When admin presses Enter in the search box, try local cache first; if not found query DB for exact student_id
      document.getElementById('globalSearch').addEventListener('keydown', async function(e) {
        if (e.key === 'Enter') {
          const q = this.value.trim();
          if (!q) return;
          // Try to find exact student_id match (case-insensitive)
          const match = allApplicants.find(a => (a.student_id || '').toString().toLowerCase() === q.toLowerCase());
          if (match) {
            viewApplicant(match.student_id || match.id);
            return;
          }

          // Not in local cache: query Supabase for exact student_id
          try {
            const { data, error } = await window.__sb.from('newstudents').select('*').eq('student_id', q).maybeSingle();
            if (error) {
              console.error('Search query error:', error);
              showToast('Error searching student', 'error');
              return;
            }
            if (data) {
              viewApplicant(data.student_id || data.id);
            } else {
              showMessageModal('Student Not Found', `Student ID ${q} is not with us.`);
            }
          } catch (err) {
            console.error('Search exception:', err);
            showToast('Error searching student', 'error');
          }
        }
      });

      // Click handler for search icon: try local cache, else query Supabase for exact student_id
      const searchBtn = document.getElementById('globalSearchBtn');
      if (searchBtn) {
        searchBtn.addEventListener('click', async function () {
          const q = (document.getElementById('globalSearch').value || '').trim();
          if (!q) {
            showToast('Please enter a Student ID to search', 'info');
            return;
          }

          // First try local cache
          const match = allApplicants.find(a => (a.student_id || '').toString().toLowerCase() === q.toLowerCase());
          if (match) {
            viewApplicant(match.student_id || match.id);
            return;
          }

          // If not in cache, query Supabase for an exact student_id match
          try {
            const { data, error } = await window.__sb.from('newstudents').select('*').eq('student_id', q).maybeSingle();
            if (error) {
              console.error('Search query error:', error);
              showToast('Error searching student', 'error');
              return;
            }

            if (data) {
              viewApplicant(data.student_id || data.id);
            } else {
              showMessageModal('Student Not Found', `Student ID ${q} is not with us.`);
            }
          } catch (err) {
            console.error('Search exception:', err);
            showToast('Error searching student', 'error');
          }
        });
      }
    });

    // Navigation and Modal Functions
    function setupNavigation() {
      const navItems = document.querySelectorAll('.nav-item');
      
      navItems.forEach(item => {
        item.addEventListener('click', function() {
          navItems.forEach(nav => nav.classList.remove('active'));
          this.classList.add('active');
          
          // Update page title based on active nav
          const page = this.dataset.page;
          const titles = {
            dashboard: 'Dashboard Overview',
            applicants: 'Applicant Management',
            analytics: 'Analytics Dashboard',
            schools: 'School Statistics',
            reports: 'Report Generation',
            settings: 'System Settings',
            notifications: 'Notifications',
            help: 'Help & Support'
          };
          
          if (page !== 'dashboard') {
            document.getElementById('pageTitle').textContent = titles[page] || '';
            document.getElementById('pageSubtitle').textContent = getSubtitle(page);
          }
        });
      });
    }

    function showPage(pageId) {
      // Reset all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Activate dashboard nav
      document.querySelector('.nav-item[data-page="dashboard"]').classList.add('active');
      
      // Update title
      document.getElementById('pageTitle').textContent = 'Dashboard Overview';
      document.getElementById('pageSubtitle').textContent = 'Welcome back, Admin! Here\'s what\'s happening today.';
    }

    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      
      // Close any other open modals
      document.querySelectorAll('.modal.active').forEach(m => {
        m.classList.remove('active');
      });
      
      modal.classList.add('active');
      
      // Load specific data for modal
      if (modalId === 'applicantsModal') {
        refreshApplicants();
      } else if (modalId === 'analyticsModal') {
        updateAnalytics();
      } else if (modalId === 'schoolsModal') {
        loadSchoolStats();
      } else if (modalId === 'reportsModal') {
        loadReportHistory();
      } else if (modalId === 'notificationsModal') {
        loadNotifications();
      } else if (modalId === 'studentPaymentsModal') {
        loadStudentPayments();
      } else if (modalId === 'allStudentsModal') {
        loadAllStudents();
      }
    }

    // Backwards-compatible openModal helper (some code calls openModal)
    function openModal(modalId) {
      // Prefer showModal which does additional loading work
      if (typeof showModal === 'function') return showModal(modalId);
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.classList.add('active');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.classList.remove('active');
    }

    // Expose modal helpers on window to ensure inline `onclick` handlers can call them
    window.showModal = window.showModal || showModal;
    window.openModal = window.openModal || openModal;
    window.closeModal = window.closeModal || closeModal;

    function getSubtitle(page) {
      const subtitles = {
        dashboard: 'Welcome back, Admin! Here\'s what\'s happening today.',
        applicants: 'Manage and review all applicant submissions.',
        analytics: 'Detailed analytics and insights about admissions.',
        schools: 'School-wise statistics and performance metrics.',
        reports: 'Generate and download comprehensive reports.',
        settings: 'Configure system settings and preferences.',
        notifications: 'View and manage system notifications.',
        help: 'Get help and support for the admin dashboard.'
      };
      return subtitles[page] || '';
    }

    // Tab Switching Functions
    function switchAnalyticsTab(tabName) {
      // Update tabs
      document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show active tab
      event.target.classList.add('active');
      
      // Show corresponding content
      document.querySelectorAll('.analytics-tab').forEach(content => {
        content.style.display = 'none';
      });
      
      document.getElementById(`analytics${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'block';
    }

    function switchSettingsTab(tabName) {
      // Update tabs
      document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show active tab
      event.target.classList.add('active');
      
      // Show corresponding content
      document.querySelectorAll('.settings-tab').forEach(content => {
        content.style.display = 'none';
      });
      
      document.getElementById(`settings${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'block';
    }

    // Filter Functions
    function filterByStatus(status) {
      document.getElementById('filterStatus').value = status;
      showModal('applicantsModal');
      // filterApplicants will be called by refreshApplicants when data reloads
    }

    function filterBySchool(school) {
      // Set the school filter first so any subsequent reload preserves it
      document.getElementById('filterSchool').value = school;
      // Update applicants modal title to indicate active school filter
      const titleEl = document.getElementById('applicantsModalTitle');
      if (titleEl) titleEl.textContent = `Applicants — ${getSchoolName(school)}`;
      // Show a clear-filter button
      const clearBtn = document.getElementById('clearSchoolFilterBtn');
      if (clearBtn) clearBtn.style.display = 'inline-block';
      // Open the applicants modal (this triggers refreshApplicants which will call filterApplicants)
      showModal('applicantsModal');
    }

    function filterByCourse(course) {
      showModal('applicantsModal');
      document.getElementById('filterCourse').value = course;
      filterApplicants();
    }

    function filterByDate(range) {
      showModal('applicantsModal');
      const today = new Date();
      const fromDate = new Date();
      
      if (range === 'today') {
        fromDate.setDate(today.getDate() - 1);
      } else if (range === 'week') {
        fromDate.setDate(today.getDate() - 7);
      }
      
      document.getElementById('filterDateFrom').value = fromDate.toISOString().split('T')[0];
      document.getElementById('filterDateTo').value = today.toISOString().split('T')[0];
      filterApplicants();
    }

    // Load Dashboard Data
    async function loadDashboard() {
      try {
        // Load statistics
        const { data: applicants, error } = await window.__sb
          .from('newstudents')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allApplicants = applicants || [];
        filteredApplicants = [...allApplicants];
        // Attempt to auto-approve any pending applicants (no admin approval flow)
        await autoApprovePending();

        updateStats();
        initializeCharts();
      } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Error loading dashboard data', 'error');
      }
    }

    // Auto-approve pending applicants by updating DB and local cache
    async function autoApprovePending() {
      try {
        // Find pending or null-status applicants in local cache
        const pending = allApplicants.filter(a => !a.status || a.status === 'pending');
        if (!pending || pending.length === 0) return;

        const ids = pending.map(p => p.student_id).filter(Boolean);
        if (ids.length === 0) return;

        // Before attempting the update, ensure the 'status' column exists.
        // If the local cache has no 'status' property on rows, try a safe probe.
        const sampleHasStatus = allApplicants.some(a => Object.prototype.hasOwnProperty.call(a, 'status'));
        if (!sampleHasStatus) {
          try {
            // Probe the table for the 'status' column. This may return a PostgREST error
            // if the column truly doesn't exist; handle that and provide guidance.
            await window.__sb.from('newstudents').select('status', { head: true });
          } catch (probeErr) {
            console.warn('Auto-approve update error (status column probe):', probeErr);
            showToast('Auto-approve skipped: the `status` column is missing in `newstudents`.', 'error');
            console.info("To enable auto-approve, add a 'status' column to the 'newstudents' table, for example:\n\nALTER TABLE public.newstudents ADD COLUMN status text;\nUPDATE public.newstudents SET status = 'approved' WHERE status IS NULL OR status = 'pending';");
            return;
          }
        }

        // Perform a single update via Supabase: set status = 'approved' for matching student_ids
        const { data, error } = await window.__sb
          .from('newstudents')
          .update({ status: 'approved' })
          .in('student_id', ids);

        if (error) {
          console.warn('Auto-approve update error:', error);
          showToast('Auto-approve failed: DB update error. Check permissions and column existence.', 'error');
          return;
        }

        // Update local cache records to reflect approved status
        const updatedIds = new Set((data || []).map(d => d.student_id || d.id));
        allApplicants = allApplicants.map(a => updatedIds.has(a.student_id || a.id) ? ({ ...a, status: 'approved' }) : a);
        filteredApplicants = filteredApplicants.map(a => updatedIds.has(a.student_id || a.id) ? ({ ...a, status: 'approved' }) : a);

        updateStats();
        renderApplicantsTable();
        showToast(`Auto-approved ${updatedIds.size} applicant(s)`, 'info');
      } catch (err) {
        console.error('Error auto-approving applicants:', err);
      }
    }

    function updateStats() {
      const total = allApplicants.length;
      const pending = allApplicants.filter(a => a.status === 'pending' || !a.status).length;
      const approved = allApplicants.filter(a => a.status === 'approved').length;
      const rejected = allApplicants.filter(a => a.status === 'rejected').length;
      
      // Today's applications
      const today = new Date().toISOString().split('T')[0];
      const todayCount = allApplicants.filter(a => a.created_at?.split('T')[0] === today).length;
      
      // This week
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const weekCount = allApplicants.filter(a => new Date(a.created_at) > weekAgo).length;
      
      // Course types (robust matching: check course_type and program_applying_for, case-insensitive)
      const diplomaCount = allApplicants.filter(a => {
        const ct = (a.course_type || '').toString().toLowerCase();
        const prog = (a.program_applying_for || '').toString().toLowerCase();
        return ct.includes('diploma') || prog.includes('diploma');
      }).length;
      const iccCount = allApplicants.filter(a => {
        const ct = (a.course_type || '').toString().toLowerCase();
        const prog = (a.program_applying_for || '').toString().toLowerCase();
        return ct.includes('icc') || prog.includes('icc');
      }).length;
      
      // School counts
      const mediaCount = allApplicants.filter(a => a.school_selected === 'MEDIA').length;
      const fashionCount = allApplicants.filter(a => a.school_selected === 'FASHION').length;
      const cateringCount = allApplicants.filter(a => a.school_selected === 'CATERING').length;
      const cosmetologyCount = allApplicants.filter(a => a.school_selected === 'COSMETOLOGY').length;
      const technologyCount = allApplicants.filter(a => a.school_selected === 'TECHNOLOGY').length;
      
      // Update DOM - only update elements that exist
      const elementsToUpdate = {
        'totalApplicants': total,
        'todayApplicants': todayCount,
        'weekApplicants': weekCount,
        'diplomaCount': diplomaCount,
        'iccCount': iccCount,
        'mediaCount': mediaCount,
        'fashionCount': fashionCount,
        'cateringCount': cateringCount,
        'cosmetologyCount': cosmetologyCount,
        'technologyCount': technologyCount
      };
      
      Object.entries(elementsToUpdate).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = value;
        }
      });
      
      // Load paid applicants count
      loadPaidApplicantsCount();
    }

    // Load paid applicants count from admission_payments table
    async function loadPaidApplicantsCount() {
      try {
        // Fetch all successful payments from admission_payments table
        const { data: payments, error } = await window.__sb
          .from('admission_payments')
          .select('id, reference_code, payment_status')
          .eq('payment_status', 'success');

        if (error) {
          console.error('Error fetching payments:', error);
          const paidEl = document.getElementById('paidApplicants');
          if (paidEl) paidEl.textContent = '0';
          return;
        }

        // Count successful payments
        const successfulPayments = payments || [];
        
        // Update the paid applicants count in the UI
        const paidEl = document.getElementById('paidApplicants');
        if (paidEl) paidEl.textContent = successfulPayments.length;

        // If there are successful payments without reference_code, add the reference code
        const paymentsWithoutRef = successfulPayments.filter(p => !p.reference_code);
        
        if (paymentsWithoutRef.length > 0) {
          console.log(`Found ${paymentsWithoutRef.length} successful payments without reference_code`);
          
          // Update each payment that doesn't have a reference_code
          for (const payment of paymentsWithoutRef) {
            // Generate a unique reference code
            let refCode = generateReferenceCode();
            let attempts = 0;
            let updateSuccess = false;
            
            // Retry if duplicate reference code exists
            while (attempts < 5 && !updateSuccess) {
              try {
                const { error: updateError } = await window.__sb
                  .from('admission_payments')
                  .update({ reference_code: refCode })
                  .eq('id', payment.id);
                
                if (updateError) {
                  // If duplicate key error, generate a new reference code
                  if (updateError.code === '23505') {
                    refCode = generateReferenceCode();
                    attempts++;
                  } else {
                    console.warn(`Failed to update reference_code for payment ${payment.id}:`, updateError);
                    break;
                  }
                } else {
                  console.log(`Updated reference_code for payment ${payment.id}`);
                  updateSuccess = true;
                }
              } catch (err) {
                console.error(`Error updating reference code for payment ${payment.id}:`, err);
                break;
              }
            }
          }
        }

      } catch (error) {
        console.error('Error loading paid applicants count:', error);
        const paidEl = document.getElementById('paidApplicants');
        if (paidEl) paidEl.textContent = '0';
      }
    }

    // Generate a unique reference code
    function generateReferenceCode() {
      const timestamp = Date.now().toString(36).toUpperCase();
      const random = Math.random().toString(36).substring(2, 8).toUpperCase();
      return `REF-${timestamp}-${random}`;
    }

    // Store full paid applicants data for search
    let paidApplicantsData = [];

    // Load applicants who paid but don't have records in newstudents
    async function loadPaidWithoutRecords() {
      try {
        document.getElementById('paidNoRecordsLoading').style.display = 'flex';
        document.getElementById('paidNoRecordsTable').style.display = 'none';

        // Fetch all successful payments
  const { data: payments, error: payError } = await window.__sb
    .from('admission_payments')
          .select('*')
          .eq('payment_status', 'success')
          .order('created_at', { ascending: false });

        if (payError) {
          console.error('Error fetching payments:', payError);
          document.getElementById('paidNoRecordsLoading').style.display = 'none';
          showToast('Error loading payment records', 'error');
          return;
        }

        // Get all students from newstudents table with full details
        const { data: students, error: studError } = await window.__sb
          .from('newstudents')
          .select('student_id, first_name, last_name, email, phone_number');

        if (studError) {
          console.error('Error fetching students:', studError);
          document.getElementById('paidNoRecordsLoading').style.display = 'none';
          showToast('Error loading student records', 'error');
          return;
        }

        // Create maps for student lookup
        const studentMap = {};
        const existingStudentIds = new Set();
        
        (students || []).forEach(student => {
          if (student.student_id) {
            existingStudentIds.add(student.student_id);
            studentMap[student.student_id] = student;
          }
        });

        // Filter payments where the email/contact is not in newstudents
        // Also enrich with student details
        paidApplicantsData = (payments || [])
          .filter(payment => {
            if (payment.student_id) {
              return !existingStudentIds.has(payment.student_id);
            }
            return true;
          })
          .map(payment => {
            const student = payment.student_id ? studentMap[payment.student_id] : null;
            return {
              ...payment,
              studentName: student ? `${student.first_name || ''} ${student.last_name || ''}`.trim() : 'N/A',
              studentId: payment.student_id || 'N/A'
            };
          });

        // Render the table with all data
        renderPaidApplicantsTable(paidApplicantsData);

        document.getElementById('paidNoRecordsLoading').style.display = 'none';
        document.getElementById('paidNoRecordsTable').style.display = 'table';

        showToast(`Found ${paidApplicantsData.length} paid applicants without student records`, 'info');

      } catch (error) {
        console.error('Error loading paid without records:', error);
        document.getElementById('paidNoRecordsLoading').style.display = 'none';
        showToast('Error loading data', 'error');
      }
    }

    // Render paid applicants table
    function renderPaidApplicantsTable(data) {
      const tbody = document.getElementById('paidNoRecordsTableBody');
      tbody.innerHTML = '';

      data.forEach(payment => {
        const row = document.createElement('tr');
        const paymentDate = payment.created_at ? formatDate(payment.created_at) : 'N/A';
        const amount = payment.amount || payment.total || 'N/A';
        
        row.innerHTML = `
          <td>${payment.reference_code || 'N/A'}</td>
          <td>${payment.studentName || 'N/A'}</td>
          <td>${payment.studentId || 'N/A'}</td>
          <td><span class="status-badge status-approved">${payment.payment_status || 'N/A'}</span></td>
          <td>${paymentDate}</td>
          <td>${amount}</td>
          <td>
            <div class="action-buttons">
              <div class="action-btn view-btn" onclick="viewFormPurchaseDetail('${payment.id || ''}')">
                <i class="fas fa-eye"></i>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Show paid applicants UI and load data
    function showPaidApplicantsUI() {
      document.getElementById('paidSearchSection').style.display = 'flex';
      document.getElementById('paidApplicantSearch').value = '';
      document.getElementById('showAllPaidBtn').style.display = 'none';
      document.getElementById('showLessPaidBtn').style.display = 'inline-block';
      loadPaidWithoutRecords();
    }

    // Hide paid applicants UI
    function showLessPaidApplicantsUI() {
      document.getElementById('paidSearchSection').style.display = 'none';
      document.getElementById('paidNoRecordsTable').style.display = 'none';
      document.getElementById('paidNoRecordsLoading').style.display = 'none';
      document.getElementById('paidApplicantSearch').value = '';
      document.getElementById('showAllPaidBtn').style.display = 'inline-block';
      document.getElementById('showLessPaidBtn').style.display = 'none';
    }

    // Search paid applicants by name or student ID
    function searchPaidApplicants() {
      const searchValue = document.getElementById('paidApplicantSearch').value.toLowerCase().trim();
      
      if (!searchValue) {
        renderPaidApplicantsTable(paidApplicantsData);
        return;
      }

      const filtered = paidApplicantsData.filter(payment => {
        const name = (payment.studentName || '').toLowerCase();
        const studentId = (payment.studentId || '').toLowerCase();
        return name.includes(searchValue) || studentId.includes(searchValue);
      });

      renderPaidApplicantsTable(filtered);
    }

    // Clear paid applicants search
    function clearPaidSearch() {
      document.getElementById('paidApplicantSearch').value = '';
      renderPaidApplicantsTable(paidApplicantsData);
    }

    // Refresh paid without records table
    function refreshPaidWithoutRecords() {
      if (document.getElementById('paidSearchSection').style.display === 'flex') {
        loadPaidWithoutRecords();
      }
    }

    // View payment detail
    async function viewPaymentDetail(paymentId) {
      try {
    const { data: payment, error } = await window.__sb
      .from('admission_payments')
      .select('*')
      .eq('id', paymentId)
          .single();

        if (error) {
          showToast('Error loading payment details', 'error');
          return;
        }

        const html = `
          <div style="display:flex; flex-direction:column; gap:15px;">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Reference Code</div>
                <div class="info-value">${payment.reference_code || 'N/A'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Payment Status</div>
                <div class="info-value">${payment.payment_status || 'N/A'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Amount</div>
                <div class="info-value">${payment.amount || payment.total || 'N/A'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Payment Date</div>
                <div class="info-value">${formatDate(payment.created_at) || 'N/A'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">${payment.email || payment.customer_email || 'N/A'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Phone</div>
                <div class="info-value">${payment.phone || payment.customer_phone || 'N/A'}</div>
              </div>
            </div>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
              <strong>Note:</strong> This applicant has paid for the admission form but does not have a student record in the system. 
              They may need to complete their application form registration.
            </div>
          </div>
        `;

        showInfoModal(html, 'Payment Details');
      } catch (error) {
        console.error('Error viewing payment detail:', error);
        showToast('Error loading payment details', 'error');
      }
    }

    // View form purchase details in dedicated modal
    async function viewFormPurchaseDetail(paymentId) {
      try {
        document.getElementById('formPurchaseLoading').style.display = 'flex';
        document.getElementById('formPurchaseContent').style.display = 'none';
        
        openModal('formPurchaseModal');

const { data: payment, error } = await window.__sb
  .from('admission_payments')
  .select('*')
          .eq('id', paymentId)
          .single();

        if (error) {
          showToast('Error loading payment details', 'error');
          document.getElementById('formPurchaseLoading').style.display = 'none';
          return;
        }

        // Populate all fields using correct database column names
        document.getElementById('fpRefCode').textContent = payment.reference_code || 'N/A';
        document.getElementById('fpPaymentStatus').textContent = payment.payment_status || 'N/A';
        document.getElementById('fpAmount').textContent = (payment.amount || 'N/A') + ' ' + (payment.currency || 'GHS');
        document.getElementById('fpPaymentDate').textContent = formatDate(payment.created_at) || 'N/A';
        document.getElementById('fpEmail').textContent = payment.email || 'N/A';
        document.getElementById('fpPhone').textContent = payment.phone || 'N/A';
        document.getElementById('fpCustomerName').textContent = `${payment.first_name || ''} ${payment.last_name || ''}`.trim() || 'N/A';
        document.getElementById('fpTransactionId').textContent = payment.paystack_transaction_id || 'N/A';
        document.getElementById('fpPaymentMethod').textContent = 'Paystack';
        document.getElementById('fpCurrency').textContent = payment.currency || 'GHS';
        document.getElementById('fpCreatedAt').textContent = formatDate(payment.created_at) || 'N/A';
        document.getElementById('fpUpdatedAt').textContent = formatDate(payment.updated_at) || 'N/A';
        
        // Metadata
        const paymentRef = payment.payment_reference || 'N/A';
        const metadata = `Payment Reference: ${paymentRef}`;
        document.getElementById('fpMetadata').textContent = metadata;

        // Status note
        const statusNote = document.getElementById('fpStatusNote');
        if (payment.payment_status === 'success') {
          statusNote.innerHTML = `<span style="color: var(--success); font-weight: 600;">✓ Payment successful</span> - This applicant has paid for the admission form. Reference code: <strong>${payment.reference_code || 'N/A'}</strong>`;
        } else if (payment.payment_status === 'pending') {
          statusNote.innerHTML = `<span style="color: var(--warning); font-weight: 600;">⏳ Payment pending</span> - The payment is still being processed.`;
        } else if (payment.payment_status === 'failed') {
          statusNote.innerHTML = `<span style="color: var(--danger); font-weight: 600;">✗ Payment failed</span> - The payment transaction was not successful.`;
        } else {
          statusNote.innerHTML = `Status: <strong>${payment.payment_status || 'Unknown'}</strong>`;
        }

        document.getElementById('formPurchaseLoading').style.display = 'none';
        document.getElementById('formPurchaseContent').style.display = 'block';

      } catch (error) {
        console.error('Error viewing form purchase detail:', error);
        showToast('Error loading payment details', 'error');
        document.getElementById('formPurchaseLoading').style.display = 'none';
      }
    }

    function loadRecentApplicants() {
      const recent = allApplicants.slice(0, 5);
      const tbody = document.getElementById('recentTableBody');
      tbody.innerHTML = '';
      
      recent.forEach(applicant => {
        const row = document.createElement('tr');
        const status = applicant.status || 'pending';
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);
        
        row.innerHTML = `
          <td>${applicant.student_id || 'N/A'}</td>
          <td>${applicant.first_name} ${applicant.last_name}</td>
          <td><span class="school-badge" style="background:${getSchoolColor(applicant.school_selected)}"></span>${getSchoolName(applicant.school_selected)}</td>
          <td>${applicant.program_applying_for || 'N/A'}</td>
          <td>${formatDate(applicant.created_at)}</td>
          <td><span class="status-badge status-${status}">${statusText}</span></td>
          <td>
            <div style="margin-top: 30px; display: flex; gap: 10px; align-items: center;">
              <button class="btn btn-primary" onclick="sendSMSToApplicant('${applicant.student_id}')">
                <i class="fas fa-sms"></i> Send SMS
              </button>
            </div>
            <div class="modal-footer" style="display:none;" id="applicantModalFooter">
              <div style="flex:1"></div>
              <button id="applicantSaveFooterBtn" class="btn btn-success" style="display:none;" onclick="saveApplicantUpdates()"><i class="fas fa-save"></i> Update</button>
              <button id="applicantCancelFooterBtn" class="btn btn-outline" style="display:none;" onclick="cancelEditMode()">Cancel</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('recentLoading').style.display = 'none';
      document.getElementById('recentTable').style.display = 'table';
    }

    function getSchoolName(code) {
      const schools = {
        'MEDIA': 'GH Media School',
        'FASHION': 'GH Fashion School',
        'CATERING': 'GH Catering School',
        'COSMETOLOGY': 'GH Cosmetology School',
        'TECHNOLOGY': 'GH Technology School'
      };
      return schools[code] || code;
    }

    function getSchoolColor(code) {
      // Mapping as requested:
      // Media -> red, Technology -> violet, Catering -> yellow, Cosmetology -> orange, Fashion -> blue
      const colors = {
        'MEDIA': '#e74c3c',       // red
        'TECHNOLOGY': '#6a11cb',  // violet
        'CATERING': '#f1c40f',    // yellow
        'COSMETOLOGY': '#f19d01', // orange
        'FASHION': '#2575fc'      // blue
      };
      return colors[code] || '#6c757d';
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // Store full recent applications data for search
    let recentApplicationsData = [];

    // Show recent applications UI and load data
    function showRecentApplicationsUI() {
      document.getElementById('recentSearchSection').style.display = 'flex';
      document.getElementById('recentApplicationSearch').value = '';
      document.getElementById('showAllRecentBtn').style.display = 'none';
      document.getElementById('showLessRecentBtn').style.display = 'inline-block';
      loadRecentApplicationsWithSearch();
    }

    // Hide recent applications UI
    function showLessRecentApplicationsUI() {
      document.getElementById('recentSearchSection').style.display = 'none';
      document.getElementById('recentTable').style.display = 'none';
      document.getElementById('recentLoading').style.display = 'none';
      document.getElementById('recentApplicationSearch').value = '';
      document.getElementById('showAllRecentBtn').style.display = 'inline-block';
      document.getElementById('showLessRecentBtn').style.display = 'none';
    }

    // Load all recent applications for search
    function loadRecentApplicationsWithSearch() {
      if (!allApplicants || allApplicants.length === 0) {
        refreshApplicants();
        return;
      }
      recentApplicationsData = allApplicants;
      renderRecentApplicationsTable(recentApplicationsData);
      document.getElementById('recentLoading').style.display = 'none';
      document.getElementById('recentTable').style.display = 'table';
    }

    // Render recent applications table
    function renderRecentApplicationsTable(data) {
      const tbody = document.getElementById('recentTableBody');
      tbody.innerHTML = '';

      (data || []).forEach(applicant => {
        const row = document.createElement('tr');
        const status = applicant.status || 'pending';
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);
        
        row.innerHTML = `
          <td>${applicant.student_id || 'N/A'}</td>
          <td>${applicant.first_name} ${applicant.last_name}</td>
          <td>${applicant.email || 'N/A'}</td>
          <td><span class="school-badge" style="background:${getSchoolColor(applicant.school_selected)}"></span>${getSchoolName(applicant.school_selected)}</td>
          <td>${applicant.program_applying_for || 'N/A'}</td>
          <td>${formatDate(applicant.created_at)}</td>
          <td><span class="status-badge status-${status}">${statusText}</span></td>
          <td>
            <div style="margin-top: 30px; display: flex; gap: 10px; align-items: center;">
              <button class="btn btn-primary" onclick="sendSMSToApplicant('${applicant.student_id}')">
                <i class="fas fa-sms"></i> Send SMS
              </button>
            </div>
            <div class="modal-footer" style="display:none;" id="applicantModalFooter">
              <div style="flex:1"></div>
              <button id="applicantSaveFooterBtn" class="btn btn-success" style="display:none;" onclick="saveApplicantUpdates()"><i class="fas fa-save"></i> Update</button>
              <button id="applicantCancelFooterBtn" class="btn btn-outline" style="display:none;" onclick="cancelEditMode()">Cancel</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Search recent applications by name or email
    function searchRecentApplications() {
      const searchValue = document.getElementById('recentApplicationSearch').value.toLowerCase().trim();
      
      if (!searchValue) {
        renderRecentApplicationsTable(recentApplicationsData);
        return;
      }

      const filtered = recentApplicationsData.filter(applicant => {
        const name = `${applicant.first_name} ${applicant.last_name}`.toLowerCase();
        const email = (applicant.email || '').toLowerCase();
        return name.includes(searchValue) || email.includes(searchValue);
      });

      renderRecentApplicationsTable(filtered);
    }

    // Clear recent applications search
    function clearRecentSearch() {
      document.getElementById('recentApplicationSearch').value = '';
      renderRecentApplicationsTable(recentApplicationsData);
    }

    // Initialize Charts
    function initializeCharts() {
      // Timeline Chart
      const timelineCtx = document.getElementById('timelineChart').getContext('2d');
      const timelineData = getLast7DaysData();
      
      charts.timeline = new Chart(timelineCtx, {
        type: 'line',
        data: {
          labels: timelineData.labels,
          datasets: [{
            label: 'Applications',
            data: timelineData.data,
            borderColor: 'rgb(37, 117, 252)',
            backgroundColor: 'rgba(37, 117, 252, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });

      // School Distribution Chart
      const schoolCtx = document.getElementById('schoolChart').getContext('2d');
      const schoolData = getSchoolDistribution();
      // Use the same canonical school codes order as getSchoolDistribution
      const schoolCodes = ['MEDIA', 'FASHION', 'CATERING', 'COSMETOLOGY', 'TECHNOLOGY'];
      const schoolColors = schoolCodes.map(getSchoolColor);
      
      charts.school = new Chart(schoolCtx, {
        type: 'doughnut',
        data: {
          labels: schoolData.labels,
          datasets: [{
            data: schoolData.data,
            backgroundColor: schoolColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function getLast7DaysData() {
      const data = [];
      const labels = [];
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        
        const count = allApplicants.filter(a => {
          const appDate = new Date(a.created_at).toISOString().split('T')[0];
          return appDate === dateStr;
        }).length;
        
        data.push(count);
      }
      
      return { labels, data };
    }

    function getSchoolDistribution() {
      const schools = ['MEDIA', 'FASHION', 'CATERING', 'COSMETOLOGY', 'TECHNOLOGY'];
      const labels = schools.map(getSchoolName);
      const data = schools.map(school => 
        allApplicants.filter(a => a.school_selected === school).length
      );
      
      return { labels, data };
    }

    // Applicant Management
    async function refreshApplicants() {
      try {
        document.getElementById('applicantsLoading').style.display = 'flex';
        document.getElementById('applicantsTable').style.display = 'none';
        
        const { data: applicants, error } = await window.__sb
          .from('newstudents')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allApplicants = applicants || [];
        // Update stats based on fresh data
        updateStats();
        // Apply current filters (so calling code like filterBySchool preserves its selection)
        filterApplicants();
        
        document.getElementById('applicantsLoading').style.display = 'none';
        document.getElementById('applicantsTable').style.display = 'table';
        document.getElementById('pagination').style.display = 'flex';
        
        showToast('Applicants data refreshed successfully');
      } catch (error) {
        console.error('Error refreshing applicants:', error);
        showToast('Error refreshing applicants data', 'error');
      }
    }

    function filterApplicants() {
      const status = document.getElementById('filterStatus').value;
      const school = document.getElementById('filterSchool').value;
      const course = document.getElementById('filterCourse').value;
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;

      filteredApplicants = allApplicants.filter(applicant => {
        // Status filter
        if (status && applicant.status !== status) return false;
        
        // School filter
        if (school && applicant.school_selected !== school) return false;
        
        // Course type filter
        if (course && applicant.course_type !== course) return false;
        
        // Date range filter
        if (dateFrom || dateTo) {
          const appDate = new Date(applicant.created_at).toISOString().split('T')[0];
          if (dateFrom && appDate < dateFrom) return false;
          if (dateTo && appDate > dateTo) return false;
        }
        
        return true;
      });

      currentPage = 1;
      renderApplicantsTable();
      updatePagination();
    }

    function searchApplicants(query) {
      if (!query.trim()) {
        filteredApplicants = [...allApplicants];
      } else {
        const searchTerm = query.toLowerCase();
        filteredApplicants = allApplicants.filter(applicant => {
          return (
            (applicant.first_name + ' ' + applicant.last_name).toLowerCase().includes(searchTerm) ||
            (applicant.email || '').toLowerCase().includes(searchTerm) ||
            (applicant.phone_number || '').includes(searchTerm) ||
            (applicant.student_id || '').toLowerCase().includes(searchTerm)
          );
        });
      }
      
      currentPage = 1;
      renderApplicantsTable();
      updatePagination();
    }

    function renderApplicantsTable() {
      const tbody = document.getElementById('applicantsTableBody');
      tbody.innerHTML = '';
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageApplicants = filteredApplicants.slice(start, end);
      
      pageApplicants.forEach(applicant => {
        const row = document.createElement('tr');
        const status = applicant.status || 'pending';
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);
        
        const dob = applicant.date_of_birth || applicant.dob || 'N/A';
        const gender = applicant.gender || 'N/A';
        const nationality = applicant.nationality || 'N/A';
        const address = (applicant.address || applicant.home_address || applicant.residence || 'N/A');
        const wassce = applicant.wassce_core_score || 'N/A';
        const sponsor = applicant.sponsor_name || 'N/A';
        const sponsorPhone = applicant.sponsor_phone || applicant.sponsor_phone_number || 'N/A';
        const passportUrl = applicant.passport_photo_url || applicant.passport || applicant.photo_url || null;
        const resultsUrl = applicant.wassce_results_url || applicant.results_url || applicant.results_file_url || null;

        // Truncate address for table readability
        const shortAddress = address && address !== 'N/A' ? (address.length > 40 ? address.slice(0, 40) + '...' : address) : 'N/A';

        const passportHtml = passportUrl ? `<div class="passport-frame" style="width:48px;height:56px;padding:3px;"><img src="${passportUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;" /></div>` : '—';
        const resultsHtml = resultsUrl ? `<a href="${resultsUrl}" target="_blank">View</a>` : '—';

        row.innerHTML = `
          <td><input type="checkbox" class="applicant-checkbox" value="${applicant.student_id}"></td>
          <td>${applicant.student_id || 'N/A'}</td>
          <td>${escapeHtml((applicant.first_name || '') + ' ' + (applicant.last_name || '')).trim() || 'N/A'}</td>
          <td>${applicant.email || 'N/A'}</td>
          <td>${applicant.phone_number || 'N/A'}</td>
          <td>${dob}</td>
          <td>${gender}</td>
          <td>${nationality}</td>
          <td title="${escapeHtml(address)}">${escapeHtml(shortAddress)}</td>
          <td>${getSchoolName(applicant.school_selected)}</td>
          <td>${escapeHtml(applicant.program_applying_for || 'N/A')}</td>
          <td>${escapeHtml(applicant.course_type || 'N/A')}</td>
          <td>${wassce}</td>
          <td>${escapeHtml(sponsor)}</td>
          <td>${escapeHtml(sponsorPhone)}</td>
          <td>${passportHtml}</td>
          <td>${resultsHtml}</td>
          <td>${formatDate(applicant.created_at)}</td>
          <td><span class="status-badge status-${status}">${statusText}</span></td>
          <td>
            <div class="action-buttons">
              <div class="action-btn view-btn" onclick="viewApplicant('${applicant.student_id}')">
                <i class="fas fa-eye"></i>
              </div>
              <div class="action-btn" title="View DB Record" onclick="viewRawRecord('${applicant.student_id}')">
                <i class="fas fa-database"></i>
              </div>
              <div class="action-btn edit-btn" onclick="editApplicant('${applicant.student_id}')">
                <i class="fas fa-edit"></i>
              </div>
              <div class="action-btn delete-btn" onclick="deleteApplicant('${applicant.student_id}')">
                <i class="fas fa-trash"></i>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function toggleSelectAll() {
      const checkAll = document.getElementById('selectAll').checked;
      const checkboxes = document.querySelectorAll('.applicant-checkbox');
      checkboxes.forEach(cb => cb.checked = checkAll);
    }

    function bulkApprove() {
      // Bulk approve removed.
      return;
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredApplicants.length / itemsPerPage);
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    }

    function changePage(delta) {
      const totalPages = Math.ceil(filteredApplicants.length / itemsPerPage);
      const newPage = currentPage + delta;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderApplicantsTable();
        updatePagination();
      }
    }

    function clearSchoolFilter() {
      const filterEl = document.getElementById('filterSchool');
      if (filterEl) filterEl.value = '';
      const titleEl = document.getElementById('applicantsModalTitle');
      if (titleEl) titleEl.textContent = 'Applicant Management';
      const clearBtn = document.getElementById('clearSchoolFilterBtn');
      if (clearBtn) clearBtn.style.display = 'none';
      filterApplicants();
    }

    // Applicant Actions
    async function viewApplicant(studentId) {
      currentApplicantId = studentId;
      
      const modal = document.getElementById('applicantModal');
      const loading = document.getElementById('applicantDetailLoading');
      const content = document.getElementById('applicantDetailContent');
      
      // Open modal via helper for consistency
      openModal('applicantModal');
      loading.style.display = 'flex';
      content.style.display = 'none';
      
      try {
        const { data: applicant, error } = await window.__sb
          .from('newstudents')
          .select('*')
          .eq('student_id', studentId)
          .single();

        if (error) throw error;

        // Populate modal
        document.getElementById('detailId').textContent = applicant.student_id || 'N/A';
        const baseFullName = `${applicant.first_name || ''} ${applicant.middle_name || ''} ${applicant.last_name || ''}`.trim();

        document.getElementById('detailEmail').textContent = applicant.email || 'N/A';
        document.getElementById('detailPhone').textContent = applicant.phone_number || applicant.phone || 'N/A';
        document.getElementById('detailSchool').innerHTML = `<span class="school-badge" style="background:${getSchoolColor(applicant.school_selected)}"></span>${getSchoolName(applicant.school_selected) || applicant.school || 'N/A'}`;
        document.getElementById('detailProgram').textContent = applicant.program_applying_for || applicant.program || 'N/A';

        // Display full name using first/middle/last components (ignore separate full_name/firstname/othername/lastname fields)
        document.getElementById('detailName').textContent = baseFullName || 'N/A';
        const displayFullName = baseFullName;
        const modalTitle = document.querySelector('#applicantModal .modal-title');
        if (modalTitle) modalTitle.textContent = displayFullName ? `${displayFullName} — Details` : 'Applicant Details';
        // New fields (best-effort from common property names)
        document.getElementById('detailDepartment').textContent = applicant.department || applicant.department_selected || applicant.program_department || 'N/A';
        document.getElementById('detailLevel').textContent = applicant.level || applicant.current_level || applicant.student_level || 'N/A';
        document.getElementById('detailGender').textContent = applicant.gender || 'N/A';
        document.getElementById('detailDOB').textContent = applicant.date_of_birth || applicant.dob || 'N/A';
        document.getElementById('detailAddress').textContent = applicant.address || applicant.residence || 'N/A';
        document.getElementById('detailNationality').textContent = applicant.nationality || 'N/A';

        document.getElementById('detailCourse').textContent = applicant.course_type || 'N/A';
        document.getElementById('detailDate').textContent = formatDate(applicant.created_at);
        document.getElementById('detailUpdatedAt').textContent = applicant.updated_at ? formatDate(applicant.updated_at) : 'N/A';
        document.getElementById('detailScore').textContent = applicant.wassce_core_score || 'N/A';
        // Passport photo (try several common field names)
        const passportImg = document.getElementById('detailPassport');
        const passportFrame = document.getElementById('detailPassportFrame');
        const wassceLinkEl = document.getElementById('detailWassceLink');
        const photoUrl = applicant.passport_photo_url || applicant.passport || applicant.photo_url || applicant.photo || applicant.avatar_url || null;
        if (passportImg) {
          passportImg.src = photoUrl || '';
        }
        if (passportFrame) {
          passportFrame.style.display = photoUrl ? 'inline-block' : 'none';
        }
        // WASSCE results file/link
        if (wassceLinkEl) {
          const resultsUrl = applicant.wassce_results_url || applicant.results_url || applicant.results_file_url || applicant.results || null;
          if (resultsUrl) {
            wassceLinkEl.href = resultsUrl;
            wassceLinkEl.style.display = 'inline-block';
          } else {
            wassceLinkEl.href = '#';
            wassceLinkEl.style.display = 'none';
          }
        }
        // Show status as read-only because admin approvals are disabled
        const statusDisplay = document.getElementById('detailStatusDisplay');
        if (statusDisplay) statusDisplay.textContent = (applicant.status || 'pending').toString();
        document.getElementById('detailEnglish').textContent = applicant.english_grade || 'N/A';
        document.getElementById('detailMath').textContent = applicant.mathematics_grade || 'N/A';
        document.getElementById('detailSocial').textContent = applicant.social_studies_grade || 'N/A';
        document.getElementById('detailScience').textContent = applicant.integrated_science_grade || 'N/A';
        document.getElementById('detailSponsor').textContent = applicant.sponsor_name || 'N/A';
        document.getElementById('detailRelationship').textContent = applicant.sponsor_relationship || 'N/A';
        document.getElementById('detailSponsorPhone').textContent = applicant.sponsor_phone || 'N/A';
        
        loading.style.display = 'none';
        content.style.display = 'block';
        // store fetched applicant for editing
        window._currentApplicant = applicant;
        // ensure edit buttons are reset
        document.getElementById('applicantEditBtn').style.display = 'inline-flex';
        document.getElementById('applicantSaveBtn').style.display = 'none';
        document.getElementById('applicantCancelBtn').style.display = 'none';
        const footer = document.getElementById('applicantModalFooter');
        if (footer) footer.style.display = 'none';
      } catch (error) {
        console.error('Error loading applicant details:', error);
        showToast('Error loading applicant details', 'error');
        closeModal('applicantModal');
      }
    }

    // Ordered list of DB fields to display exactly as in the database
    const dbFieldOrder = [
      'student_id','first_name','middle_name','last_name','dob','gender','phone_number','email','home_address','nationality','national_id_type','national_id_number','present_job','language_spoken','region','current_residence','hostel_preference','any_medical','medical_spec','disability_spec','heard_source','heard_spec','sponsor_name','sponsor_relationship','sponsor_occupation','sponsor_address','sponsor_phone','school_name','school_location','school_year','school_qualification','school_selected','program_applying_for','program_duration','course_type','passport_photo_url','wassce_results_url','english_grade','mathematics_grade','social_studies_grade','integrated_science_grade','wassce_core_score','wassce_core_average','updated_at','status','address','date_of_birth','department','level'
    ];

    async function viewRawRecord(studentId) {
      try {
        let record = allApplicants && allApplicants.find(a => a.student_id === studentId);
        if (!record) {
          const { data, error } = await window.__sb.from('newstudents').select('*').eq('student_id', studentId).single();
          if (error) throw error;
          record = data;
        }

        if (!record) {
          alert('Record not found');
          return;
        }

        let rows = '';
        for (const key of dbFieldOrder) {
          let val = record[key];
          if (val === null || typeof val === 'undefined' || val === '') val = 'NULL';
          else if (typeof val === 'object') val = JSON.stringify(val);
          else val = String(val);
          val = escapeHtml(val);
          rows += `<tr><td style="padding:8px;border-bottom:1px solid #eee;font-weight:600">${escapeHtml(key)}</td><td style="padding:8px;border-bottom:1px solid #eee">${val}</td></tr>`;
        }

        const html = `
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;gap:8px;align-items:center;">
              <strong>DB Record for</strong>
              <code style="background:#f3f3f3;padding:4px 8px;border-radius:4px;margin-left:6px">${escapeHtml(studentId)}</code>
              <button class="btn" style="margin-left:auto" onclick="downloadRecordAsJSON('${escapeHtml(studentId)}')">Download JSON</button>
            </div>
            <div style="max-height:420px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px;background:#fff">
              <table style="width:100%;border-collapse:collapse">${rows}</table>
            </div>
          </div>`;

        showInfoModal(html);
      } catch (err) {
        console.error('viewRawRecord error', err);
        alert('Unable to load DB record: ' + (err.message || err));
      }
    }

    function downloadRecordAsJSON(studentId) {
      const rec = allApplicants && allApplicants.find(a => a.student_id === studentId);
      if (!rec) {
        window.__sb.from('newstudents').select('*').eq('student_id', studentId).single().then(r => {
          if (r.error) return alert('Unable to fetch record: ' + r.error.message);
          const blob = new Blob([JSON.stringify(r.data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = `${studentId}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });
        return;
      }
      const blob = new Blob([JSON.stringify(rec, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${studentId}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Enter edit mode: replace info-value elements with inputs
    function enterEditMode() {
      const modal = document.getElementById('applicantModal');
      if (!modal) return;
      const footer = document.getElementById('applicantModalFooter');
      if (footer) footer.style.display = 'flex';
      document.getElementById('applicantEditBtn').style.display = 'none';
      document.getElementById('applicantSaveBtn').style.display = 'inline-flex';
      document.getElementById('applicantCancelBtn').style.display = 'inline-flex';

      const fields = [
        ['detailId','student_id'],
        ['detailName',null],
        ['detailEmail','email'],
        ['detailPhone','phone_number'],
        ['detailSchool','school_selected'],
        ['detailProgram','program_applying_for'],
        ['detailDepartment','department'],
        ['detailLevel','level'],
        ['detailGender','gender'],
        ['detailDOB','date_of_birth'],
        ['detailAddress','address'],
        ['detailNationality','nationality'],
        ['detailCourse','course_type'],
        ['detailScore','wassce_core_score'],
        ['detailEnglish','english_grade'],
        ['detailMath','mathematics_grade'],
        ['detailSocial','social_studies_grade'],
        ['detailScience','integrated_science_grade'],
        ['detailSponsor','sponsor_name'],
        ['detailRelationship','sponsor_relationship'],
        ['detailSponsorPhone','sponsor_phone']
      ];

      const applicant = window._currentApplicant || {};
      fields.forEach(([elId, key]) => {
        const el = document.getElementById(elId);
        if (!el) return;
        const current = (applicant[key] !== undefined && applicant[key] !== null) ? applicant[key] : el.textContent;
        // store original text for cancel
        el.dataset.orig = el.textContent;
        // create input (readonly for student_id)
        const input = document.createElement('input');
        input.className = 'edit-input';
        input.style.width = '100%';
        input.value = current || '';
        if (elId === 'detailId') input.readOnly = true;
        // replace content
        el.innerHTML = '';
        el.appendChild(input);
      });
    }

    function cancelEditMode() {
      const modal = document.getElementById('applicantModal');
      if (!modal) return;
      const footer = document.getElementById('applicantModalFooter');
      if (footer) footer.style.display = 'none';
      document.getElementById('applicantEditBtn').style.display = 'inline-flex';
      document.getElementById('applicantSaveBtn').style.display = 'none';
      document.getElementById('applicantCancelBtn').style.display = 'none';

      // restore original values from dataset.orig
      const inputs = modal.querySelectorAll('.info-value');
      inputs.forEach(el => {
        if (el.dataset.orig !== undefined) {
          el.textContent = el.dataset.orig;
          delete el.dataset.orig;
        }
      });
    }

    async function saveApplicantUpdates() {
      const modal = document.getElementById('applicantModal');
      if (!modal) return;
      const applicant = window._currentApplicant || {};
      const id = applicant.student_id || applicant.id || currentApplicantId;
      if (!id) {
        showToast('Cannot determine applicant id', 'error');
        return;
      }

      // Gather values from inputs
      const map = {
        student_id: 'detailId',
        email: 'detailEmail',
        phone_number: 'detailPhone',
        school_selected: 'detailSchool',
        program_applying_for: 'detailProgram',
        department: 'detailDepartment',
        level: 'detailLevel',
        gender: 'detailGender',
        date_of_birth: 'detailDOB',
        address: 'detailAddress',
        nationality: 'detailNationality',
        course_type: 'detailCourse',
        wassce_core_score: 'detailScore',
        english_grade: 'detailEnglish',
        mathematics_grade: 'detailMath',
        social_studies_grade: 'detailSocial',
        integrated_science_grade: 'detailScience',
        sponsor_name: 'detailSponsor',
        sponsor_relationship: 'detailRelationship',
        sponsor_phone: 'detailSponsorPhone'
      };

      const updates = {};
      Object.entries(map).forEach(([col, elId]) => {
        const el = document.getElementById(elId);
        if (!el) return;
        const input = el.querySelector('input');
        const val = input ? input.value.trim() : (el.textContent || '').trim();
        // skip student_id as it's the key
        if (col === 'student_id') return;
        // special-case full name splitting into first/middle/last
        if (col === 'full_name') return;
        // try to coerce numeric score
        if (col === 'wassce_core_score' && val !== '') {
          const n = Number(val);
          updates[col] = Number.isNaN(n) ? val : n;
        } else {
          updates[col] = val === '' ? null : val;
        }
      });

      try {
        // handle name splitting separately if name input exists
        const nameEl = document.getElementById('detailName');
        if (nameEl) {
          const nameInput = nameEl.querySelector('input');
          if (nameInput) {
            const nameVal = nameInput.value.trim();
            if (nameVal) {
              const parts = nameVal.split(/\s+/);
              updates.first_name = parts[0] || null;
              updates.last_name = parts.length > 1 ? parts[parts.length - 1] : null;
              if (parts.length > 2) updates.middle_name = parts.slice(1, -1).join(' ');
            }
          }
        }
        const { data, error } = await supabase
          .from('newstudents')
          .update(updates)
          .eq('student_id', id);

        if (error) throw error;

        // Update local cache
        allApplicants = allApplicants.map(a => (a.student_id === id) ? ({ ...a, ...updates }) : a);
        filteredApplicants = filteredApplicants.map(a => (a.student_id === id) ? ({ ...a, ...updates }) : a);

        showToast('Applicant updated successfully', 'success');
        // exit edit mode and refresh view
        cancelEditMode();
        viewApplicant(id);
        renderApplicantsTable();
        updateStats();
      } catch (err) {
        console.error('Error updating applicant:', err);
        showToast('Error updating applicant. Check permissions and column names.', 'error');
      }
    }

    async function updateApplicantStatus() {
      // Status is managed automatically; manual status changes removed.
      return;
    }

    async function approveApplicant() {
      // Approve action removed.
      return;
    }

    async function rejectApplicant() {
      // Reject action removed.
      return;
    }

    async function deleteApplicant(studentId) {
      if (!confirm('Are you sure you want to delete this applicant? This action cannot be undone.')) {
        return;
      }

      try {
  const { error } = await window.__sb
          .delete()
          .eq('student_id', studentId);

        if (error) throw error;

        // Also delete from student_master_db table
await window.__sb

        showToast('Applicant deleted successfully');
        refreshApplicants();
      } catch (error) {
        console.error('Error deleting applicant:', error);
        showToast('Error deleting applicant', 'error');
      }
    }

    function editApplicant(studentId) {
      // Open applicant modal and enter edit mode
      (async () => {
        await viewApplicant(studentId);
        // small delay to ensure DOM populated
        setTimeout(() => enterEditMode(), 120);
      })();
    }

    function normalizePhoneForGhana(ph) {
      if (!ph) return null;
      let d = String(ph).replace(/\D/g, '');
      // Remove leading plus
      if (d.startsWith('+' )) d = d.slice(1);
      // If starts with 0, replace with 233
      if (d.startsWith('0')) d = '233' + d.slice(1);
      // If local 9-digit number, prefix Ghana country code
      if (d.length === 9) d = '233' + d;
      // Basic validity check (Ghana numbers will be 12 digits including country code)
      if (d.length >= 11 && d.startsWith('233')) return d;
      return null;
    }

    async function sendSMSToApplicant(studentId) {
      try {
        let applicant = null;
        if (studentId) {
          applicant = allApplicants.find(a => a.student_id === studentId) || null;
        } else {
          applicant = window._currentApplicant || null;
        }

        // If not in memory, try fetching single record
        if (!applicant && studentId) {
          const { data, error } = await window.__sb.from('newstudents').select('*').eq('student_id', studentId).single();
          if (error) throw error;
          applicant = data;
        }

        if (!applicant) {
          showToast('Applicant not found for SMS', 'error');
          return;
        }

        const rawPhone = applicant.phone_number || applicant.phone || applicant.contact || '';
        const to = normalizePhoneForGhana(rawPhone);
        if (!to) {
          showToast('No valid phone number for this applicant', 'error');
          return;
        }

        const name = `${applicant.first_name || ''} ${applicant.last_name || ''}`.trim() || 'Applicant';
        const school = getSchoolName(applicant.school_selected) || applicant.school || '';
        const defaultMessage = `Congratulations ${name}! You have gained admission to ${school}. Please wait to receive a call from the GH Schools admission office with the day to come to the school. — GH Schools`;

        const message = prompt('Edit SMS message to send:', defaultMessage);
        if (!message) return; // cancelled

        const proxyUrl = (window.SMS_PROXY_URL && window.SMS_PROXY_URL.trim()) ? window.SMS_PROXY_URL : 'http://localhost:3000/send-sms';

        // Insert audit row into sms_messages before sending
        let smsRecord = null;
        try {
          const insertPayload = {
            student_id: applicant.student_id || null,
            phone: to,
            message: message,
            status: 'sending',
            gateway_response: null
          };
          const { data: inserted, error: insertErr } = await window.__sb.from('sms_messages').insert(insertPayload).select().single();
          if (insertErr) {
            console.warn('Failed to insert sms_messages audit row:', insertErr);
          } else {
            smsRecord = inserted;
          }
        } catch (ie) {
          console.warn('sms_messages insert error', ie);
        }

        const resp = await fetch(proxyUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to, message })
        });

        const respText = await resp.text().catch(() => '');

        if (!resp.ok) {
          console.error('SMS proxy error', resp.status, respText);
          showToast('Failed to send SMS. See console for details.', 'error');
          // update sms_messages record to failed
          try {
            if (smsRecord && smsRecord.id) {
              await window.__sb.from('sms_messages').update({ status: 'failed', gateway_response: respText }).eq('id', smsRecord.id);
            }
          } catch (ue) { console.warn('Failed to update sms_messages status to failed', ue); }
          return;
        }

        // Success: update audit row to sent
        try {
          if (smsRecord && smsRecord.id) {
            await window.__sb.from('sms_messages').update({ status: 'sent', gateway_response: respText }).eq('id', smsRecord.id);
          }
        } catch (ue) { console.warn('Failed to update sms_messages to sent', ue); }

        showToast('Congratulations SMS sent successfully');
      } catch (err) {
        console.error('Error sending SMS:', err);
        showToast('Error sending SMS', 'error');
      }
    }

    // Download student details as CSV
    function downloadStudentDetails() {
      try {
        const applicant = window._currentApplicant;
        if (!applicant) {
          showToast('No student loaded', 'error');
          return;
        }

        const studentId = applicant.student_id || applicant.id || 'Unknown';
        const fileName = `student_${studentId}_${new Date().toISOString().split('T')[0]}.csv`;

        // Flatten all object fields and create CSV rows
        const rows = [];
        const flatData = {};

        // Flatten nested objects if any
        for (const [key, value] of Object.entries(applicant)) {
          if (value === null || value === undefined) {
            flatData[key] = '';
          } else if (typeof value === 'object') {
            flatData[key] = JSON.stringify(value);
          } else {
            flatData[key] = String(value);
          }
        }

        // Create CSV header row
        const headers = Object.keys(flatData);
        rows.push(headers.map(h => `"${h.replace(/"/g, '""')}"`).join(','));

        // Create CSV data row
        const values = headers.map(h => {
          const val = flatData[h] || '';
          // Escape quotes and wrap in quotes
          return `"${String(val).replace(/"/g, '""')}"`;
        });
        rows.push(values.join(','));

        // Create blob and download
        const csvContent = rows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast('Student details downloaded successfully');
      } catch (err) {
        console.error('Error downloading student details:', err);
        showToast('Error downloading student details', 'error');
      }
    }

    // Print student details
    function printStudentDetails() {
      try {
        const applicant = window._currentApplicant;
        if (!applicant) {
          showToast('No student loaded', 'error');
          return;
        }

        const studentId = applicant.student_id || applicant.id || 'Unknown';
        const name = `${applicant.first_name || ''} ${applicant.last_name || ''}`.trim();
        const school = getSchoolName(applicant.school_selected) || applicant.school || 'N/A';
        const program = applicant.program_applying_for || 'N/A';

        // Build HTML for print
        const printWindow = window.open('', '_blank');
        let html = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Student Details - ${studentId}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
              h2 { color: #555; margin-top: 20px; font-size: 16px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              td { padding: 8px; border: 1px solid #ddd; }
              td:first-child { font-weight: bold; width: 30%; background: #f9f9f9; }
              @media print { body { margin: 0; } }
            </style>
          </head>
          <body>
            <h1>Student Details Report</h1>
            <table>
              <tr><td>Student ID</td><td>${studentId}</td></tr>
              <tr><td>Full Name</td><td>${name}</td></tr>
              <tr><td>School</td><td>${school}</td></tr>
              <tr><td>Program</td><td>${program}</td></tr>
              <tr><td>Email</td><td>${applicant.email || 'N/A'}</td></tr>
              <tr><td>Phone</td><td>${applicant.phone_number || applicant.phone || 'N/A'}</td></tr>
              <tr><td>Date of Birth</td><td>${applicant.dob || 'N/A'}</td></tr>
              <tr><td>Address</td><td>${applicant.home_address || 'N/A'}</td></tr>
              <tr><td>Nationality</td><td>${applicant.nationality || 'N/A'}</td></tr>
              <tr><td>Applied On</td><td>${applicant.created_at ? new Date(applicant.created_at).toLocaleString() : 'N/A'}</td></tr>
            </table>

            <h2>Academic Information</h2>
            <table>
              <tr><td>Course Type</td><td>${applicant.course_type || 'N/A'}</td></tr>
              <tr><td>English Grade</td><td>${applicant.english_grade || 'N/A'}</td></tr>
              <tr><td>Mathematics Grade</td><td>${applicant.mathematics_grade || 'N/A'}</td></tr>
              <tr><td>Social Studies</td><td>${applicant.social_studies_grade || 'N/A'}</td></tr>
              <tr><td>Science</td><td>${applicant.integrated_science_grade || 'N/A'}</td></tr>
              <tr><td>WASSCE Score</td><td>${applicant.wassce_core_score || 'N/A'}</td></tr>
            </table>

            <h2>Sponsor Information</h2>
            <table>
              <tr><td>Sponsor Name</td><td>${applicant.sponsor_name || 'N/A'}</td></tr>
              <tr><td>Relationship</td><td>${applicant.sponsor_relationship || 'N/A'}</td></tr>
              <tr><td>Occupation</td><td>${applicant.sponsor_occupation || 'N/A'}</td></tr>
              <tr><td>Phone</td><td>${applicant.sponsor_phone || 'N/A'}</td></tr>
              <tr><td>Address</td><td>${applicant.sponsor_address || 'N/A'}</td></tr>
            </table>

            <h2>Additional Information</h2>
            <table>
              <tr><td>Languages Spoken</td><td>${applicant.language_spoken || 'N/A'}</td></tr>
              <tr><td>Region</td><td>${applicant.region || 'N/A'}</td></tr>
              <tr><td>Hostel Preference</td><td>${applicant.hostel_preference || 'N/A'}</td></tr>
              <tr><td>Medical Condition</td><td>${applicant.any_medical || 'N/A'}</td></tr>
            </table>

            <hr style="margin-top: 30px;">
            <p style="font-size: 12px; color: #666;">Report generated on ${new Date().toLocaleString()}</p>
          </body>
          </html>
        `;

        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.print();

        showToast('Print dialog opened');
      } catch (err) {
        console.error('Error printing student details:', err);
        showToast('Error printing student details', 'error');
      }
    }

    // Analytics Functions
    async function updateAnalytics() {
      try {
        const year = document.getElementById('analyticsYear').value;
        
        // Load monthly data
        const monthlyData = await getMonthlyData(year);
        updateMonthlyChart(monthlyData);
        
        // Load program popularity
        const programData = await getProgramData();
        updateProgramChart(programData);
        
        // Load region data
        const regionData = await getRegionData();
        updateRegionChart(regionData);
        
        // Load score data
        const scoreData = await getScoreData();
        updateScoreChart(scoreData);
        
        // Trends (last 30 days)
        const trends = await getTrendsData();
        updateTrendsChart(trends);

        // Performance metrics
        const perf = await getPerformanceData();
        updatePerformanceSection(perf);
      } catch (error) {
        console.error('Error updating analytics:', error);
        showToast('Error loading analytics data', 'error');
      }
    }

    // Trends: applications + payments for last 30 days
    async function getTrendsData() {
      try {
        const days = 30;
        const labels = [];
        const appCounts = [];
        const payCounts = [];
        for (let i = days - 1; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const key = d.toISOString().split('T')[0];
          labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          const aCount = allApplicants.filter(a => (a.created_at || '').toString().startsWith(key)).length;
          appCounts.push(aCount);
        }

        // Try to fetch payments for same window
        let payData = [];
        try {
          const since = new Date();
          since.setDate(since.getDate() - (days - 1));
          const { data: payments } = await window.__sb.from('admission_payments').select('student_id,created_at,payment_status');
          payData = payments || [];
        } catch (e) {
          console.warn('Could not fetch payments for trends', e);
        }

        for (let i = days - 1; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const key = d.toISOString().split('T')[0];
          const pCount = payData.filter(p => (p.created_at || '').toString().startsWith(key)).length;
          payCounts.push(pCount);
        }

        return { labels, appCounts, payCounts };
      } catch (err) {
        console.error('getTrendsData error', err);
        return { labels: [], appCounts: [], payCounts: [] };
      }
    }

    function updateTrendsChart(data) {
      try {
        if (charts.trends) {
          charts.trends.data.labels = data.labels;
          charts.trends.data.datasets[0].data = data.appCounts;
          charts.trends.data.datasets[1].data = data.payCounts;
          charts.trends.update();
        } else {
          const ctx = document.getElementById('trendsChart').getContext('2d');
          charts.trends = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [
                { label: 'Applications', data: data.appCounts, borderColor: 'rgba(37,117,252,0.9)', backgroundColor: 'rgba(37,117,252,0.15)', tension: 0.2 },
                { label: 'Payments', data: data.payCounts, borderColor: 'rgba(40,167,69,0.9)', backgroundColor: 'rgba(40,167,69,0.12)', tension: 0.2 }
              ]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        }
      } catch (e) { console.error('updateTrendsChart failed', e); }
    }

    // Performance metrics: conversion, avg time to payment, avg score, processing distribution
    async function getPerformanceData() {
      try {
        // fetch payments once
        let payments = [];
        try {
          const { data } = await window.__sb.from('admission_payments').select('student_id,created_at,payment_status');
          payments = data || [];
        } catch (e) { console.warn('Failed to fetch admission_payment', e); }

        const totalApplicants = allApplicants.length;
        const studentsWithPayment = new Set(payments.map(p => p.student_id).filter(Boolean));
        const paidCount = studentsWithPayment.size;
        const conversion = totalApplicants === 0 ? 0 : Math.round((paidCount / totalApplicants) * 10000) / 100;

        // avg time to first payment (days)
        const times = [];
        const paymentByStudent = {};
        payments.forEach(p => {
          if (!p.student_id) return;
          const existing = paymentByStudent[p.student_id];
          const t = new Date(p.created_at);
          if (!existing || t < new Date(existing)) paymentByStudent[p.student_id] = p.created_at;
        });
        allApplicants.forEach(a => {
          const sid = a.student_id || a.id;
          if (!sid) return;
          const payAt = paymentByStudent[sid];
          if (payAt) {
            const d1 = new Date(a.created_at);
            const d2 = new Date(payAt);
            const diffDays = Math.max(0, Math.round((d2 - d1) / (1000 * 60 * 60 * 24)));
            times.push(diffDays);
          }
        });
        const avgDays = times.length ? (times.reduce((s, v) => s + v, 0) / times.length).toFixed(1) : null;

        // avg WASSCE
        const scores = allApplicants.map(a => a.wassce_core_score).filter(s => s !== null && s !== undefined && !isNaN(s));
        const avgScore = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2) : null;

        // payments trend (last 30 days) reuse getTrendsData
        const trends = await getTrendsData();

        // processing time distribution buckets
        const buckets = { '0':0, '1-3':0, '4-7':0, '8-14':0, '15+':0 };
        times.forEach(t => {
          if (t === 0) buckets['0']++;
          else if (t <= 3) buckets['1-3']++;
          else if (t <= 7) buckets['4-7']++;
          else if (t <= 14) buckets['8-14']++;
          else buckets['15+']++;
        });

        // top programs
        const progCounts = {};
        allApplicants.forEach(a => {
          const p = a.program_applying_for || 'Unknown';
          progCounts[p] = (progCounts[p] || 0) + 1;
        });
        const topPrograms = Object.entries(progCounts).sort((a,b)=>b[1]-a[1]).slice(0,8).map(([program,count])=>{
          const progScores = allApplicants.filter(x=> (x.program_applying_for||'')===program).map(x=>x.wassce_core_score).filter(s=>s!==null&&s!==undefined&&!isNaN(s));
          const avg = progScores.length ? (progScores.reduce((a,b)=>a+b,0)/progScores.length).toFixed(2) : 'N/A';
          return { program, count, avgScore: avg };
        });

        return { conversion, avgDays, avgScore, trends, buckets, topPrograms };
      } catch (err) {
        console.error('getPerformanceData error', err);
        return { conversion:0, avgDays:null, avgScore:null, trends:{labels:[],appCounts:[],payCounts:[]}, buckets:{}, topPrograms:[] };
      }
    }

    function updatePerformanceSection(perf) {
      try {
        document.getElementById('perfConversion').textContent = perf.conversion + '%';
        document.getElementById('perfAvgProcessing').textContent = perf.avgDays !== null ? `${perf.avgDays} days` : 'N/A';
        document.getElementById('perfAvgScore').textContent = perf.avgScore !== null ? perf.avgScore : 'N/A';

        // payments trend chart
        if (charts.paymentsTrend) {
          charts.paymentsTrend.data.labels = perf.trends.labels;
          charts.paymentsTrend.data.datasets[0].data = perf.trends.payCounts;
          charts.paymentsTrend.update();
        } else {
          const ctx = document.getElementById('paymentsTrendChart').getContext('2d');
          charts.paymentsTrend = new Chart(ctx, {
            type: 'bar',
            data: { labels: perf.trends.labels, datasets: [{ label: 'Payments', data: perf.trends.payCounts, backgroundColor: 'rgba(40,167,69,0.7)'}] },
            options: { responsive:true, maintainAspectRatio:false }
          });
        }

        // processing distribution chart
        const labels = Object.keys(perf.buckets);
        const data = Object.values(perf.buckets);
        if (charts.processing) {
          charts.processing.data.labels = labels;
          charts.processing.data.datasets[0].data = data;
          charts.processing.update();
        } else {
          const ctx2 = document.getElementById('processingChart').getContext('2d');
          charts.processing = new Chart(ctx2, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#28a745','#20c997','#ffc107','#fd7e14','#dc3545'] }] },
            options: { responsive:true, maintainAspectRatio:false }
          });
        }

        // top programs table
        const tbody = document.getElementById('topProgramsBody');
        tbody.innerHTML = '';
        perf.topPrograms.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(p.program)}</td><td>${p.count}</td><td>${p.avgScore}</td>`;
          tbody.appendChild(tr);
        });
      } catch (e) { console.error('updatePerformanceSection error', e); }
    }

    async function getMonthlyData(year) {
      const months = Array.from({ length: 12 }, (_, i) => {
        const date = new Date(year, i, 1);
        return date.toLocaleDateString('en-US', { month: 'short' });
      });

      const data = months.map((month, index) => {
        return allApplicants.filter(a => {
          const date = new Date(a.created_at);
          return date.getFullYear() == year && date.getMonth() === index;
        }).length;
      });

      return { labels: months, data };
    }

    function updateMonthlyChart(data) {
      if (charts.monthly) {
        charts.monthly.data.labels = data.labels;
        charts.monthly.data.datasets[0].data = data.data;
        charts.monthly.update();
      } else {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        charts.monthly = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Applications',
              data: data.data,
              backgroundColor: 'rgba(37, 117, 252, 0.7)',
              borderColor: 'rgb(37, 117, 252)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }

    async function getProgramData() {
      const programs = {};
      allApplicants.forEach(a => {
        const program = a.program_applying_for || 'Unknown';
        programs[program] = (programs[program] || 0) + 1;
      });

      const labels = Object.keys(programs);
      const data = Object.values(programs);

      return { labels, data };
    }

    function updateProgramChart(data) {
      if (charts.program) {
        charts.program.data.labels = data.labels;
        charts.program.data.datasets[0].data = data.data;
        charts.program.update();
      } else {
        const ctx = document.getElementById('programChart').getContext('2d');
        charts.program = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: data.labels,
            datasets: [{
              data: data.data,
              backgroundColor: [
                '#2575fc',
                '#f19d01',
                '#28a745',
                '#dc3545',
                '#17a2b8',
                '#6f42c1',
                '#20c997'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });
      }
    }

    async function getRegionData() {
      const regions = {};
      allApplicants.forEach(a => {
        const region = a.region || 'Unknown';
        regions[region] = (regions[region] || 0) + 1;
      });

      const sorted = Object.entries(regions)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const labels = sorted.map(r => r[0]);
      const data = sorted.map(r => r[1]);

      return { labels, data };
    }

    function updateRegionChart(data) {
      if (charts.region) {
        charts.region.data.labels = data.labels;
        charts.region.data.datasets[0].data = data.data;
        charts.region.update();
      } else {
        const ctx = document.getElementById('regionChart').getContext('2d');
        charts.region = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Applicants',
              data: data.data,
              backgroundColor: 'rgba(106, 17, 203, 0.7)',
              borderColor: 'rgb(106, 17, 203)',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }

    async function getScoreData() {
      const ranges = [
        { min: 1, max: 8, label: 'Excellent (1-8)' },
        { min: 9, max: 16, label: 'Good (9-16)' },
        { min: 17, max: 24, label: 'Average (17-24)' },
        { min: 25, max: 32, label: 'Below Avg (25-32)' },
        { min: 33, max: 36, label: 'Poor (33-36)' }
      ];

      const data = ranges.map(range => {
        return allApplicants.filter(a => {
          const score = a.wassce_core_score;
          return score >= range.min && score <= range.max;
        }).length;
      });

      const labels = ranges.map(r => r.label);

      return { labels, data };
    }

    function updateScoreChart(data) {
      if (charts.score) {
        charts.score.data.labels = data.labels;
        charts.score.data.datasets[0].data = data.data;
        charts.score.update();
      } else {
        const ctx = document.getElementById('scoreChart').getContext('2d');
        charts.score = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Students',
              data: data.data,
              backgroundColor: [
                '#28a745',
                '#20c997',
                '#ffc107',
                '#fd7e14',
                '#dc3545'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }

    // School Statistics
    async function loadSchoolStats() {
      try {
        const schools = ['MEDIA', 'FASHION', 'CATERING', 'COSMETOLOGY', 'TECHNOLOGY'];
        const tbody = document.getElementById('schoolsTableBody');
        tbody.innerHTML = '';

        for (const school of schools) {
          const applicants = allApplicants.filter(a => a.school_selected === school);
          const diplomaCount = applicants.filter(a => a.course_type === 'Diploma').length;
          const iccCount = applicants.filter(a => a.course_type === 'ICC').length;
          
          const scores = applicants
            .map(a => a.wassce_core_score)
            .filter(score => score !== null && !isNaN(score));
          const avgScore = scores.length > 0 
            ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2)
            : 'N/A';

          const programCounts = {};
          applicants.forEach(a => {
            const program = a.program_applying_for;
            if (program) {
              programCounts[program] = (programCounts[program] || 0) + 1;
            }
          });
          
          const popularProgram = Object.entries(programCounts)
            .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${getSchoolName(school)}</td>
            <td>${applicants.length}</td>
            <td>${diplomaCount}</td>
            <td>${iccCount}</td>
            <td>${avgScore}</td>
            <td>${popularProgram}</td>
            <td>
              <button class="btn btn-outline" onclick="filterBySchool('${school}')">
                View Applicants
              </button>
            </td>
          `;
          tbody.appendChild(row);
        }

        document.getElementById('schoolsLoading').style.display = 'none';
        document.getElementById('schoolsTable').style.display = 'table';
      } catch (error) {
        console.error('Error loading school stats:', error);
        showToast('Error loading school statistics', 'error');
      }
    }

    // Export Functions
    function exportData(format) {
      const data = filteredApplicants.map(applicant => ({
        'Student ID': applicant.student_id,
        'Name': `${applicant.first_name} ${applicant.last_name}`,
        'Email': applicant.email,
        'Phone': applicant.phone_number,
        'School': getSchoolName(applicant.school_selected),
        'School Code': applicant.school_selected || '',
        'School Color': getSchoolColor(applicant.school_selected) || '',
        'Program': applicant.program_applying_for,
        'Course Type': applicant.course_type,
        'Status': applicant.status || 'pending',
        'Applied On': formatDate(applicant.created_at),
        'WASSCE Score': applicant.wassce_core_score || 'N/A'
      }));

      if (format === 'csv') {
        exportToCSV(data);
      } else if (format === 'excel') {
        exportToExcel(data);
      } else if (format === 'pdf') {
        exportToPDF(data);
      } else if (format === 'docx') {
        exportToDocx(data);
      }
    }

    function exportToCSV(data) {
      if (data.length === 0) {
        showToast('No data to export', 'error');
        return;
      }

      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => JSON.stringify(row[header])).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `applicants_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('CSV exported successfully');
    }

    function exportToExcel(data) {
      try {
        if (!window.XLSX) {
          showToast('SheetJS (XLSX) library not loaded', 'error');
          return;
        }
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Applicants');
        const filename = `applicants_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
        showToast('Excel exported successfully');
      } catch (err) {
        console.error('Excel export error', err);
        showToast('Failed to export Excel', 'error');
      }
    }

    async function exportToPDF(data) {
      try {
        const { jsPDF } = window.jspdf || window.jspdf || {};
        if (!jsPDF || !window.jspdf) {
          showToast('jsPDF library not loaded', 'error');
          return;
        }
        const doc = new jsPDF('l', 'pt', 'a4');
        // Build table
        const headers = Object.keys(data[0] || {});
        const body = data.map(row => headers.map(h => row[h] != null ? String(row[h]) : ''));
        // @ts-ignore (autotable is added globally)
        doc.autoTable({ head: [headers], body, startY: 40, styles: { fontSize: 9 } });
        const filename = `applicants_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        showToast('PDF exported successfully');
      } catch (err) {
        console.error('PDF export error', err);
        showToast('Failed to export PDF', 'error');
      }
    }

    async function exportToDocx(data) {
      try {
        if (!window.docx || !window.docx.Document) {
          showToast('docx library not loaded', 'error');
          return;
        }
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun } = window.docx;
        const headers = Object.keys(data[0] || {});
        const rows = data.map(row => headers.map(h => row[h] != null ? String(row[h]) : ''));

        const tableRows = [
          new TableRow({ children: headers.map(h => new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: h, bold: true })] })] })) })
        ];
        rows.forEach(r => {
          tableRows.push(new TableRow({ children: r.map(c => new TableCell({ children: [new Paragraph(String(c) || '')] })) }));
        });

        const table = new Table({ rows: tableRows });
        const doc = new Document({ sections: [{ properties: {}, children: [new Paragraph({ text: 'Applicants Report', heading: 'Heading1' }), table] }] });

        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `applicants_${new Date().toISOString().split('T')[0]}.docx`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('DOCX exported successfully');
      } catch (err) {
        console.error('DOCX export error', err);
        showToast('Failed to export DOCX', 'error');
      }
    }

    async function generateReport() {
      const type = document.getElementById('reportType').value;
      const from = document.getElementById('reportFrom').value;
      const to = document.getElementById('reportTo').value;
      const format = document.getElementById('reportFormat').value;

      if (!from || !to) {
        showToast('Please select date range', 'error');
        return;
      }

      const nameMap = {
        'applications_summary': 'Applications — Summary',
        'applications_detailed': 'Applications — Detailed',
        'admissions_overview': 'Admissions — Overview',
        'admissions_by_school': 'Admissions — By School',
        'financial_overview': 'Financial — Overview',
        'financial_payments': 'Financial — Payments',
        'financial_by_school': 'Financial — By School',
        'performance_wassce': 'Performance — WASSCE Scores',
        'performance_programs': 'Performance — Program Distribution'
      };

      const reportName = nameMap[type] || type;
      showToast(`Generating ${reportName} from ${from} to ${to} in ${format.toUpperCase()} format...`);

      try {
        await downloadReport(reportName, format, from, to, type);
        addToReportHistory(reportName, from, to, format);
        showToast('Report generated successfully!');
      } catch (err) {
        console.error('Report generation failed:', err);
        showToast('Failed to generate report', 'error');
      }
    }

    function previewReport() {
      showToast('Report preview would open in a new window', 'info');
    }

    function addToReportHistory(reportName, from, to, format) {
      const tbody = document.getElementById('reportsHistory');
      const row = document.createElement('tr');
      const now = new Date();

      row.innerHTML = `
        <td>${reportName}</td>
        <td>${now.toLocaleString()}</td>
        <td>${format.toUpperCase()}</td>
        <td>${from} to ${to}</td>
        <td>${Math.floor(Math.random() * 500) + 100} KB</td>
        <td>
          <button class="btn btn-outline" onclick="downloadReport('${reportName}','${format}','${from}','${to}')">
            <i class="fas fa-download"></i>
          </button>
        </td>
      `;

      tbody.insertBefore(row, tbody.firstChild);
    }

    // Prepare report data for different report types
    async function prepareReportData(reportType = 'applications_detailed', from = '', to = '') {
      let data = [];

      if (reportType && reportType.startsWith('financial')) {
        let paymentsQuery = supabase
          .from('admission_payments')
          .select('*')
          .order('created_at', { ascending: false });
        if (from) paymentsQuery = paymentsQuery.gte('created_at', from);
        if (to) paymentsQuery = paymentsQuery.lte('created_at', to);
        const { data: payments, error: payErr } = await paymentsQuery;
        if (payErr) throw payErr;

        const studentIds = Array.from(new Set((payments || []).map(p => p.student_id).filter(Boolean)));
        let studentMap = {};
        if (studentIds.length > 0) {
          const { data: studs } = await window.__sb.from('newstudents').select('student_id, first_name, last_name, email, phone_number').in('student_id', studentIds);
          (studs || []).forEach(s => { studentMap[s.student_id] = s; });
        }

        if (reportType === 'financial_overview') {
          const total = (payments || []).reduce((s, p) => s + Number(p.amount || p.total || 0), 0);
          data = [{ 'Metric': 'Total Payments', 'Total Amount': total }];
        } else {
          data = (payments || []).map(p => ({
            'Reference': p.reference_code || p.id,
            'Student ID': p.student_id || 'N/A',
            'Student Name': (studentMap[p.student_id] ? `${studentMap[p.student_id].first_name || ''} ${studentMap[p.student_id].last_name || ''}`.trim() : (p.email || 'N/A')),
            'Email': (studentMap[p.student_id] && studentMap[p.student_id].email) || p.email || '',
            'Phone': (studentMap[p.student_id] && studentMap[p.student_id].phone_number) || p.phone || '',
            'Amount': p.amount || p.total || 0,
            'Status': p.payment_status || p.status || 'N/A',
            'Payment Date': formatDate(p.created_at)
          }));
        }

      } else if (reportType && (reportType.startsWith('applications') || reportType.startsWith('admissions') || reportType.startsWith('performance'))) {
        let applicantsQuery = supabase
          .from('newstudents')
          .select('*')
          .order('created_at', { ascending: false });
        if (from) applicantsQuery = applicantsQuery.gte('created_at', from);
        if (to) applicantsQuery = applicantsQuery.lte('created_at', to);
        const { data: rows, error } = await applicantsQuery;
        if (error) throw error;

        if (reportType === 'applications_summary') {
          const summary = {};
          (rows || []).forEach(a => {
            const school = a.school_selected || 'Unknown';
            if (!summary[school]) summary[school] = { school, total: 0, approved: 0, pending: 0 };
            summary[school].total += 1;
            const st = (a.status || 'pending').toLowerCase();
            if (st === 'approved') summary[school].approved += 1;
            else if (st === 'pending') summary[school].pending += 1;
          });
          data = Object.values(summary).map(s => ({ 'School': getSchoolName(s.school), 'Total Applications': s.total, 'Approved': s.approved, 'Pending': s.pending }));
        } else if (reportType === 'admissions_by_school') {
          const agg = {};
          (rows || []).filter(r => (r.status||'').toLowerCase() === 'approved').forEach(a => {
            const school = a.school_selected || 'Unknown';
            if (!agg[school]) agg[school] = { school, admitted: 0 };
            agg[school].admitted += 1;
          });
          data = Object.values(agg).map(s => ({ 'School': getSchoolName(s.school), 'Admitted': s.admitted }));
        } else if (reportType === 'performance_programs') {
          const dist = {};
          (rows || []).forEach(a => {
            const prog = a.program_applying_for || 'Unknown';
            dist[prog] = (dist[prog] || 0) + 1;
          });
          data = Object.keys(dist).map(k => ({ 'Program': k, 'Count': dist[k] }));
        } else if (reportType === 'performance_wassce') {
          data = (rows || []).map(a => ({
            'Student ID': a.student_id || '',
            'Name': `${a.first_name || ''} ${a.last_name || ''}`.trim(),
            'Program': a.program_applying_for || '',
            'WASSCE Score': a.wassce_core_score || 'N/A',
            'Applied On': formatDate(a.created_at)
          }));
        } else {
          // applications_detailed or default — include more fields
          data = (rows || []).map(applicant => ({
            'Student ID': applicant.student_id,
            'Name': `${applicant.first_name || ''} ${applicant.last_name || ''}`.trim(),
            'Email': applicant.email || '',
            'Phone': applicant.phone_number || applicant.phone || '',
            'DOB': applicant.date_of_birth || applicant.dob || '',
            'Guardian': applicant.guardian_name || applicant.sponsor_name || '',
            'Address': applicant.address || '',
            'Nationality': applicant.nationality || '',
            'School': getSchoolName(applicant.school_selected),
            'Program': applicant.program_applying_for || applicant.program || '',
            'Course Type': applicant.course_type || '',
            'Status': applicant.status || 'pending',
            'Applied On': formatDate(applicant.created_at),
            'WASSCE Score': applicant.wassce_core_score || 'N/A'
          }));
        }

      } else {
        throw new Error('Unknown report type');
      }

      return data;
    }

    // Export PDF to a preview window
    async function exportToPDFPreview(data) {
      try {
        const { jsPDF } = window.jspdf || window.jspdf || {};
        if (!jsPDF || !window.jspdf) {
          showToast('jsPDF library not loaded', 'error');
          return;
        }
        const doc = new jsPDF('l', 'pt', 'a4');
        const headers = Object.keys(data[0] || {});
        const body = data.map(row => headers.map(h => row[h] != null ? String(row[h]) : ''));
        // @ts-ignore
        doc.autoTable({ head: [headers], body, startY: 40, styles: { fontSize: 9 } });
        const blob = doc.output('blob');
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        showToast('PDF preview opened');
      } catch (err) {
        console.error('PDF preview error', err);
        showToast('Failed to open PDF preview', 'error');
      }
    }

    // Preview the selected report as PDF
    async function previewReport() {
      const type = document.getElementById('reportType').value;
      const from = document.getElementById('reportFrom').value;
      const to = document.getElementById('reportTo').value;

      if (!from || !to) {
        showToast('Please select date range', 'error');
        return;
      }

      try {
        const data = await prepareReportData(type, from, to);
        if (!data || data.length === 0) {
          showToast('No data available for preview', 'error');
          return;
        }
        await exportToPDFPreview(data);
      } catch (err) {
        console.error('Preview failed', err);
        showToast('Failed to prepare preview', 'error');
      }
    }

    async function downloadReport(reportName, format = 'pdf', from = '', to = '', reportType = 'applications_detailed') {
      try {
        showToast(`Preparing ${reportName}...`);

        const data = await prepareReportData(reportType, from, to);

        if (!data || data.length === 0) {
          showToast('No data available for this report', 'error');
          return;
        }

        // Dispatch to export handlers
        if (format === 'csv') {
          exportToCSV(data);
        } else if (format === 'excel') {
          exportToExcel(data);
        } else if (format === 'pdf') {
          await exportToPDF(data);
        } else if (format === 'docx') {
          await exportToDocx(data);
        } else {
          await exportToPDF(data);
        }
      } catch (err) {
        console.error('Error generating report:', err);
        throw err;
      }
    }

    function loadReportHistory() {
      const tbody = document.getElementById('reportsHistory');
      tbody.innerHTML = `
        <tr>
          <td>Applications Report</td>
          <td>${new Date().toLocaleDateString()}</td>
          <td>PDF</td>
          <td>2025-01-01 to 2025-02-01</td>
          <td>245 KB</td>
          <td>
            <button class="btn btn-outline" onclick="downloadReport('Applications Report')">
              <i class="fas fa-download"></i>
            </button>
          </td>
        </tr>
      `;
    }

    // Notifications
    function loadNotifications() {
      // Load recent notifications from recent applicants and payments to seed the view
      (async () => {
        try {
          // recent applicants
          const { data: recentApps, error: appErr } = await supabase
            .from('newstudents')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(10);
          if (!appErr && Array.isArray(recentApps)) {
            recentApps.forEach(r => {
              addNotification({
                title: 'New Application Submitted',
                message: `${(r.first_name || '') + ' ' + (r.last_name || '')} applied to ${getSchoolName(r.school_selected) || r.school || 'N/A'}`,
                type: 'application',
                timestamp: r.created_at,
                meta: r
              }, { preserveRender: true });
            });
          }

          // recent payments
          const { data: recentPayments, error: payErr } = await supabase
            .from('admission_payment')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(10);
          if (!payErr && Array.isArray(recentPayments)) {
            recentPayments.forEach(p => {
              addNotification({
                title: `Payment ${p.status || ''}`,
                message: `Student ${p.student_id || p.student || 'N/A'} paid ${p.amount || p.total || 'N/A'}`,
                type: 'payment',
                timestamp: p.created_at,
                meta: p
              }, { preserveRender: true });
            });
          }

          // Render after seeding
          renderNotifications();
        } catch (e) {
          console.warn('Error seeding notifications', e);
          renderNotifications();
        }

        // Counters
        document.getElementById('pendingActions').textContent = allApplicants.filter(a => a.status === 'pending').length;
        document.getElementById('unreadCount').textContent = notifications.filter(n => !n.read).length;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('todayNotifications').textContent = notifications.filter(n => (n.timestamp || '').toString().startsWith(today)).length;
      })();
    }

    // Settings Functions
    function saveSettings() {
      const year = document.getElementById('admissionYear').value;
      const idFormat = document.getElementById('idFormat').value;
      const duration = document.getElementById('defaultDuration').value;
      const minScore = document.getElementById('minScore').value;
      const emailApplicant = document.getElementById('emailApplicant').checked;
      const emailAdmin = document.getElementById('emailAdmin').checked;

      const settings = {
        admissionYear: year,
        idFormat: idFormat,
        defaultDuration: duration,
        minScore: minScore,
        emailApplicant: emailApplicant,
        emailAdmin: emailAdmin,
        lastUpdated: new Date().toISOString()
      };

      localStorage.setItem('ghschools_settings', JSON.stringify(settings));
      showToast('Settings saved successfully');
    }

    function backupDatabase() {
      showToast('Database backup initiated...');
      setTimeout(() => {
        showToast('Database backup completed successfully');
      }, 3000);
    }

    function clearOldData() {
      if (confirm('Are you sure you want to clear data older than 1 year? This action cannot be undone.')) {
        showToast('Clearing old data...');
        setTimeout(() => {
          showToast('Old data cleared successfully');
        }, 2000);
      }
    }

    function resetSystem() {
      if (confirm('WARNING: This will reset all system settings to defaults. Are you sure?')) {
        localStorage.removeItem('ghschools_settings');
        showToast('System reset to defaults');
      }
    }

    // Utility Functions
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const icon = toast.querySelector('i');
      const text = document.getElementById('toastMessage');

      text.textContent = message;
      
      if (type === 'error') {
        toast.style.background = 'var(--danger)';
        icon.className = 'fas fa-exclamation-circle';
      } else if (type === 'info') {
        toast.style.background = 'var(--info)';
        icon.className = 'fas fa-info-circle';
      } else {
        toast.style.background = 'var(--primary)';
        icon.className = 'fas fa-check-circle';
      }

      toast.style.display = 'flex';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    // Notification helpers
    function addNotification(item, opts = {}) {
      const n = {
        id: item.id || `n_${Date.now()}_${Math.floor(Math.random()*1000)}`,
        title: item.title || 'Notification',
        message: item.message || '',
        type: item.type || 'info',
        timestamp: item.timestamp || new Date().toISOString(),
        read: item.read ? true : false,
        meta: item.meta || null
      };
      notifications.unshift(n);
      // trim
      if (notifications.length > MAX_NOTIFICATIONS) notifications = notifications.slice(0, MAX_NOTIFICATIONS);
      // Play sound for new notification unless explicitly disabled via opts
      try {
        const enabled = localStorage.getItem('gh_notif_sound') !== '0';
        if (enabled && opts.playSound !== false) playNotificationSound();
      } catch (e) {}
      if (!opts.preserveRender) renderNotifications();
    }

    function renderNotifications() {
      const container = document.getElementById('notificationsList');
      if (!container) return;
      container.innerHTML = '';
      notifications.forEach(n => {
        const time = new Date(n.timestamp).toLocaleString();
        const div = document.createElement('div');
        div.className = 'notification-item' + (n.read ? '' : ' unread');
        div.style.borderBottom = '1px solid #e1e5ee';
        div.style.padding = '12px';
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <div style="flex:1">
              <strong>${n.title}</strong>
              <div style="font-size:13px; color:var(--gray); margin-top:6px;">${n.message}</div>
            </div>
            <div style="text-align:right; min-width:160px;">
              <div style="font-size:12px; color:var(--gray);">${time}</div>
              <div class="notification-actions" style="margin-top:8px;">
                <button class="btn btn-outline" onclick="markNotificationRead('${n.id}')">Mark Read</button>
                <button class="btn btn-primary" onclick="viewNotificationDetail('${n.id}')">View</button>
                <button class="btn btn-danger" onclick="deleteNotification('${n.id}')">Delete</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });

      // update counters
      const unread = notifications.filter(n => !n.read).length;
      document.getElementById('unreadCount').textContent = unread;
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('todayNotifications').textContent = notifications.filter(n => (n.timestamp || '').toString().startsWith(today)).length;
    }

    function markNotificationRead(id) {
      const idx = notifications.findIndex(n => n.id === id);
      if (idx !== -1) {
        notifications[idx].read = true;
        renderNotifications();
      }
    }

    function markAllNotificationsRead() {
      let changed = false;
      notifications = notifications.map(n => {
        if (!n.read) { changed = true; return Object.assign({}, n, { read: true }); }
        return n;
      });
      if (changed) renderNotifications();
    }

    function deleteNotification(id) {
      const idx = notifications.findIndex(n => n.id === id);
      if (idx === -1) return;
      // remove the notification
      notifications.splice(idx, 1);
      renderNotifications();
    }

    function deleteAllNotifications() {
      if (!confirm('Delete all notifications? This cannot be undone.')) return;
      notifications = [];
      renderNotifications();
    }

    function viewNotificationDetail(id) {
      const n = notifications.find(x => x.id === id);
      if (!n) return;
      // If this notification contains applicant meta, show a sanitized student summary
      const meta = n.meta || {};
      if (n.type === 'application' || meta.student_id || meta.first_name || meta.last_name) {
        const txt = formatStudentSummaryPlain(meta, n.message);
        showMessageModal(n.title, txt);
      } else {
        // Fallback: show the message and a small preview of meta (plain text)
        const preview = `${n.message}\n\n${JSON.stringify(n.meta || {}, null, 2)}`;
        showMessageModal(n.title, preview);
      }
      markNotificationRead(id);
    }

    // Simple masking helpers
    function maskPhone(ph) {
      if (!ph) return 'N/A';
      const digits = String(ph).replace(/\D/g,'');
      if (digits.length <= 4) return '****' + digits;
      return '***' + digits.slice(-4);
    }

    function maskEmail(em) {
      if (!em) return 'N/A';
      const parts = String(em).split('@');
      if (parts.length !== 2) return '*****';
      const name = parts[0];
      const domain = parts[1];
      const visible = name.length > 2 ? name[0] + '***' + name.slice(-1) : name[0] + '***';
      return `${visible}@${domain}`;
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/[&<>"'`]/g, function(s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"})[s];
      });
    }

    // Audio alert: use WebAudio to play a short beep
    let _notifAudioCtx = null;
    function ensureAudioContext() {
      try {
        if (!_notifAudioCtx) {
          const C = window.AudioContext || window.webkitAudioContext;
          if (!C) return null;
          _notifAudioCtx = new C();
        }
        return _notifAudioCtx;
      } catch (e) {
        console.warn('AudioContext init failed', e);
        return null;
      }
    }

    function playNotificationSound() {
      try {
        const ctx = ensureAudioContext();
        if (!ctx) return;
        // Resume if suspended (some browsers require user gesture)
        if (ctx.state === 'suspended') {
          ctx.resume().catch(() => {});
        }
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880; // A5
        g.gain.value = 0.0001;
        o.connect(g);
        g.connect(ctx.destination);
        // ramp for smoothness
        const now = ctx.currentTime;
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.12, now + 0.02);
        o.start(now);
        // fade out
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.5);
        o.stop(now + 0.55);
      } catch (e) {
        console.warn('playNotificationSound failed', e);
      }
    }

    function toggleNotificationSound() {
      try {
        const cur = localStorage.getItem('gh_notif_sound');
        if (cur === '0') {
          localStorage.removeItem('gh_notif_sound');
        } else {
          localStorage.setItem('gh_notif_sound','0');
        }
        updateNotifSoundToggle();
      } catch (e) {}
    }

    function updateNotifSoundToggle() {
      try {
        const btn = document.getElementById('notifSoundToggle');
        if (!btn) return;
        const enabled = localStorage.getItem('gh_notif_sound') !== '0';
        btn.innerHTML = enabled ? '<i class="fas fa-bell"></i>' : '<i class="fas fa-bell-slash"></i>';
      } catch (e) {}
    }

    // initialize sound toggle UI on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      updateNotifSoundToggle();
      // Try to create audio context on first user gesture to satisfy autoplay policies
      ['click','keydown','touchstart'].forEach(ev => document.addEventListener(ev, function initOnce(){
        try { ensureAudioContext(); } catch(e){}
        ['click','keydown','touchstart'].forEach(ev2 => document.removeEventListener(ev2, initOnce));
      }));
    });

    // Format student summary as plain text (no HTML)
    function formatStudentSummaryPlain(student, noteMessage) {
      if (!student) return noteMessage || '';
      const fullName = `${student.first_name || student.firstname || ''} ${student.middle_name || ''} ${student.last_name || student.lastname || ''}`.replace(/\s+/g,' ').trim();
      const school = getSchoolName(student.school_selected) || student.school || 'N/A';
      const program = student.program_applying_for || student.program || 'N/A';
      const studentId = student.student_id || student.id || 'N/A';
      const dob = student.date_of_birth || student.dob || 'N/A';
      const gender = student.gender || 'N/A';
      const score = (student.wassce_core_score !== undefined && student.wassce_core_score !== null) ? student.wassce_core_score : 'N/A';
      const status = student.status || 'N/A';
      const phone = maskPhone(student.phone_number || student.phone || student.sponsor_phone || '');
      const email = maskEmail(student.email || '');

      const lines = [];
      lines.push(`Name: ${fullName || 'N/A'}`);
      lines.push(`Student ID: ${studentId}`);
      lines.push(`School: ${school}`);
      lines.push(`Program: ${program}`);
      lines.push(`WASSCE Score: ${score}`);
      lines.push(`Status: ${status}`);
      lines.push(`DOB: ${dob}`);
      lines.push(`Gender: ${gender}`);
      lines.push(`Phone: ${phone}`);
      lines.push(`Email: ${email}`);
      if (noteMessage) {
        lines.push('');
        lines.push('Message:');
        lines.push(noteMessage);
      }
      return lines.join('\n');
    }

    // Load saved settings
    function loadSettings() {
      const saved = localStorage.getItem('ghschools_settings');
      if (saved) {
        try {
          const settings = JSON.parse(saved);
          document.getElementById('admissionYear').value = settings.admissionYear || '2025';
          document.getElementById('idFormat').value = settings.idFormat || '[SCHOOL][001-999]26';
          document.getElementById('defaultDuration').value = settings.defaultDuration || 'TWO (2) YEAR';
          document.getElementById('minScore').value = settings.minScore || '20';
          document.getElementById('emailApplicant').checked = settings.emailApplicant !== false;
          document.getElementById('emailAdmin').checked = settings.emailAdmin !== false;
        } catch (e) {
          console.error('Error loading settings:', e);
        }
      }
    }

    // Load settings on start
    loadSettings();

    // Setup realtime listeners for newstudents table
    function setupRealtime() {
      if (!window.__sb || typeof window.__sb.channel !== 'function') {
        console.warn('Realtime not available in this supabase client');
        return;
      }

      try {
        const channel = window.__sb
          .channel('public:newstudents')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'newstudents' }, payload => {
            console.log('Realtime payload', payload);

            // Normalize event type
            let eventType = payload.eventType || payload.type || payload.event;
            let record = payload.record || payload.new || (payload.payload && payload.payload.record) || payload.new_record || null;

            if (!eventType) {
              if (payload.new && !payload.old) eventType = 'INSERT';
              else if (payload.new && payload.old) eventType = 'UPDATE';
              else if (payload.old && !payload.new) eventType = 'DELETE';
            }

            if (!record && payload.new) record = payload.new;
            if (!record && payload.old) record = payload.old;
            if (!record) return;

            const getKey = r => (r.student_id || r.id || null);
            const key = getKey(record);

            if (eventType === 'INSERT') {
              allApplicants.unshift(record);
              filteredApplicants.unshift(record);
              updateStats();
              loadRecentApplicants();
              renderApplicantsTable();
              updatePagination();
              showToast('New applicant received', 'info');
            } else if (eventType === 'UPDATE') {
              const idx = allApplicants.findIndex(a => getKey(a) === key);
              if (idx !== -1) allApplicants[idx] = record;
              const fidx = filteredApplicants.findIndex(a => getKey(a) === key);
              if (fidx !== -1) filteredApplicants[fidx] = record;
              updateStats();
              renderApplicantsTable();
              updatePagination();
              showToast('Applicant updated', 'info');
            } else if (eventType === 'DELETE') {
              allApplicants = allApplicants.filter(a => getKey(a) !== key);
              filteredApplicants = filteredApplicants.filter(a => getKey(a) !== key);
              updateStats();
              renderApplicantsTable();
              updatePagination();
              showToast('Applicant removed', 'error');
            }
          });

        // Subscribe and set status when subscription completes
        const sub = channel.subscribe();
        // Mark connected immediately after subscribe attempt; ping will validate
        setRealtimeStatus('connected');

        // Periodic ping to verify connection health
        if (window._realtimePingInterval) clearInterval(window._realtimePingInterval);
        window._realtimePingInterval = setInterval(async () => {
          try {
            // lightweight head request - does not return rows
            await window.__sb.from('newstudents').select('student_id', { head: true });
            setRealtimeStatus('connected');
          } catch (e) {
            console.warn('Realtime ping failed', e);
            setRealtimeStatus('disconnected');
          }
        }, 10000);

        // Clean up on unload
        window.addEventListener('beforeunload', () => {
          try { channel.unsubscribe(); } catch (e) {}
          if (window._realtimePingInterval) clearInterval(window._realtimePingInterval);
        });

        console.log('Subscribed to realtime updates for newstudents');

        // Also subscribe to admission_payments table for payment events
        const paymentsChannel = window.__sb
          .channel('public:admission_payments')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'admission_payments' }, payload => {
            try {
              console.log('Payment realtime payload', payload);
              let eventType = payload.eventType || payload.type || payload.event;
              let record = payload.record || payload.new || payload.new_record || null;
              if (!eventType) {
                if (payload.new && !payload.old) eventType = 'INSERT';
                else if (payload.new && payload.old) eventType = 'UPDATE';
                else if (payload.old && !payload.new) eventType = 'DELETE';
              }
              if (!record && payload.new) record = payload.new;
              if (!record && payload.old) record = payload.old;
              if (!record) return;

              // Build a friendly notification
              const studentId = record.student_id || record.student || null;
              const amount = record.amount || record.total || null;
              const status = record.status || record.payment_status || '';
              const title = amount ? `Payment ${status || 'received'}` : 'Payment Update';
              const message = studentId ? `Student ${studentId} made a payment of ${amount || 'N/A'} (${status || 'unknown'})` : `Payment: ${amount || 'N/A'} (${status || 'unknown'})`;

              addNotification({ title, message, type: 'payment', meta: record });
              // Optionally refresh stats
              updateStats();
            } catch (e) { console.warn('payment realtime handler error', e); }
          });

        paymentsChannel.subscribe();
        console.log('Subscribed to realtime updates for admission_payments');
      } catch (err) {
        console.error('Error setting up realtime subscription:', err);
        setRealtimeStatus('disconnected');
      }
    }

        // Realtime status UI helper
        function setRealtimeStatus(status) {
          const el = document.getElementById('realtimeStatus');
          const text = document.getElementById('realtimeStatusText');
          if (!el || !text) return;
          if (status === 'connected') {
            el.classList.remove('realtime-disconnected');
            el.classList.add('realtime-connected');
            text.textContent = 'Connected';
          } else {
            el.classList.remove('realtime-connected');
            el.classList.add('realtime-disconnected');
            text.textContent = 'Disconnected';
          }
        }

        // Update status on network changes
        window.addEventListener('offline', () => setRealtimeStatus('disconnected'));
        window.addEventListener('online', () => setRealtimeStatus('connected'));

    // Close modal on outside click for any modal
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });

    // Close any open modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
      }
    });

    // Helper to show an informational modal
    function showMessageModal(title, message) {
      const modalId = 'infoModal';
      const titleEl = document.querySelector('#' + modalId + ' .modal-title');
      const bodyEl = document.getElementById('infoModalBody');
      if (titleEl) titleEl.textContent = title || 'Message';
      if (bodyEl) bodyEl.textContent = message || '';
      openModal(modalId);
    }

    // Show HTML content inside the info modal (keeps ability to use rich HTML)
    function showInfoModal(htmlContent, title) {
      const modalId = 'infoModal';
      const titleEl = document.querySelector('#' + modalId + ' .modal-title');
      const bodyEl = document.getElementById('infoModalBody');
      if (titleEl) titleEl.textContent = title || 'Message';
      if (bodyEl) bodyEl.innerHTML = htmlContent || '';
      openModal(modalId);
    }

    // Horizontal scroll helpers for applicant modal
    function scrollApplicantModalDir(dir) {
      const modal = document.getElementById('applicantModal');
      if (!modal) return;
      const body = modal.querySelector('.modal-body');
      if (!body) return;
      const amount = Math.round(body.clientWidth * 0.6);
      const left = dir === 'left' ? -amount : amount;
      body.scrollBy({ left, behavior: 'smooth' });
      setTimeout(updateApplicantScrollControls, 250);
    }

    function updateApplicantScrollControls() {
      const modal = document.getElementById('applicantModal');
      if (!modal) return;
      const leftBtn = document.getElementById('applicantScrollLeft');
      const rightBtn = document.getElementById('applicantScrollRight');
      const body = modal.querySelector('.modal-body');
      if (!body || !leftBtn || !rightBtn) return;

      const canScroll = body.scrollWidth > body.clientWidth + 6;
      if (!canScroll) {
        leftBtn.style.display = 'none';
        rightBtn.style.display = 'none';
        return;
      }

      const atLeft = body.scrollLeft <= 6;
      const atRight = (body.scrollLeft + body.clientWidth) >= (body.scrollWidth - 6);

      leftBtn.style.display = atLeft ? 'none' : 'flex';
      rightBtn.style.display = atRight ? 'none' : 'flex';
    }

    // Show/Hide controls on modal open/close and on resize/scroll
    (function attachApplicantScrollObservers(){
      const modal = document.getElementById('applicantModal');
      if (!modal) return;

      // MutationObserver to detect active class changes
      const mo = new MutationObserver(() => {
        const isActive = modal.classList.contains('active');
        if (isActive) {
          // give layout a moment then update
          setTimeout(() => {
            updateApplicantScrollControls();
            const body = modal.querySelector('.modal-body');
            if (body) body.addEventListener('scroll', updateApplicantScrollControls);
          }, 120);
        } else {
          const leftBtn = document.getElementById('applicantScrollLeft');
          const rightBtn = document.getElementById('applicantScrollRight');
          if (leftBtn) leftBtn.style.display = 'none';
          if (rightBtn) rightBtn.style.display = 'none';
        }
      });
      mo.observe(modal, { attributes: true, attributeFilter: ['class'] });

      window.addEventListener('resize', updateApplicantScrollControls);
    })();

    // Modal scroll controls removed — no left/right scroll arrows

    // ========== COURSE REGISTRATIONS FUNCTIONS ==========
    let allRegistrations = [];
    let filteredRegistrations = [];
    let regPage = 1;
    const regPageSize = 20;

    async function loadRegistrations() {
      try {
        document.getElementById('registrationsLoading').style.display = 'flex';
        document.getElementById('registrationsTable').style.display = 'none';

        const { data, error } = await window.__sb
          .from('registrations')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allRegistrations = data || [];
        
        // Enrich registrations with student info from student_master_db table for missing fields
        for (let reg of allRegistrations) {
          if ((!reg.student_full_name || reg.student_full_name === 'null' || reg.student_full_name === '') && reg.student_id) {
            try {
              const { data: studentData } = await window.__sb
                .from('student_master_db')
                .select('first_name, middle_name, surname, department')
                .eq('student_id', reg.student_id)
                .single();
              
              if (studentData) {
                if (!reg.student_full_name || reg.student_full_name === 'null' || reg.student_full_name === '') {
                  reg.student_full_name = `${studentData.first_name || ''} ${studentData.middle_name || ''} ${studentData.surname || ''}`.trim();
                }
                if (!reg.student_department || reg.student_department === 'null' || reg.student_department === '') {
                  reg.student_department = studentData.department;
                }
              }
            } catch (e) {
              console.warn('Could not fetch student data for enrichment:', e);
            }
          }
        }
        
        filteredRegistrations = [...allRegistrations];
        
        updateRegistrationStats();
        renderRegistrationsTable();

        document.getElementById('registrationsLoading').style.display = 'none';
        document.getElementById('registrationsTable').style.display = 'table';
      } catch (error) {
        console.error('Error loading registrations:', error);
        showToast('Error loading registrations', 'error');
        document.getElementById('registrationsLoading').style.display = 'none';
      }
    }

    function updateRegistrationStats() {
      const total = allRegistrations.length;
      const unique = new Set(allRegistrations.map(r => r.student_id)).size;
      const pending = allRegistrations.filter(r => r.status === 'pending').length;
      const completed = allRegistrations.filter(r => r.status === 'completed').length;

      document.getElementById('totalRegistrations').textContent = total;
      document.getElementById('totalUniqueStudents').textContent = unique;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('completedCount').textContent = completed;
    }

    function renderRegistrationsTable() {
      const tbody = document.getElementById('registrationsTableBody');
      tbody.innerHTML = '';

      const start = (regPage - 1) * regPageSize;
      const end = start + regPageSize;
      const pageData = filteredRegistrations.slice(start, end);

      pageData.forEach(reg => {
        const row = document.createElement('tr');
        const numCourses = Array.isArray(reg.courses) ? reg.courses.length : 0;
        const numCore = Array.isArray(reg.core_courses) ? reg.core_courses.length : 0;
        const createdDate = new Date(reg.created_at).toLocaleDateString();
        
        // Reconstruct full name from parts if main field is empty
        let fullName = reg.student_full_name || '';
        if (!fullName || fullName === 'null' || fullName === '') {
          fullName = [reg.student_firstname, reg.student_othername, reg.student_lastname]
            .filter(n => n && n !== 'null')
            .join(' ')
            .trim();
        }
        
        // Use department from record or fallback
        let department = reg.student_department || '';
        if (!department || department === 'null') {
          department = reg.school || 'N/A';
        }

        row.innerHTML = `
          <td>${reg.id || 'N/A'}</td>
          <td><strong>${reg.student_id || 'N/A'}</strong></td>
          <td>${fullName || 'N/A'}</td>
          <td>${reg.student_email || 'N/A'}</td>
          <td>${reg.contact_phone || reg.student_phone || 'N/A'}</td>
          <td>${department || 'N/A'}</td>
          <td>${reg.student_level || 'N/A'}</td>
          <td>${reg.school || 'N/A'}</td>
          <td>
            <span style="padding: 4px 8px; background: ${reg.source_payload?.course_type === 'Diploma' ? '#e3f2fd' : '#f3e5f5'}; border-radius: 4px; font-size: 12px;">
              ${(reg.source_payload?.course_type || 'ICC') || 'N/A'}
            </span>
          </td>
          <td style="text-align: center;"><strong>${numCourses}</strong></td>
          <td style="text-align: center;"><strong>${numCore}</strong></td>
          <td>
            <span style="padding: 4px 8px; background: ${
              reg.status === 'completed' ? '#c8e6c9' : 
              reg.status === 'approved' ? '#b3e5fc' : 
              '#fff9c4'
            }; border-radius: 4px; font-size: 12px; text-transform: capitalize;">
              ${reg.status || 'N/A'}
            </span>
          </td>
          <td>${createdDate}</td>
          <td>
            <button class="action-btn view-btn" onclick="viewRegistrationDetails(${reg.id})" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      updateRegistrationsPagination();
    }

    function updateRegistrationsPagination() {
      const totalPages = Math.ceil(filteredRegistrations.length / regPageSize);
      const pageInfo = document.getElementById('registrationsPageInfo');
      const pagination = document.getElementById('registrationsPagination');

      if (filteredRegistrations.length === 0) {
        pagination.style.display = 'none';
        return;
      }

      pageInfo.textContent = `Page ${regPage} of ${totalPages}`;
      pagination.style.display = 'flex';
    }

    function changeRegistrationsPage(direction) {
      const totalPages = Math.ceil(filteredRegistrations.length / regPageSize);
      const newPage = regPage + direction;
      if (newPage >= 1 && newPage <= totalPages) {
        regPage = newPage;
        renderRegistrationsTable();
      }
    }

    function filterRegistrations() {
      const schoolFilter = document.getElementById('regSchoolFilter').value;
      const levelFilter = document.getElementById('regLevelFilter').value;
      const courseTypeFilter = document.getElementById('regCourseTypeFilter').value;
      const statusFilter = document.getElementById('regStatusFilter').value;

      filteredRegistrations = allRegistrations.filter(reg => {
        const schoolMatch = !schoolFilter || reg.school === schoolFilter;
        const levelMatch = !levelFilter || reg.student_level === levelFilter;
        const courseTypeMatch = !courseTypeFilter || (reg.student_othername === courseTypeFilter || reg.source_payload?.course_type === courseTypeFilter);
        const statusMatch = !statusFilter || reg.status === statusFilter;
        
        return schoolMatch && levelMatch && courseTypeMatch && statusMatch;
      });

      regPage = 1;
      renderRegistrationsTable();
    }

    function resetRegistrationFilters() {
      document.getElementById('regSchoolFilter').value = '';
      document.getElementById('regLevelFilter').value = '';
      document.getElementById('regCourseTypeFilter').value = '';
      document.getElementById('regStatusFilter').value = '';
      filteredRegistrations = [...allRegistrations];
      regPage = 1;
      renderRegistrationsTable();
    }

    function searchRegistration() {
      const searchTerm = document.getElementById('registrationSearchInput').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredRegistrations = [...allRegistrations];
      } else {
        filteredRegistrations = allRegistrations.filter(reg => 
          (reg.student_id && reg.student_id.toLowerCase().includes(searchTerm)) ||
          (reg.student_full_name && reg.student_full_name.toLowerCase().includes(searchTerm)) ||
          (reg.student_email && reg.student_email.toLowerCase().includes(searchTerm)) ||
          (reg.student_firstname && reg.student_firstname.toLowerCase().includes(searchTerm)) ||
          (reg.student_lastname && reg.student_lastname.toLowerCase().includes(searchTerm))
        );
      }

      regPage = 1;
      renderRegistrationsTable();
    }

    function clearRegistrationResults() {
      document.getElementById('registrationSearchInput').value = '';
      filteredRegistrations = [...allRegistrations];
      regPage = 1;
      renderRegistrationsTable();
    }

    function viewRegistrationDetails(regId) {
      const registration = allRegistrations.find(r => r.id === regId);
      if (!registration) {
        showToast('Registration not found', 'error');
        return;
      }

      // Reconstruct full name from parts if main field is empty
      let fullName = registration.student_full_name || '';
      if (!fullName || fullName === 'null' || fullName === '') {
        fullName = [registration.student_firstname, registration.student_othername, registration.student_lastname]
          .filter(n => n && n !== 'null')
          .join(' ')
          .trim();
      }
      
      // Use department from record or fallback
      let department = registration.student_department || '';
      if (!department || department === 'null') {
        department = registration.school || 'N/A';
      }

      const coursesHtml = Array.isArray(registration.courses) 
        ? registration.courses.map(c => `<li>${c}</li>`).join('')
        : '<li>None</li>';

      const coreCourseHtml = Array.isArray(registration.core_courses)
        ? registration.core_courses.map(c => `<li>${c}</li>`).join('')
        : '<li>None</li>';

      const detailsHtml = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <h4 style="color: #333; margin-bottom: 10px;">Student Information</h4>
            <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; font-size: 13px;">
              <p><strong>Student ID:</strong> ${registration.student_id || 'N/A'}</p>
              <p><strong>Full Name:</strong> ${fullName || 'N/A'}</p>
              <p><strong>Email:</strong> ${registration.student_email || 'N/A'}</p>
              <p><strong>Phone:</strong> ${registration.contact_phone || registration.student_phone || 'N/A'}</p>
              <p><strong>WhatsApp:</strong> ${registration.contact_whatsapp || registration.student_whatsapp || 'N/A'}</p>
            </div>
          </div>
          <div>
            <h4 style="color: #333; margin-bottom: 10px;">Academic Information</h4>
            <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; font-size: 13px;">
              <p><strong>Department:</strong> ${department || 'N/A'}</p>
              <p><strong>Level:</strong> ${registration.student_level || 'N/A'}</p>
              <p><strong>School:</strong> ${registration.school || 'N/A'}</p>
              <p><strong>Program:</strong> ${registration.program || 'N/A'}</p>
              <p><strong>Course Type:</strong> ${registration.source_payload?.course_type || 'N/A'}</p>
            </div>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <h4 style="color: #333; margin-bottom: 10px;">Selected Program Courses</h4>
          <ul style="background: #e8f5e9; padding: 12px 12px 12px 30px; border-radius: 6px; font-size: 13px; list-style: disc;">
            ${coursesHtml}
          </ul>
        </div>

        <div style="margin-top: 15px;">
          <h4 style="color: #333; margin-bottom: 10px;">Core Courses</h4>
          <ul style="background: #e3f2fd; padding: 12px 12px 12px 30px; border-radius: 6px; font-size: 13px; list-style: disc;">
            ${coreCourseHtml}
          </ul>
        </div>

        <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <h4 style="color: #333; margin-bottom: 8px;">Registration Status</h4>
            <p style="padding: 8px; background: ${
              registration.status === 'completed' ? '#c8e6c9' : 
              registration.status === 'approved' ? '#b3e5fc' : 
              '#fff9c4'
            }; border-radius: 4px; text-transform: capitalize;">
              <strong>${registration.status || 'pending'}</strong>
            </p>
          </div>
          <div>
            <h4 style="color: #333; margin-bottom: 8px;">Registered Date</h4>
            <p style="padding: 8px; background: #f5f5f5; border-radius: 4px;">
              ${new Date(registration.created_at).toLocaleString()}
            </p>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <h4 style="color: #333; margin-bottom: 10px;">Notes</h4>
          <p style="background: #f5f5f5; padding: 12px; border-radius: 6px; font-size: 13px;">
            ${registration.notes || 'No notes'}
          </p>
        </div>
      `;

      showInfoModal(detailsHtml, `Registration #${regId} - ${registration.student_full_name}`);
    }

    function exportRegistrationData(format) {
      if (filteredRegistrations.length === 0) {
        showToast('No registrations to export', 'warning');
        return;
      }

      const data = filteredRegistrations.map(reg => ({
        'Registration ID': reg.id,
        'Student ID': reg.student_id,
        'Full Name': reg.student_full_name,
        'Email': reg.student_email,
        'Phone': reg.contact_phone || reg.student_phone,
        'WhatsApp': reg.contact_whatsapp,
        'Department': reg.student_department,
        'Level': reg.student_level,
        'School': reg.school,
        'Program': reg.program,
        'Courses': Array.isArray(reg.courses) ? reg.courses.join('; ') : 'N/A',
        'Core Courses': Array.isArray(reg.core_courses) ? reg.core_courses.join('; ') : 'N/A',
        'Status': reg.status,
        'Registered Date': new Date(reg.created_at).toLocaleString()
      }));

      if (format === 'csv') {
        exportToCSV(data, 'course_registrations');
      } else if (format === 'excel') {
        exportToExcel(data, 'Course Registrations', 'registrations');
      }
    }

    // Auto-load registrations when modal opens
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
        if (modalId === 'registrationsModal') {
          setTimeout(() => loadRegistrations(), 100);
        }
      }
    }

  </script>
</body>
</html>